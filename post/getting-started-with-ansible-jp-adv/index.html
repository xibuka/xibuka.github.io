<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Ansible 入門 - 応用 - Wenhan Shi Blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="Wenhan Shi"><meta name=description content="こちらの記事はではAnsibleを紹介するための文章で、元Red Hat社員のJingjing Shiが作成し、Wenhan Shiが日本語に翻訳"><meta name=keywords content="Ubuntu,RHEL,Docker,Kubernetes,OpenShift,GlusterFS"><meta name=generator content="Hugo 0.62.2 with theme even"><link rel=canonical href=https://wenhan.blog/post/getting-started-with-ansible-jp-adv/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><link href=/dist/even.c2a46f00.min.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="Ansible 入門 - 応用"><meta property="og:description" content="こちらの記事はではAnsibleを紹介するための文章で、元Red Hat社員のJingjing Shiが作成し、Wenhan Shiが日本語に翻訳"><meta property="og:type" content="article"><meta property="og:url" content="https://wenhan.blog/post/getting-started-with-ansible-jp-adv/"><meta property="article:published_time" content="2018-04-09T15:20:32+00:00"><meta property="article:modified_time" content="2023-03-09T16:57:41+09:00"><meta itemprop=name content="Ansible 入門 - 応用"><meta itemprop=description content="こちらの記事はではAnsibleを紹介するための文章で、元Red Hat社員のJingjing Shiが作成し、Wenhan Shiが日本語に翻訳"><meta itemprop=datePublished content="2018-04-09T15:20:32+00:00"><meta itemprop=dateModified content="2023-03-09T16:57:41+09:00"><meta itemprop=wordCount content="13572"><meta itemprop=keywords content="Linux,Ansible,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Ansible 入門 - 応用"><meta name=twitter:description content="こちらの記事はではAnsibleを紹介するための文章で、元Red Hat社員のJingjing Shiが作成し、Wenhan Shiが日本語に翻訳"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>WenhanBlog</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>WenhanBlog</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li></ul></nav><div class=social-links><a href=mailto:shibunkan@gmail.com class="iconfont icon-email" title=email></a><a href=https://twitter.com/shi_wenhan class="iconfont icon-twitter" title=twitter></a><a href=https://www.linkedin.com/in/wenhan-shi-0883a9132/ class="iconfont icon-linkedin" title=linkedin></a><a href=https://github.com/xibuka class="iconfont icon-github" title=github></a><a href=https://www.zhihu.com/people/xibuka class="iconfont icon-zhihu" title=zhihu></a><a href=https://wenhan.blog/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Ansible 入門 - 応用</h1><div class=post-meta><span class=post-time>2018-04-09</span>
<span class=more-meta>13572 words</span>
<span class=more-meta>28 mins read</span>
<span id=busuanzi_container_page_pv class=more-meta><span id=busuanzi_value_page_pv><img src=/img/spinner.svg alt=spinner.svg></span> times read</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#設定内容>設定内容</a></li><li><a href=#優先順位>優先順位</a></li></ul><ul><li><a href=#ファイルパス>ファイルパス</a><ul><li><a href=#デフォルトのファイルパス>デフォルトのファイルパス</a></li><li><a href=#ファイルパスの変更>ファイルパスの変更</a></li><li><a href=#コマンドライン上で指定>コマンドライン上で指定</a></li></ul></li><li><a href=#サーバーのカテゴリ化>サーバーのカテゴリ化</a></li><li><a href=#接続パラメータと変数>接続パラメータと変数</a><ul><li><a href=#パラメータ>パラメータ</a></li><li><a href=#変数>変数</a></li></ul></li><li><a href=#ディレクトリ構造での変数保存>ディレクトリ構造での変数保存</a></li></ul><ul><li><a href=#フォーマット>フォーマット</a><ul><li><a href=#オフィシャルの例>オフィシャルの例</a></li><li><a href=#他のユーザがシェアしたplaybook>他のユーザがシェアしたPlaybook</a></li></ul></li><li><a href=#playbookの基本>Playbookの基本</a><ul><li><a href=#playbookの実行>Playbookの実行</a></li><li><a href=#簡単なplaybookの例>簡単なPlaybookの例</a></li><li><a href=#実行するタスクtasks>実行するタスク(Tasks)</a></li><li><a href=#イベントハンドラhandler>イベントハンドラ(handler)</a></li></ul></li><li><a href=#playbookで利用可能な変数>Playbookで利用可能な変数</a><ul><li><a href=#playbook中で定義した変数>Playbook中で定義した変数</a></li><li><a href=#システム変数facts>システム変数(facts)</a></li><li><a href=#テンプレートで定義した変数>テンプレートで定義した変数</a></li><li><a href=#タスクの実行結果を変数に設定>タスクの実行結果を変数に設定</a></li><li><a href=#コマンドラインで変数を渡す>コマンドラインで変数を渡す</a></li></ul></li><li><a href=#条件判断ループとブロック>条件判断、ループとブロック</a><ul><li><a href=#条件判断when>条件判断(when)</a></li><li><a href=#循環処理loop>循環処理(loop)</a></li><li><a href=#ブロックblock>ブロック(block)</a></li></ul></li><li><a href=#既存playbook-の読み込む>既存Playbook の読み込む</a><ul><li><a href=#playbookファイルの-include>Playbookファイルの include</a></li><li><a href=#playbookのpackagerole>Playbookの"Package”(role)</a></li></ul></li><li><a href=#tagsで一部のtasksを実行>tagsで一部のtasksを実行</a><ul><li><a href=#tagsの基本の使い方>tagsの基本の使い方</a></li><li><a href=#特殊の意味を持つtags>特殊の意味を持つtags</a></li><li><a href=#includeとroleでtagsを利用>includeとroleでtagsを利用</a></li></ul></li></ul><ul><li><a href=#extra-moduleの使い方>Extra Moduleの使い方</a><ul><li><a href=#ansible-module-extraをダウンロード>Ansible module extraをダウンロード</a></li><li><a href=#extraモジュールが使えるように設定内容を修正>extraモジュールが使えるように設定内容を修正</a></li></ul></li><li><a href=#コマンドラインでモジュールの使い方を参照>コマンドラインでモジュールの使い方を参照</a></li><li><a href=#より良いplaybookの書き方>より良いPlaybookの書き方</a></li><li><a href=#参考資料>参考資料</a></li></ul></nav></div></div><div class=post-content><p>こちらの記事はではAnsibleを紹介するための文章で、元Red Hat社員のJingjing Shiが作成し、Wenhan Shiが日本語に翻訳しました。内容の校正はHideki SaitoとKento Yagisawaが協力しています。Ansibleの基礎知識から、実際の現場で利用できる実運用まで紹介しています。</p><p>本文内にあるすべてのansible playbookの例は、以下のgithubのURLから利用できる。
<a href=https://github.com/ansible-book/ansible-first-book-examples>https://github.com/ansible-book/ansible-first-book-examples</a>
もし不備やコメントがありましたら、作者<a href=mailto:shijingjing02@163.com>shijingjing02@163.com</a>または翻訳者<a href=mailto:shibunkan@gmail.com>shibunkan@gmail.com</a> に連絡してください。</p><p>詳細の内容を下記三つに分けて説明します。</p><p><a href=http://wenhan.blog/2018/04/09/Getting-started-with-Ansible-JP-intro/>Ansible 入門 - 紹介</a>
<a href=http://wenhan.blog/2018/04/09/Getting-started-with-Ansible-JP-basic/>Ansible 入門 - 基本</a>
<a href=http://wenhan.blog/2018/04/09/Getting-started-with-Ansible-JP-adv/>Ansible 入門 - 応用</a></p><p>本章では、もっと自由に運用するために、Ansibleの高度な使い方を説明する。</p><ol><li>Ansibleの設定ファイル</li><li>サーバーリスト管理（Host Inventory）</li><li>Playbookの上級な書き方</li><li>Extraモジュールの利用</li></ol><h1 id=ansible設定ファイル>Ansible設定ファイル</h1><h2 id=設定内容>設定内容</h2><ul><li>基本の設定内容</li></ul><table><thead><tr><th>項目</th><th>詳細</th><th>内容（デフォルト）</th></tr></thead><tbody><tr><td>inventory</td><td>リモートノードリスト管理ファイル</td><td>/etc/ansible/hosts</td></tr><tr><td>library</td><td>拡張モジュールフォルダ</td><td>/usr/share/my_modules/</td></tr><tr><td>remote_tmp</td><td>リモートノード上のファイル一時保存場所</td><td>$HOME/.ansible/tmp</td></tr><tr><td>local_tmp</td><td>管理者ノード上のファイル一時保存場所</td><td>$HOME/.ansible/tmp</td></tr></tbody></table><ul><li>高度の設定内容</li></ul><table><thead><tr><th>項目</th><th>詳細</th><th>内容（デフォルト）</th></tr></thead><tbody><tr><td>accelerate_port</td><td>接続ポート番号</td><td>5099</td></tr><tr><td>accelerate_timeout</td><td>タイムアウト</td><td>30</td></tr><tr><td>accelerate_connect_timeout</td><td>接続タイムアウト</td><td>5</td></tr></tbody></table><p>上記は設定できる内容の一部しかすぎない。以下のAnsible設定ファイルの全体を通して、どんなことができるのはは理解できる</p><p><a href=https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg>https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg</a></p><p>設定ファイル内のキーワードについて不明な点があった場合、下記のURLから詳細を参照できる。</p><p><a href=http://docs.ansible.com/ansible/intro_configuration.html#explanation-of-values-by-section>http://docs.ansible.com/ansible/intro_configuration.html#explanation-of-values-by-section</a></p><h2 id=優先順位>優先順位</h2><p>設定ファイルのデフォルトのパスは/etc/ansible/ansible.cfg。Ansibleは以下の順番で設定ファイルを検索し、<strong>最初に</strong>見つけたファイルの設定内容を読み込む。</p><ol><li>ANSIBLE_CONFIG (an environment variable)</li><li>ansible.cfg (in the current directory)</li><li>.ansible.cfg (in the home directory)</li><li>/etc/ansible/ansible.cfg</li></ol><p>Ansible 1.5以前の順番は</p><ol><li>ansible.cfg (in the current directory)</li><li>ANSIBLE_CONFIG (an environment variable)</li><li>.ansible.cfg (in the home directory)</li><li>/etc/ansible/ansible.cfg</li></ol><h1 id=host-inventoryサーバーリスト>Host Inventory(サーバーリスト)</h1><p>サーバーリストとは、管理対象のリモートノード情報と、カテゴリやグループなどの情報をAnsibleに教えるためのファイルである。カテゴリは自分のニーズ、ロケーション、役割などによって分類できる。</p><h2 id=ファイルパス>ファイルパス</h2><h3 id=デフォルトのファイルパス>デフォルトのファイルパス</h3><p><code>/etc/ansible/hosts</code></p><h3 id=ファイルパスの変更>ファイルパスの変更</h3><p><code>/etc/ansible/ansible.cfg</code> の以下の部分を変更</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>...<span class=w>
</span><span class=w></span>inventory<span class=w>      </span>=<span class=w> </span>/etc/ansible/hosts<span class=w>
</span><span class=w></span>...<span class=w>
</span></code></pre></td></tr></table></div></div><h3 id=コマンドライン上で指定>コマンドライン上で指定</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-playbook -i hosts site.yml
</code></pre></td></tr></table></div></div><p>或者参数–inventory-file</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-playbook --inventory-file hosts site.yml
</code></pre></td></tr></table></div></div><h2 id=サーバーのカテゴリ化>サーバーのカテゴリ化</h2><p><code>[]</code>内でグループ名を書く</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>mail.example.com<span class=w>
</span><span class=w>
</span><span class=w></span><span class=p>[</span>webservers<span class=p>]</span><span class=w>
</span><span class=w></span>foo.example.com<span class=w>
</span><span class=w></span>bar.example.com<span class=w>
</span><span class=w>
</span><span class=w></span><span class=p>[</span>dbservers<span class=p>]</span><span class=w>
</span><span class=w></span>one.example.com<span class=w>
</span><span class=w></span>two.example.com<span class=w>
</span><span class=w></span>three.example.com<span class=w>
</span><span class=w>
</span><span class=w></span><span class=p>[</span>webservers<span class=p>]</span><span class=w>
</span><span class=w></span>www<span class=p>[</span><span class=m>01</span><span class=p>:</span><span class=m>50</span><span class=p>]</span>.example.com<span class=w>
</span><span class=w>
</span><span class=w></span><span class=p>[</span>databases<span class=p>]</span><span class=w>
</span><span class=w></span>db-<span class=p>[</span>a<span class=p>:</span>f<span class=p>]</span>.example.com<span class=w>
</span></code></pre></td></tr></table></div></div><p>グループは子グループを持つこともできる。以下の例では、southeaseグループは[usa:children]の子グループであり、atlantaとreleighは[southease:children]の子グループである。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML><span class=p>[</span>atlanta<span class=p>]</span><span class=w>
</span><span class=w></span>host1<span class=w>
</span><span class=w></span>host2<span class=w>
</span><span class=w>
</span><span class=w></span><span class=p>[</span>raleigh<span class=p>]</span><span class=w>
</span><span class=w></span>host2<span class=w>
</span><span class=w></span>host3<span class=w>
</span><span class=w>
</span><span class=w></span><span class=p>[</span>southeast<span class=p>:</span>children<span class=p>]</span><span class=w>
</span><span class=w></span>atlanta<span class=w>
</span><span class=w></span>raleigh<span class=w>
</span><span class=w>
</span><span class=w></span><span class=p>[</span>usa<span class=p>:</span>children<span class=p>]</span><span class=w>
</span><span class=w></span>southeast<span class=w>
</span><span class=w></span>northeast<span class=w>
</span><span class=w></span>southwest<span class=w>
</span><span class=w></span>northwest<span class=w>
</span></code></pre></td></tr></table></div></div><h2 id=接続パラメータと変数>接続パラメータと変数</h2><h3 id=パラメータ>パラメータ</h3><p>リモートノードに接続する方法とユーザを、パラメータに設定できる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML><span class=p>[</span>targets<span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w></span>localhost<span class=w>              </span>ansible_connection=local<span class=w>
</span><span class=w></span>other1.example.com<span class=w>     </span>ansible_connection=ssh<span class=w>        </span>ansible_user=mpdehaan<span class=w>
</span><span class=w></span>other2.example.com<span class=w>     </span>ansible_connection=ssh<span class=w>        </span>ansible_user=mdehaan<span class=w>
</span><span class=w>
</span><span class=w></span><span class=p>[</span>atlanta<span class=p>]</span><span class=w>
</span><span class=w></span>host1<span class=w> </span>http_port=<span class=m>80</span><span class=w> </span>maxRequestsPerChild=<span class=m>808</span><span class=w>
</span><span class=w></span>host2<span class=w> </span>http_port=<span class=m>303</span><span class=w> </span>maxRequestsPerChild=<span class=m>909</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>指定可能なパラメータの一覧は以下を参照する。
<a href=http://docs.ansible.com/ansible/intro_inventory.html#list-of-behavioral-inventory-parameters>http://docs.ansible.com/ansible/intro_inventory.html#list-of-behavioral-inventory-parameters</a></p><h3 id=変数>変数</h3><p>グループに対して変数を設定することができる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML><span class=p>[</span>atlanta<span class=p>]</span><span class=w>
</span><span class=w></span>host1<span class=w>
</span><span class=w></span>host2<span class=w>
</span><span class=w>
</span><span class=w></span><span class=p>[</span>atlanta<span class=p>:</span>vars<span class=p>]</span><span class=w>
</span><span class=w></span>ntp_server=ntp.atlanta.example.com<span class=w>
</span><span class=w></span>proxy=proxy.atlanta.example.com<span class=w>
</span></code></pre></td></tr></table></div></div><h2 id=ディレクトリ構造での変数保存>ディレクトリ構造での変数保存</h2><p>例えば、inventoryファイルは<code>/etc/ansible/hosts</code>の場合、関連するhostsとgroup変数は以下のディレクトリに保存できる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>/etc/ansible/group_vars/raleigh <span class=c1># can optionally end in &#39;.yml&#39;, &#39;.yaml&#39;, or &#39;.json&#39;</span>
/etc/ansible/group_vars/webservers
/etc/ansible/host_vars/foosball
</code></pre></td></tr></table></div></div><p><code>/etc/ansible/group_vars/raleigh</code> ファイルの内容は</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>---<span class=w>
</span><span class=w></span>ntp_server<span class=p>:</span><span class=w> </span>acme.example.org<span class=w>
</span><span class=w></span>database_server<span class=p>:</span><span class=w> </span>storage.example.org<span class=w>
</span></code></pre></td></tr></table></div></div><p>もし対応する名前はディレクトリ名の場合、Ansibleはこのディレクトリ以下のすべてのファイルの内容を読み込む。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>/etc/ansible/group_vars/raleigh/db_settings
/etc/ansible/group_vars/raleigh/cluster_settings
</code></pre></td></tr></table></div></div><p><code>group_vars/</code>と<code>host_vars/</code> は<code>inventory/</code>以下または<code>playbook/</code>以下に置くことができる。もし両方(<code>inventory/</code>または<code>playbook/</code>)の下にファイルがある場合、playbook以下の配置はinventoryより<strong>優先的に</strong>読み込まれる。</p><h1 id=ansibleのスクリプトplaybook>Ansibleのスクリプト(Playbook)</h1><h2 id=フォーマット>フォーマット</h2><p>AnsibleのスクリプトはYAML形式を利用している。Playbookを書く前に既存のPlaybookを参考したほうが効率良く作成することができる効率。</p><h3 id=オフィシャルの例>オフィシャルの例</h3><p>Ansibleの公式Githubリポジトリに存在するテスト済みのPlaybookをシェアしている。</p><p><a href=https://github.com/ansible/ansible-examples>https://github.com/ansible/ansible-examples</a></p><h3 id=他のユーザがシェアしたplaybook>他のユーザがシェアしたPlaybook</h3><p>「Ansible Galaxy」というPlaybookをシェアするためのサイトがある。このサイトにある例はユーザが自分でアップロードしたもので、Playbookの勉強や参考にするとは良いが、実際に利用する前には必ずテストが必要である。</p><p><a href=https://galaxy.ansible.com/>https://galaxy.ansible.com/</a></p><h2 id=playbookの基本>Playbookの基本</h2><p>本節ではPlaybookを書くための基本を説明する。</p><h3 id=playbookの実行>Playbookの実行</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-playbook deploy.yml
</code></pre></td></tr></table></div></div><p>詳細な実行ログを出力</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-playbook playbook.yml  --verbose
</code></pre></td></tr></table></div></div><p>影響するリモートノードの一覧</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-playbook playbook.yml --list-hosts
</code></pre></td></tr></table></div></div><p>スクリプトを並行に実行する</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-playbook playbook.yml -f <span class=m>10</span>
</code></pre></td></tr></table></div></div><h3 id=簡単なplaybookの例>簡単なPlaybookの例</h3><p>基本のplaybookのスクリプトの例では、以下三つの部分がある。</p><ol><li>どのサーバー上にどのユーザで実行<ol><li>hosts</li><li>users</li></ol></li><li>実行するタスク<ol><li>tasks</li></ol></li><li>イベントハンドル<ol><li>handles</li></ol></li></ol><p><code>deploy.yml</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>---<span class=w>
</span><span class=w></span>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>webservers<span class=w>
</span><span class=w>  </span>vars<span class=p>:</span><span class=w>
</span><span class=w>    </span>http_port<span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>    </span>max_clients<span class=p>:</span><span class=w> </span><span class=m>200</span><span class=w>
</span><span class=w>  </span>user<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>  </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>ensure<span class=w> </span>apache<span class=w> </span>is<span class=w> </span>at<span class=w> </span>the<span class=w> </span>latest<span class=w> </span>version<span class=w>
</span><span class=w>    </span>yum<span class=p>:</span><span class=w> </span>pkg=httpd<span class=w> </span>state=latest<span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>write<span class=w> </span>the<span class=w> </span>apache<span class=w> </span>config<span class=w> </span>file<span class=w>
</span><span class=w>    </span>template<span class=p>:</span><span class=w> </span>src=/srv/httpd.j2<span class=w> </span>dest=/etc/httpd.conf<span class=w>
</span><span class=w>    </span>notify<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>restart<span class=w> </span>apache<span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>ensure<span class=w> </span>apache<span class=w> </span>is<span class=w> </span>running<span class=w>
</span><span class=w>    </span>service<span class=p>:</span><span class=w> </span>name=httpd<span class=w> </span>state=started<span class=w>
</span><span class=w>  </span>handlers<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>restart<span class=w> </span>apache<span class=w>
</span><span class=w>      </span>service<span class=p>:</span><span class=w> </span>name=httpd<span class=w> </span>state=restarted<span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=対象サーバと実行ユーザhostsとuser>対象サーバと実行ユーザ（hostsとuser）</h4><table><thead><tr><th>key</th><th>意味</th></tr></thead><tbody><tr><td>hosts</td><td>リモートサーバーのIPアドレス、ホスト名、グループ名。またはallキーワードですべてのリモートノードを指定</td></tr><tr><td>user</td><td>リモートサーバー上で実行するユーザ名</td></tr><tr><td>become</td><td>他のユーザに切り替えて実行する、値は yes または no</td></tr><tr><td>become_method</td><td>becomeと一緒に利用、‘sudo’ / ’su’ / ’pbrun’ / ’pfexec’ / ’doas’などを指定</td></tr><tr><td>become_user</td><td>becomeと一緒に利用、rootまたは他のユーザ名</td></tr></tbody></table><p>スクリプト上でbecomeを利用する時、&ndash;ask-become-passを追加することで、playbook実行後にsudoパスワードを入力することが要求される。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-playbook deploy.yml --ask-become-pass
</code></pre></td></tr></table></div></div><h3 id=実行するタスクtasks>実行するタスク(Tasks)</h3><ul><li>タスクはPlaybookの上から下まで実行する。途中でエラーが発生した場合、Playbookの実行が中止される。スクリプトファイルを修正した後、再度スクリプトを実行する。</li><li>各taskはモジュールの読み出しであり、パラメータと変数を適切に設定する。</li><li>各taskはname 属性を持ったほうが、人間にとって理解しやすくなる。name属性は内容を出力するだけで、実行の進捗をユーザに提示することができる。</li></ul><h4 id=構文>構文</h4><p>Tasksの基本構文を以下に示す。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>make<span class=w> </span>sure<span class=w> </span>apache<span class=w> </span>is<span class=w> </span>running<span class=w>
</span><span class=w>    </span>service<span class=p>:</span><span class=w> </span>name=httpd<span class=w> </span>state=running<span class=w>
</span></code></pre></td></tr></table></div></div><p>name変数は必須ではないので、上記の例を下記のように記載することもできる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>service<span class=p>:</span><span class=w> </span>name=httpd<span class=w> </span>state=running<span class=w>
</span></code></pre></td></tr></table></div></div><p>name変数が書かれた場合、Playbookがこのタスクを実行する時に、name変数の内容が出力されスクリプトの進捗が分かりやすくなる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>TASK: <span class=o>[</span>make sure apache is running<span class=o>]</span> *************************************************************
changed: <span class=o>[</span>yourhost<span class=o>]</span>
</code></pre></td></tr></table></div></div><p>Name変数が書かれていない場合、taskのモジュール実行の構文がそのまま出力される。複数のモジュールが使われている場合、スクリプトの進捗が分からなくなる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>TASK: <span class=o>[</span>service <span class=nv>name</span><span class=o>=</span>httpd <span class=nv>state</span><span class=o>=</span>running<span class=o>]</span> **************************************
changed: <span class=o>[</span>yourhost<span class=o>]</span>
</code></pre></td></tr></table></div></div><h4 id=変数の渡し方>変数の渡し方</h4><p>上記の構文の例では、モジュールに変数を渡す方法を示している：<code>key=value</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>make<span class=w> </span>sure<span class=w> </span>apache<span class=w> </span>is<span class=w> </span>running<span class=w>
</span><span class=w>    </span>service<span class=p>:</span><span class=w> </span>name=httpd<span class=w> </span>state=running<span class=w>
</span></code></pre></td></tr></table></div></div><p>変数が多い場合、改行して複数行に書くこともできる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Copy<span class=w> </span>ansible<span class=w> </span>inventory<span class=w> </span>file<span class=w> </span>to<span class=w> </span>client<span class=w>
</span><span class=w>    </span>copy<span class=p>:</span><span class=w> </span>src=/etc/ansible/hosts<span class=w> </span>dest=/etc/ansible/hosts<span class=w>
</span><span class=w>            </span>owner=root<span class=w> </span>group=root<span class=w> </span>mode=<span class=m>0644</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>またはYAMLのハッシュ形式でパラメータを入力する。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Copy<span class=w> </span>ansible<span class=w> </span>inventory<span class=w> </span>file<span class=w> </span>to<span class=w> </span>client<span class=w>
</span><span class=w>    </span>copy<span class=p>:</span><span class=w>
</span><span class=w>      </span>src<span class=p>:</span><span class=w> </span>/etc/ansible/hosts<span class=w>
</span><span class=w>      </span>dest<span class=p>:</span><span class=w> </span>/etc/ansible/hosts<span class=w>
</span><span class=w>      </span>owner<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>      </span>group<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>      </span>mode<span class=p>:</span><span class=w> </span><span class=m>0644</span><span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=実行状態>実行状態</h4><p>タスク内の各actionは一つのモジュールを実行し、最初にリモートノードの状態を確認し、実行が必要かどうかを判断する。</p><ul><li>モジュールが実行された場合、モジュールからactionへの戻り値は changed になる。</li><li>実行が必要ないと判断した時、モジュールからactionへの戻り値は OK になる。</li></ul><p>実行必要性の判断は各モジュール内で決めている。例えば、copy モジュールの判断方式は、ファイルのchecksum値を比較する。copyモジュールのコードを以下に示す。</p><p><a href=https://github.com/ansible/ansible-modules-core/blob/devel/files/copy.py>https://github.com/ansible/ansible-modules-core/blob/devel/files/copy.py</a></p><p>以下のように、copyモジュールを例にする</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML><span class=w> </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Copy<span class=w> </span>the<span class=w> </span>/etc/hosts<span class=w>
</span><span class=w>    </span>copy<span class=p>:</span><span class=w> </span>src=/etc/hosts<span class=w> </span>dest=/etc/hosts<span class=w>
</span></code></pre></td></tr></table></div></div><p>最初に実行する時に、TASKの状態がchangedになっている。</p><p><img src=/img/ansible/ansible_3.png alt=servers></p><p>2回目実行すると、コピー元とコピー先のファイルが同じのめ、コピー作業が必要ないと判断し実行されていない。TASKの状態がOKになっている。</p><p><img src=/img/ansible/ansible_4.png alt=servers></p><p>リモートノードvm-rhel7-1上の/etc/hostsファイルを変更した後、もう一度実行すると、vm-rhel7-1のみファイルがコピーされ、TASKの状態がchangedになる。</p><p><img src=/img/ansible/ansible_5.png alt=servers></p><h3 id=イベントハンドラhandler>イベントハンドラ(handler)</h3><h4 id=定義>定義</h4><p>一般的なプログラミング言語にevent処理があるように、handleとはplaybookスクリプトでのevent処理である。</p><p>tasksと似ていて、Handlers内の各handlerはモジュールを一回実行している。ただ、tasksと異なっている部分は、tasksは書かれた順によって実行されるが、handlersはtasks内に呼び出す(notify)時のみ実行される。</p><p>また、tasksが実行された後、changedまたはOKの状態になっていて、handlerはtasks実行後状態がchangedの時のみ実行される。</p><h4 id=役割>役割</h4><p>もしtasksの中にapachの設定ファイルを変更した後、apacheを再起動する必要がある。そのほかにapache のプラグインをインストールした後にも、apacheを再起動する必要がある。この場合、「apacheを再起動する」ことは、handlerとして実行することができる。</p><p>handlerは全てのタスクが実行した後に実行する。複数のtasksに呼び出されても、handlerは一回のみ実行する。以下の例では、handlerは一回のみ実行される。
<a href=https://github.com/ansible-book/ansible-first-book-examples/blob/master/handlers_state.yml>https://github.com/ansible-book/ansible-first-book-examples/blob/master/handlers_state.yml</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>---<span class=w>
</span><span class=w></span>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>lb<span class=w>
</span><span class=w>  </span>remote_user<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>  </span>vars<span class=p>:</span><span class=w>
</span><span class=w>      </span>random_number1<span class=p>:</span><span class=w> </span><span class=s2>&#34;\{\{ 10000 | random \}\}&#34;</span><span class=w>
</span><span class=w>      </span>random_number2<span class=p>:</span><span class=w> </span><span class=s2>&#34;\{\{ 10000000000 | random \}\}&#34;</span><span class=w>
</span><span class=w>  </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Copy<span class=w> </span>the<span class=w> </span>/etc/hosts<span class=w> </span>to<span class=w> </span>/tmp/hosts.\{\{<span class=w> </span>random_number1<span class=w> </span>\}\}<span class=w>
</span><span class=w>    </span>copy<span class=p>:</span><span class=w> </span>src=/etc/hosts<span class=w> </span>dest=/tmp/hosts.\{\{<span class=w> </span>random_number1<span class=w> </span>\}\}<span class=w>
</span><span class=w>    </span>notify<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>call<span class=w> </span>in<span class=w> </span>every<span class=w> </span>action<span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Copy<span class=w> </span>the<span class=w> </span>/etc/hosts<span class=w> </span>to<span class=w> </span>/tmp/hosts.\{\{<span class=w> </span>random_number2<span class=w> </span>\}\}<span class=w>
</span><span class=w>    </span>copy<span class=p>:</span><span class=w> </span>src=/etc/hosts<span class=w> </span>dest=/tmp/hosts.\{\{<span class=w> </span>random_number2<span class=w> </span>\}\}<span class=w>
</span><span class=w>    </span>notify<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>call<span class=w> </span>in<span class=w> </span>every<span class=w> </span>action<span class=w>
</span><span class=w>
</span><span class=w>  </span>handlers<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>call<span class=w> </span>in<span class=w> </span>every<span class=w> </span>action<span class=w>
</span><span class=w>    </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;call in every action, but execute only one time&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>tasksのactionの実行状態がchangedの場合のみ、handlerが呼び出されて(notify)実行される。下記のスクリプトが2回実行された時、実行結果が異る。</p><ul><li>1回目実行の時、tasksの状態が両方changedのため、二つのhandlerが実行される。</li><li>2回目実行の時、<ul><li>1つ目のtaskの状態がOKのため、&ldquo;call by /tmp/hosts”handlerが実行されない。</li><li>2つ目のtaskの状態がchangedのため、&ldquo;call by /tmp/hosts.random_number” handlerが実行される</li></ul></li></ul><p>テストのコードを以下を参照する。
<a href=https://github.com/shijingjing1221/ansible-first-book-examples/blob/master/handlers_execution_time.yml>https://github.com/shijingjing1221/ansible-first-book-examples/blob/master/handlers_execution_time.yml</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>---<span class=w>
</span><span class=w></span>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>lb<span class=w>
</span><span class=w>  </span>remote_user<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>  </span>vars<span class=p>:</span><span class=w>
</span><span class=w>      </span>random_number<span class=p>:</span><span class=w> </span><span class=s2>&#34;\{\{ 10000 | random \}\}&#34;</span><span class=w>
</span><span class=w>  </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Copy<span class=w> </span>the<span class=w> </span>/etc/hosts<span class=w> </span>to<span class=w> </span>/tmp/hosts<span class=w>
</span><span class=w>    </span>copy<span class=p>:</span><span class=w> </span>src=/etc/hosts<span class=w> </span>dest=/tmp/hosts<span class=w>
</span><span class=w>    </span>notify<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>call<span class=w> </span>by<span class=w> </span>/tmp/hosts<span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Copy<span class=w> </span>the<span class=w> </span>/etc/hosts<span class=w> </span>to<span class=w> </span>/tmp/hosts.\{\{<span class=w> </span>random_number<span class=w> </span>\}\}<span class=w>
</span><span class=w>    </span>copy<span class=p>:</span><span class=w> </span>src=/etc/hosts<span class=w> </span>dest=/tmp/hosts.\{\{<span class=w> </span>random_number<span class=w> </span>\}\}<span class=w>
</span><span class=w>    </span>notify<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>call<span class=w> </span>by<span class=w> </span>/tmp/hosts.random_number<span class=w>
</span><span class=w>
</span><span class=w>  </span>handlers<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>call<span class=w> </span>by<span class=w> </span>/tmp/hosts<span class=w>
</span><span class=w>    </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;call first time&#34;</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>call<span class=w> </span>by<span class=w> </span>/tmp/hosts.random_number<span class=w>
</span><span class=w>    </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;call by /tmp/hosts.random_number&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>handlersはnotifyされる順番ではなく、定義された順番で実行される。下記の例では、定義の順番が1>2>3であり、notifyの順番が3>2>1であっても、実際の実行順番が1>2>3になる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>---<span class=w>
</span><span class=w></span>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>lb<span class=w>
</span><span class=w>  </span>remote_user<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>  </span>gather_facts<span class=p>:</span><span class=w> </span>no<span class=w>
</span><span class=w>  </span>vars<span class=p>:</span><span class=w>
</span><span class=w>      </span>random_number1<span class=p>:</span><span class=w> </span><span class=s2>&#34;\{\{ 10000 | random \}\}&#34;</span><span class=w>
</span><span class=w>      </span>random_number2<span class=p>:</span><span class=w> </span><span class=s2>&#34;\{\{ 10000000000 | random \}\}&#34;</span><span class=w>
</span><span class=w>  </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Copy<span class=w> </span>the<span class=w> </span>/etc/hosts<span class=w> </span>to<span class=w> </span>/tmp/hosts.\{\{<span class=w> </span>random_number1<span class=w> </span>\}\}<span class=w>
</span><span class=w>    </span>copy<span class=p>:</span><span class=w> </span>src=/etc/hosts<span class=w> </span>dest=/tmp/hosts.\{\{<span class=w> </span>random_number1<span class=w> </span>\}\}<span class=w>
</span><span class=w>    </span>notify<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>define<span class=w> </span>the<span class=w> </span>3nd<span class=w> </span>handler<span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Copy<span class=w> </span>the<span class=w> </span>/etc/hosts<span class=w> </span>to<span class=w> </span>/tmp/hosts.\{\{<span class=w> </span>random_number2<span class=w> </span>\}\}<span class=w>
</span><span class=w>    </span>copy<span class=p>:</span><span class=w> </span>src=/etc/hosts<span class=w> </span>dest=/tmp/hosts.\{\{<span class=w> </span>random_number2<span class=w> </span>\}\}<span class=w>
</span><span class=w>    </span>notify<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>define<span class=w> </span>the<span class=w> </span>2nd<span class=w> </span>handler<span class=w>
</span><span class=w>      </span>-<span class=w> </span>define<span class=w> </span>the<span class=w> </span>1nd<span class=w> </span>handler<span class=w>
</span><span class=w>
</span><span class=w>  </span>handlers<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>define<span class=w> </span>the<span class=w> </span>1nd<span class=w> </span>handler<span class=w>
</span><span class=w>    </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;define the 1nd handler&#34;</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>define<span class=w> </span>the<span class=w> </span>2nd<span class=w> </span>handler<span class=w>
</span><span class=w>    </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;define the 2nd handler&#34;</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>define<span class=w> </span>the<span class=w> </span>3nd<span class=w> </span>handler<span class=w>
</span><span class=w>    </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;define the 3nd handler&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><h2 id=playbookで利用可能な変数>Playbookで利用可能な変数</h2><p>本節では、よく使う幾つかの変数を紹介する。次の章からは、複雑な場面での変数の使い方などを紹介する。</p><p>一般的に、Playbookで利用できる変数は以下になる。</p><ol><li>Playbook中ユーザが定義する変数</li><li>ユーザが定義する必要がなく, AnsibleがPlaybookを実行する前に収集したリモートノードのシステム情報として使える変数</li><li>テンプレートでは上記 2つ種類の変数が直接利用できる。</li><li>taskの実行結果を変数として使える。この変数は&lt;register変数>となる</li><li>Playbookをもっと汎用性高く、動的に使いやすくするために、ユーザが実行中に変数を入力することができる。この変数は&lt;extra変数>となる</li></ol><h3 id=playbook中で定義した変数>Playbook中で定義した変数</h3><p>ユーザはPlaybook中に、varsキーワードで変数を定義することができる。使用する時は<code>\{\{\}\}</code>で囲んで利用する。下記の例では、ユーザがhttp_port変数を定義し、80と設定している。tasks firewalldの中で、<code>\{\{ http_port \}\}</code>で内容を読み込んでいる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>---<span class=w>
</span><span class=w></span>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>web<span class=w>
</span><span class=w>  </span>vars<span class=p>:</span><span class=w>
</span><span class=w>    </span>http_port<span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>  </span>remote_user<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>  </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>insert<span class=w> </span>firewalld<span class=w> </span>rule<span class=w> </span>for<span class=w> </span>httpd<span class=w>
</span><span class=w>    </span>firewalld<span class=p>:</span><span class=w> </span>port=\{\{<span class=w> </span>http_port<span class=w> </span>\}\}/tcp<span class=w> </span>permanent=<span class=kc>true</span><span class=w> </span>state=enabled<span class=w> </span>immediate=yes<span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=変数を単独ファイルに置く>変数を単独ファイルに置く</h4><p>変数が多い時、または複数のPlaybook中に共用されたい時に、変数を単独の変数ファイルに置くことができる。var_filesパラメータに該当する変数ファイル名を設定すると、同じ使い方で変数を参照できる。</p><p><code>Playbook</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>web<span class=w>
</span><span class=w>  </span>remote_user<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>  </span>vars_files<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>vars/server_vars.yml<span class=w>
</span><span class=w>  </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>insert<span class=w> </span>firewalld<span class=w> </span>rule<span class=w> </span>for<span class=w> </span>httpd<span class=w>
</span><span class=w>    </span>firewalld<span class=p>:</span><span class=w> </span>port=\{\{<span class=w> </span>http_port<span class=w> </span>\}\}/tcp<span class=w> </span>permanent=<span class=kc>true</span><span class=w> </span>state=enabled<span class=w> </span>immediate=yes<span class=w>
</span></code></pre></td></tr></table></div></div><p><code>vars/server_vars.yml</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>http_port<span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=複雑変数の扱い方>複雑変数の扱い方</h4><p>利用したい変数は簡単な文字列や数字ではなく、一つのオブジェクトにしたい時がある。その時に以下のようなYAMLのハッシュ形式(または辞書形式)にオブジェクトの内容を設定する。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>foo<span class=p>:</span><span class=w>
</span><span class=w>  </span>field1<span class=p>:</span><span class=w> </span>one<span class=w>
</span><span class=w>  </span>field2<span class=p>:</span><span class=w> </span>two<span class=w>
</span></code></pre></td></tr></table></div></div><p>こちらの変数を利用したい時は、中括弧またはピリオドで参照できる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>foo<span class=p>[</span><span class=s1>&#39;field1&#39;</span><span class=p>]</span><span class=w>
</span><span class=w></span>foo.field1<span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=yamlの落とし穴>YAMLの落とし穴</h4><p>YAMLの変数構文がAnsibleの変数構文と一緒に書くと構文エラーになる場合がある。詳細については、コロン(:)の後ろにすぐ大括弧 { を書くことはできなく、かならずダブルクォーテーション " で囲む必要がある。もしエラー内容が YAMLの構文エラーの場合、ダブルクォーテーション “ を追加して解決する。</p><p>このYAMLは構文エラーになる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>app_servers<span class=w>
</span><span class=w>  </span>vars<span class=p>:</span><span class=w>
</span><span class=w>      </span>app_path<span class=p>:</span><span class=w> </span>\{\{<span class=w> </span>base_path<span class=w> </span>\}\}/<span class=m>22</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>解決方法は、変数の前後にダブルクォーテーションを追加する。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>app_servers<span class=w>
</span><span class=w>  </span>vars<span class=p>:</span><span class=w>
</span><span class=w>       </span>app_path<span class=p>:</span><span class=w> </span><span class=s2>&#34;\{\{ base_path \}\}/22&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><h3 id=システム変数facts>システム変数(facts)</h3><p>Ansibleはsetup モジュールを通じてリモートノードのシステム情報を収集している。こちらのシステム情報はfactsと呼び、直接変数として利用することができる。
コマンドラインからsetupモジュールを実行して利用可能な変数の一覧が確認できる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible all -m setup -u root
</code></pre></td></tr></table></div></div><p>Playbookの中では、facts変数を直接利用することができる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>---<span class=w>
</span><span class=w></span>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span>user<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>  </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>echo<span class=w> </span>system<span class=w>
</span><span class=w>    </span>shell<span class=p>:</span><span class=w> </span>echo<span class=w> </span>\{\{<span class=w> </span>ansible_os_family<span class=w> </span>\}\}<span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=w> </span>install<span class=w> </span>ntp<span class=w> </span>on<span class=w> </span>Debian<span class=w> </span>linux<span class=w>
</span><span class=w>    </span>apt<span class=p>:</span><span class=w> </span>name=git<span class=w> </span>state=installed<span class=w>
</span><span class=w>    </span>when<span class=p>:</span><span class=w> </span>ansible_os_family<span class=w> </span>==<span class=w> </span><span class=s2>&#34;Debian&#34;</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=w> </span>install<span class=w> </span>ntp<span class=w> </span>on<span class=w> </span>redhat<span class=w> </span>linux<span class=w>
</span><span class=w>    </span>yum<span class=p>:</span><span class=w> </span>name=git<span class=w> </span>state=present<span class=w>
</span><span class=w>    </span>when<span class=p>:</span><span class=w> </span>ansible_os_family<span class=w> </span>==<span class=w> </span><span class=s2>&#34;RedHat&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=複雑なfacts変数>複雑なfacts変数</h4><p>一般変数と同じく、以下のようなハッシュ変数形式のfacts変数も存在する。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-JSON data-lang=JSON><span class=err>.</span><span class=err>.</span><span class=err>.</span>
        <span class=s2>&#34;ansible_ens3&#34;</span><span class=err>:</span> <span class=p>{</span>
            <span class=nt>&#34;active&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
            <span class=nt>&#34;device&#34;</span><span class=p>:</span> <span class=s2>&#34;ens3&#34;</span><span class=p>,</span>
            <span class=nt>&#34;ipv4&#34;</span><span class=p>:</span> <span class=p>{</span>
                <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;10.66.192.234&#34;</span><span class=p>,</span>
                <span class=nt>&#34;netmask&#34;</span><span class=p>:</span> <span class=s2>&#34;255.255.254.0&#34;</span><span class=p>,</span>
                <span class=nt>&#34;network&#34;</span><span class=p>:</span> <span class=s2>&#34;10.66.192.0&#34;</span>
            <span class=p>}</span><span class=p>,</span>
            <span class=nt>&#34;ipv6&#34;</span><span class=p>:</span> <span class=p>[</span>
                <span class=p>{</span>
                    <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;2620:52:0:42c0:5054:ff:fef2:e2a3&#34;</span><span class=p>,</span>
                    <span class=nt>&#34;prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;64&#34;</span><span class=p>,</span>
                    <span class=nt>&#34;scope&#34;</span><span class=p>:</span> <span class=s2>&#34;global&#34;</span>
                <span class=p>}</span><span class=p>,</span>
                <span class=p>{</span>
                    <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;fe80::5054:ff:fef2:e2a3&#34;</span><span class=p>,</span>
                    <span class=nt>&#34;prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;64&#34;</span><span class=p>,</span>
                    <span class=nt>&#34;scope&#34;</span><span class=p>:</span> <span class=s2>&#34;link&#34;</span>
                <span class=p>}</span>
            <span class=p>]</span><span class=p>,</span>
            <span class=nt>&#34;macaddress&#34;</span><span class=p>:</span> <span class=s2>&#34;52:54:00:f2:e2:a3&#34;</span><span class=p>,</span>
            <span class=nt>&#34;module&#34;</span><span class=p>:</span> <span class=s2>&#34;8139cp&#34;</span><span class=p>,</span>
            <span class=nt>&#34;mtu&#34;</span><span class=p>:</span> <span class=mi>1500</span><span class=p>,</span>
            <span class=nt>&#34;promisc&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;ether&#34;</span>
        <span class=p>}</span><span class=err>,</span>
<span class=err>.</span><span class=err>.</span><span class=err>.</span>
</code></pre></td></tr></table></div></div><p>以下の二つの方法でハッシュ形式のfacts変数の属性を参照する。</p><ul><li>中括弧</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>\{\{<span class=w> </span>ansible_ens3<span class=p>[</span><span class=s2>&#34;ipv4&#34;</span><span class=p>]</span><span class=p>[</span><span class=s2>&#34;address&#34;</span><span class=p>]</span><span class=w> </span>\}\}<span class=w>
</span></code></pre></td></tr></table></div></div><ul><li>ピリオド</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>\{\{<span class=w> </span>ansible_ens3.ipv4.address<span class=w> </span>\}\}<span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=factsの無効化>factsの無効化</h4><p>Playbookでは、gather_factsパラメータがfacts変数の収集を設定できる。下記のように no と設定すると、上記のfacts変数はこのPlaybookでの利用ができなくなる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>whatever<span class=w>
</span><span class=w>  </span>gather_facts<span class=p>:</span><span class=w> </span>no<span class=w>
</span></code></pre></td></tr></table></div></div><h3 id=テンプレートで定義した変数>テンプレートで定義した変数</h3><p>テンプレートはAnsibleでよく使われているため、テンプレートファイルでの変数の使い方を説明する。</p><h4 id=変数の定義>変数の定義</h4><p>Playbook内で定義した変数、factsシステム変数、inventory内で定義したhostとgroup変数は、直接テンプレートで利用できる。Playbook内で利用できる変数は、テンプレートファイルでも利用できる。</p><p>下記のPlaybookスクリプトではtemplate モジュールでindex.html.j2ファイルをコピーし、その中の変数をPlaybookで定義した変数の値に設定する。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>---<span class=w>
</span><span class=w></span>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>web<span class=w>
</span><span class=w>  </span>vars<span class=p>:</span><span class=w>
</span><span class=w>    </span>http_port<span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>    </span>defined_name<span class=p>:</span><span class=w> </span><span class=s2>&#34;Hello My name is Jingjng&#34;</span><span class=w>
</span><span class=w>  </span>remote_user<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>  </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>ensure<span class=w> </span>apache<span class=w> </span>is<span class=w> </span>at<span class=w> </span>the<span class=w> </span>latest<span class=w> </span>version<span class=w>
</span><span class=w>    </span>yum<span class=p>:</span><span class=w> </span>pkg=httpd<span class=w> </span>state=latest<span class=w>
</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Write<span class=w> </span>the<span class=w> </span>configuration<span class=w> </span>file<span class=w>
</span><span class=w>    </span>template<span class=p>:</span><span class=w> </span>src=templates/httpd.conf.j2<span class=w> </span>dest=/etc/httpd/conf/httpd.conf<span class=w>
</span><span class=w>    </span>notify<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>restart<span class=w> </span>apache<span class=w>
</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Write<span class=w> </span>the<span class=w> </span>default<span class=w> </span>index.html<span class=w> </span>file<span class=w>
</span><span class=w>    </span>template<span class=p>:</span><span class=w> </span>src=templates/index2.html.j2<span class=w> </span>dest=/var/www/html/index.html<span class=w>
</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>ensure<span class=w> </span>apache<span class=w> </span>is<span class=w> </span>running<span class=w>
</span><span class=w>    </span>service<span class=p>:</span><span class=w> </span>name=httpd<span class=w> </span>state=started<span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>insert<span class=w> </span>firewalld<span class=w> </span>rule<span class=w> </span>for<span class=w> </span>httpd<span class=w>
</span><span class=w>    </span>firewalld<span class=p>:</span><span class=w> </span>port=\{\{<span class=w> </span>http_port<span class=w> </span>\}\}/tcp<span class=w> </span>permanent=<span class=kc>true</span><span class=w> </span>state=enabled<span class=w> </span>immediate=yes<span class=w>
</span><span class=w>
</span><span class=w>  </span>handlers<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>restart<span class=w> </span>apache<span class=w>
</span><span class=w>      </span>service<span class=p>:</span><span class=w> </span>name=httpd<span class=w> </span>state=restarted<span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=変数の利用>変数の利用</h4><p>Ansibleのテンプレートファイルが利用する構文はPython のテンプレート言語Jinja2。下記のテンプレートの例index.html.j2の中で、変数を直接利用している。</p><ul><li>システム変数 <code>\{\{ ansible_hostname \}\}</code>, <code>\{\{ ansible_default_ipv4.address \}\}</code></li><li>ユーザ定義した変数 <code>\{\{ defined_name \}\}</code></li></ul><p>Index.html.j2ファイルの内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-HTML data-lang=HTML><span class=p>&lt;</span><span class=nt>html</span><span class=p></span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>title</span><span class=p></span><span class=p>&gt;</span>Demo<span class=p>&lt;</span><span class=p>/</span><span class=nt>title</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>body</span><span class=p></span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;block&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;height: 99%;&#34;</span><span class=p></span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;centered&#34;</span><span class=p></span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>h1</span><span class=p></span><span class=p>&gt;</span>#46 Demo \{\{ defined_name \}\}<span class=p>&lt;</span><span class=p>/</span><span class=nt>h1</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>p</span><span class=p></span><span class=p>&gt;</span>Served by \{\{ ansible_hostname \}\} (\{\{ ansible_default_ipv4.address \}\}).<span class=p>&lt;</span><span class=p>/</span><span class=nt>p</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=p>/</span><span class=nt>div</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=p>/</span><span class=nt>div</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=p>/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=p>/</span><span class=nt>html</span><span class=p>&gt;</span>
</code></pre></td></tr></table></div></div><h3 id=タスクの実行結果を変数に設定>タスクの実行結果を変数に設定</h3><p>taskの実行結果は変数の値に代入できる。この場合はregisterキーワードを利用し、taskの実行結果を変数に設定し、その後にあるactionに利用される。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>--<span class=sd>-
</span><span class=sd></span><span class=sd>
</span><span class=sd></span><span class=sd>- hosts: web</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>
</span><span class=w>     </span>-<span class=w> </span>shell<span class=p>:</span><span class=w> </span>ls<span class=w>
</span><span class=w>       </span>register<span class=p>:</span><span class=w> </span>result<span class=w>
</span><span class=w>       </span>ignore_errors<span class=p>:</span><span class=w> </span>True<span class=w>
</span><span class=w>
</span><span class=w>     </span>-<span class=w> </span>shell<span class=p>:</span><span class=w> </span>echo<span class=w> </span><span class=s2>&#34;\{\{ result.stdout \}\}&#34;</span><span class=w>
</span><span class=w>       </span>when<span class=p>:</span><span class=w> </span>result.rc<span class=w> </span>==<span class=w> </span><span class=m>5</span><span class=w>
</span><span class=w>
</span><span class=w>     </span>-<span class=w> </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;\{\{ result.stdout \}\}&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Register変数はよくdebug モジュールと一緒に利用され、actionの実行の詳細情報を得てトラブルシュッティングに役立つ。</p><h3 id=コマンドラインで変数を渡す>コマンドラインで変数を渡す</h3><p>汎用性と便利性のため、コマンドラインでPlaybookに変数の値を渡すことができる。この場合はansible-playbookの&ndash;extra-varsオプションを利用する。</p><h4 id=コマンドライン変数の定義>コマンドライン変数の定義</h4><p>下記のように、release.ymlファイルでは、hostsとuserは変数として定義され、コマンドラインから値を設定する必要がある。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>--<span class=sd>-
</span><span class=sd></span><span class=sd>
</span><span class=sd></span><span class=sd>- hosts: &#39;\{\{ hosts \}\}&#39;</span><span class=w>
</span><span class=w>  </span>remote_user<span class=p>:</span><span class=w> </span><span class=s1>&#39;\{\{ user \}\}&#39;</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>     </span>-<span class=w> </span>...<span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=コマンドライン変数の利用>コマンドライン変数の利用</h4><p>以下のようにコマンドラインから変数の値を設定する。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-playbook e33_var_in_command.yml --extra-vars <span class=s2>&#34;hosts=web user=root&#34;</span>
</code></pre></td></tr></table></div></div><p>そのほかに、JSON形式でも利用できる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-playbook e33_var_in_command.yml --extra-vars <span class=s2>&#34;{&#39;hosts&#39;:&#39;vm-rhel7-1&#39;, &#39;user&#39;:&#39;root&#39;}&#34;</span>
</code></pre></td></tr></table></div></div><p>また、変数と値をJSONファイルに書いて、コマンドラインに渡すこともできる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-playbook e33_var_in_command.yml --extra-vars <span class=s2>&#34;@vars.json&#34;</span>
</code></pre></td></tr></table></div></div><h2 id=条件判断ループとブロック>条件判断、ループとブロック</h2><ul><li>when： 条件判断のキーワード。ifに似ている</li><li>loop：循環処理（ループ）のキーワード。forに似ている</li><li>block：複数のtasksを一つのブロックにまとめて、異常処理の対応などに利用できる。</li></ul><h3 id=条件判断when>条件判断(when)</h3><p>例えば、特定のversionのシステム上にパッケージをインストールや、ディスク空き容量がない時にファイルを削除するなど、特定の条件に満足している時のみ、特定のtaskを実行したい場合、Playbook内のwhenを利用する。
サーバーがDebian Linuxの場合すぐシャットダウンする</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span><span class=s2>&#34;shutdown Debian flavored systems&#34;</span><span class=w>
</span><span class=w>    </span>command<span class=p>:</span><span class=w> </span>/sbin/shutdown<span class=w> </span>-t<span class=w> </span>now<span class=w>
</span><span class=w>    </span>when<span class=p>:</span><span class=w> </span>ansible_os_family<span class=w> </span>==<span class=w> </span><span class=s2>&#34;Debian&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>actionの実行結果によって、次に実行するactionを決める</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>command<span class=p>:</span><span class=w> </span>/bin/<span class=kc>false</span><span class=w>
</span><span class=w>    </span>register<span class=p>:</span><span class=w> </span>result<span class=w>
</span><span class=w>    </span>ignore_errors<span class=p>:</span><span class=w> </span>True<span class=w>
</span><span class=w>  </span>-<span class=w> </span>command<span class=p>:</span><span class=w> </span>/bin/something<span class=w>
</span><span class=w>    </span>when<span class=p>:</span><span class=w> </span>result|failed<span class=w>
</span><span class=w>  </span>-<span class=w> </span>command<span class=p>:</span><span class=w> </span>/bin/something_else<span class=w>
</span><span class=w>    </span>when<span class=p>:</span><span class=w> </span>result|success<span class=w>
</span><span class=w>  </span>-<span class=w> </span>command<span class=p>:</span><span class=w> </span>/bin/still/something_else<span class=w>
</span><span class=w>    </span>when<span class=p>:</span><span class=w> </span>result|skipped<span class=w>
</span></code></pre></td></tr></table></div></div><p>リモートノードのシステム変数factsも 条件としてwhenに判断されることができる。また、| intの書き方で返り値の型変換もできる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>---<span class=w>
</span><span class=w></span>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>web<span class=w>
</span><span class=w>  </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;only on Red Hat 7, derivatives, and later&#34;</span><span class=w>
</span><span class=w>      </span>when<span class=p>:</span><span class=w> </span>ansible_os_family<span class=w> </span>==<span class=w> </span><span class=s2>&#34;RedHat&#34;</span><span class=w> </span>and<span class=w> </span>ansible_lsb.major_release|int<span class=w> </span>&gt;=<span class=w> </span><span class=m>6</span><span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=条件式>条件式</h4><p>真偽（True/False）判断の条件式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>vars<span class=p>:</span><span class=w>
</span><span class=w>  </span>epic<span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>
</span><span class=w></span>tasks<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>shell<span class=p>:</span><span class=w> </span>echo<span class=w> </span><span class=s2>&#34;This certainly is epic!&#34;</span><span class=w>
</span><span class=w>      </span>when<span class=p>:</span><span class=w> </span>epic<span class=w>
</span><span class=w>
</span><span class=w></span>tasks<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>shell<span class=p>:</span><span class=w> </span>echo<span class=w> </span><span class=s2>&#34;This certainly isn’t epic!&#34;</span><span class=w>
</span><span class=w>      </span>when<span class=p>:</span><span class=w> </span>not<span class=w> </span>epic<span class=w>
</span></code></pre></td></tr></table></div></div><p>定義有り無し判断の条件式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>tasks<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>shell<span class=p>:</span><span class=w> </span>echo<span class=w> </span><span class=s2>&#34;I&#39;ve got &#39;\{\{ foo \}\}&#39; and am not afraid to use it!&#34;</span><span class=w>
</span><span class=w>      </span>when<span class=p>:</span><span class=w> </span>foo<span class=w> </span>is<span class=w> </span>defined<span class=w>
</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>fail<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;Bailing out. this play requires &#39;bar&#39;&#34;</span><span class=w>
</span><span class=w>      </span>when<span class=p>:</span><span class=w> </span>bar<span class=w> </span>is<span class=w> </span>not<span class=w> </span>defined<span class=w>
</span></code></pre></td></tr></table></div></div><p>数値に対する条件式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>tasks<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>command<span class=p>:</span><span class=w> </span>echo<span class=w> </span>\{\{<span class=w> </span>item<span class=w> </span>\}\}<span class=w>
</span><span class=w>      </span>with_items<span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=m>0</span><span class=p>,</span><span class=w> </span><span class=m>2</span><span class=p>,</span><span class=w> </span><span class=m>4</span><span class=p>,</span><span class=w> </span><span class=m>6</span><span class=p>,</span><span class=w> </span><span class=m>8</span><span class=p>,</span><span class=w> </span><span class=m>10</span><span class=w> </span><span class=p>]</span><span class=w>
</span><span class=w>      </span>when<span class=p>:</span><span class=w> </span>item<span class=w> </span>&gt;<span class=w> </span><span class=m>5</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>includeと一緒に利用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>-<span class=w> </span>include<span class=p>:</span><span class=w> </span>tasks/sometasks.yml<span class=w>
</span><span class=w>  </span>when<span class=p>:</span><span class=w> </span><span class=s2>&#34;&#39;reticulating splines&#39; in output&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Roleと一緒に利用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>webservers<span class=w>
</span><span class=w>  </span>roles<span class=p>:</span><span class=w>
</span><span class=w>     </span>-<span class=w> </span>{<span class=w> </span>role<span class=p>:</span><span class=w> </span>debian_stock_config<span class=p>,</span><span class=w> </span>when<span class=p>:</span><span class=w> </span>ansible_os_family<span class=w> </span>==<span class=w> </span><span class=s1>&#39;Debian&#39;</span><span class=w> </span>}<span class=w>
</span></code></pre></td></tr></table></div></div><h3 id=循環処理loop>循環処理(loop)</h3><h4 id=標準のループwith_items>標準のループ(with_items)</h4><p>コードの読み易さと簡潔のため、重複のタスク内容を以下のように書くことができる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>add<span class=w> </span>several<span class=w> </span>users<span class=w>
</span><span class=w>  </span>user<span class=p>:</span><span class=w> </span>name=\{\{<span class=w> </span>item<span class=w> </span>\}\}<span class=w> </span>state=present<span class=w> </span>groups=wheel<span class=w>
</span><span class=w>  </span>with_items<span class=p>:</span><span class=w>
</span><span class=w>     </span>-<span class=w> </span>testuser1<span class=w>
</span><span class=w>     </span>-<span class=w> </span>testuser2<span class=w>
</span></code></pre></td></tr></table></div></div><p>変数ファイルまたはPlaybookのvarsでYAMLリストを定義した場合、下記のように処理をループすることができる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>vars<span class=p>:</span><span class=w>
</span><span class=w>  </span>somelist<span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;testuser1&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;testuser2&#34;</span><span class=p>]</span><span class=w>
</span><span class=w></span>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-name<span class=p>:</span><span class=w> </span>add<span class=w> </span>several<span class=w> </span>user<span class=w>
</span><span class=w>   </span>user<span class=p>:</span><span class=w> </span>name=\{\{<span class=w> </span>item<span class=w> </span>\}\}<span class=w> </span>state=present<span class=w> </span>groups=wheel<span class=w>
</span><span class=w>   </span>with_items<span class=p>:</span><span class=w> </span><span class=s2>&#34;\{\{somelist\}\}&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>with_itemsキーワードで操作できるのは簡単なデータだけではなく、ハッシュ型（辞書型）の変数の値もループできる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>add<span class=w> </span>several<span class=w> </span>users<span class=w>
</span><span class=w>  </span>user<span class=p>:</span><span class=w> </span>name=\{\{<span class=w> </span>item.name<span class=w> </span>\}\}<span class=w> </span>state=present<span class=w> </span>groups=\{\{<span class=w> </span>item.groups<span class=w> </span>\}\}<span class=w>
</span><span class=w>  </span>with_items<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>{<span class=w> </span>name<span class=p>:</span><span class=w> </span><span class=s1>&#39;testuser1&#39;</span><span class=p>,</span><span class=w> </span>groups<span class=p>:</span><span class=w> </span><span class=s1>&#39;wheel&#39;</span><span class=w> </span>}<span class=w>
</span><span class=w>    </span>-<span class=w> </span>{<span class=w> </span>name<span class=p>:</span><span class=w> </span><span class=s1>&#39;testuser2&#39;</span><span class=p>,</span><span class=w> </span>groups<span class=p>:</span><span class=w> </span><span class=s1>&#39;root&#39;</span><span class=w> </span>}<span class=w>
</span></code></pre></td></tr></table></div></div><p>注意：whenとwith_items（または他のループ）を同時に使用する場合、ループの各実行項目に対してwhenが条件判断を行う。</p><h4 id=ネストループwith_nested>ネストループ(with_nested)</h4><p>階層形式のデータもループすることができる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>give<span class=w> </span>users<span class=w> </span>access<span class=w> </span>to<span class=w> </span>multiple<span class=w> </span>databases<span class=w>
</span><span class=w>  </span>mysql_user<span class=p>:</span><span class=w> </span>name=\{\{<span class=w> </span>item<span class=p>[</span><span class=m>0</span><span class=p>]</span><span class=w> </span>\}\}<span class=w> </span>priv=\{\{<span class=w> </span>item<span class=p>[</span><span class=m>1</span><span class=p>]</span><span class=w> </span>\}\}.<span class=cp>*:ALL</span><span class=w> </span>append_privs=yes<span class=w> </span>password=foo<span class=w>
</span><span class=w>  </span>with_nested<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span><span class=p>[</span><span class=w> </span><span class=s1>&#39;alice&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;bob&#39;</span><span class=w> </span><span class=p>]</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span><span class=p>[</span><span class=w> </span><span class=s1>&#39;clientdb&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;employeedb&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;providerd&#39;</span><span class=p>]</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>または</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>give<span class=w> </span>users<span class=w> </span>access<span class=w> </span>to<span class=w> </span>multiple<span class=w> </span>databases<span class=w>
</span><span class=w>  </span>mysql_user<span class=p>:</span><span class=w> </span>name=\{\{<span class=w> </span>item<span class=m>.0</span><span class=w> </span>\}\}<span class=w> </span>priv=\{\{<span class=w> </span>item<span class=m>.1</span><span class=w> </span>\}\}.<span class=cp>*:ALL</span><span class=w> </span>append_privs=yes<span class=w> </span>password=foo<span class=w>
</span><span class=w>  </span>with_nested<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span><span class=p>[</span><span class=w> </span><span class=s1>&#39;alice&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;bob&#39;</span><span class=w> </span><span class=p>]</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span><span class=p>[</span><span class=w> </span><span class=s1>&#39;clientdb&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;employeedb&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;providerd&#39;</span><span class=p>]</span><span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=ハッシュループwith_dict>ハッシュループ(with_dict)</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>---<span class=w>
</span><span class=w></span>vars<span class=p>:</span><span class=w>
</span><span class=w>  </span>users<span class=p>:</span><span class=w>
</span><span class=w>    </span>alice<span class=p>:</span><span class=w>
</span><span class=w>      </span>name<span class=p>:</span><span class=w> </span>Alice<span class=w> </span>Appleworth<span class=w>
</span><span class=w>      </span>telephone<span class=p>:</span><span class=w> </span><span class=m>123</span><span class=m>-456</span><span class=m>-7890</span><span class=w>
</span><span class=w>    </span>bob<span class=p>:</span><span class=w>
</span><span class=w>      </span>name<span class=p>:</span><span class=w> </span>Bob<span class=w> </span>Bananarama<span class=w>
</span><span class=w>      </span>telephone<span class=p>:</span><span class=w> </span><span class=m>987</span><span class=m>-654</span><span class=m>-3210</span><span class=w>
</span><span class=w></span>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Print<span class=w> </span>phone<span class=w> </span>records<span class=w>
</span><span class=w>    </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;User \{\{ item.key \}\} is \{\{ item.value.name \}\} (\{\{ item.value.telephone \}\})&#34;</span><span class=w>
</span><span class=w>    </span>with_dict<span class=p>:</span><span class=w> </span><span class=s2>&#34;\{\{users\}\}&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=ファイルリストループwith_fileglob>ファイルリストループ(with_fileglob)</h4><p>with_fileglobを利用し、フォルダ以下のファイルをループに代入することができる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>tasks<span class=p>:</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=c># first ensure our target directory exists</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>file<span class=p>:</span><span class=w> </span>dest=/etc/fooapp<span class=w> </span>state=directory<span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=c># copy each file over that matches the given pattern</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>copy<span class=p>:</span><span class=w> </span>src=\{\{<span class=w> </span>item<span class=w> </span>\}\}<span class=w> </span>dest=/etc/fooapp/<span class=w> </span>owner=root<span class=w> </span>mode=<span class=m>600</span><span class=w>
</span><span class=w>      </span>with_fileglob<span class=p>:</span><span class=w>
</span><span class=w>        </span>-<span class=w> </span>/playbooks/files/fooapp/*<span class=w>
</span></code></pre></td></tr></table></div></div><h3 id=ブロックblock>ブロック(block)</h3><p>複数actionをブロックに纏めて、設定した条件に合致した場合、全actionが一括に実行される。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>tasks<span class=p>:</span><span class=w>
</span><span class=w>     </span>-<span class=w> </span>block<span class=p>:</span><span class=w>
</span><span class=w>         </span>-<span class=w> </span>yum<span class=p>:</span><span class=w> </span>name=\{\{<span class=w> </span>item<span class=w> </span>\}\}<span class=w> </span>state=installed<span class=w>
</span><span class=w>           </span>with_items<span class=p>:</span><span class=w>
</span><span class=w>             </span>-<span class=w> </span>httpd<span class=w>
</span><span class=w>             </span>-<span class=w> </span>memcached<span class=w>
</span><span class=w>
</span><span class=w>         </span>-<span class=w> </span>template<span class=p>:</span><span class=w> </span>src=templates/src.j2<span class=w> </span>dest=/etc/foo.conf<span class=w>
</span><span class=w>
</span><span class=w>         </span>-<span class=w> </span>service<span class=p>:</span><span class=w> </span>name=bar<span class=w> </span>state=started<span class=w> </span>enabled=True<span class=w>
</span><span class=w>
</span><span class=w>       </span>when<span class=p>:</span><span class=w> </span>ansible_distribution<span class=w> </span>==<span class=w> </span><span class=s1>&#39;CentOS&#39;</span><span class=w>
</span><span class=w>       </span>become<span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>       </span>become_user<span class=p>:</span><span class=w> </span>root<span class=w>
</span></code></pre></td></tr></table></div></div><p>異常処理をするときに、blockが便利でよく使われている。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>tasks<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>block<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s1>&#39;i execute normally&#39;</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>command<span class=p>:</span><span class=w> </span>/bin/<span class=kc>false</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s1>&#39;i never execute, cause ERROR!&#39;</span><span class=w>
</span><span class=w>    </span>rescue<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s1>&#39;I caught an error&#39;</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>command<span class=p>:</span><span class=w> </span>/bin/<span class=kc>false</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s1>&#39;I also never execute :-(&#39;</span><span class=w>
</span><span class=w>    </span>always<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;this always executes&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><h2 id=既存playbook-の読み込む>既存Playbook の読み込む</h2><p>既存のPlaybookを利用することで、開発時間が節約できるし、メンテナンスもしやすくなる。他のPlaybookファイルを読み込むために、以下二つが方法がある。</p><ul><li>include:<ul><li>既存のPlaybook スクリプトを読み込んで利用する、簡単で利用しやすい。</li></ul></li><li>role:<ul><li>Playbookの"函数”みたいで、使い方はちょっと複雑ですが、includeより強力でいろんなことができる。Ansible Galaxyはrole方式でPlaybookをシェアしている。</li></ul></li></ul><h3 id=playbookファイルの-include>Playbookファイルの include</h3><p>他のPlaybookファイルを include することで、そのファイル内のtasksが利用できる。また、includeでtasksを複数のファイルに分割することで、Playbookの肥大化を防ぐことができる。</p><h4 id=基本の使い方>基本の使い方</h4><p>直接yamlファイルをincludeする。
tasks/firewall_httpd_default.yml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>---<span class=w>
</span><span class=w></span><span class=c># possibly saved as tasks/firewall_httpd_default.yml</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>insert<span class=w> </span>firewalld<span class=w> </span>rule<span class=w> </span>for<span class=w> </span>httpd<span class=w>
</span><span class=w>    </span>firewalld<span class=p>:</span><span class=w> </span>port=<span class=m>80</span>/tcp<span class=w> </span>permanent=<span class=kc>true</span><span class=w> </span>state=enabled<span class=w> </span>immediate=yes<span class=w>
</span></code></pre></td></tr></table></div></div><p>他のPlaybookでのinclude方法は</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>tasks<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>include<span class=p>:</span><span class=w> </span>tasks/firewall_httpd_default.yml<span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=高度な使い方>高度な使い方</h4><p>includeされるPlaybookの中で変数を定義することができる。下記の例では、includeされたtasks/firewall_httpd_default.ymlの中に{{ port }}でport変数を定義した。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>--<span class=sd>-
</span><span class=sd> </span><span class=sd> </span><span class=sd>- name: insert firewalld rule for httpd</span><span class=w>
</span><span class=w>    </span>firewalld<span class=p>:</span><span class=w> </span>port=\{\{<span class=w> </span>port<span class=w> </span>\}\}/tcp<span class=w> </span>permanent=<span class=kc>true</span><span class=w> </span>state=enabled<span class=w> </span>immediate=yes<span class=w>
</span></code></pre></td></tr></table></div></div><p>変数の値をincludeされるPlaybookに渡すために、以下の方法がある。</p><h4 id=includeされるplaybookの後ろに変数名と値を指定>includeされるPlaybookの後ろに、変数名と値を指定</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML><span class=w> </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>include<span class=p>:</span><span class=w> </span>tasks/firewall.yml<span class=w> </span>port=<span class=m>80</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>include<span class=p>:</span><span class=w> </span>tasks/firewall.yml<span class=w> </span>port=<span class=m>3260</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>include<span class=p>:</span><span class=w> </span>tasks/firewall.yml<span class=w> </span>port=<span class=m>423</span><span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=yamlのハッシュ形式で変数と値を渡す>YAMLのハッシュ形式で変数と値を渡す</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML><span class=w> </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>include<span class=p>:</span><span class=w> </span>wordpress.yml<span class=w>
</span><span class=w>      </span>vars<span class=p>:</span><span class=w>
</span><span class=w>          </span>wp_user<span class=p>:</span><span class=w> </span>timmy<span class=w>
</span><span class=w>          </span>ssh_keys<span class=p>:</span><span class=w>
</span><span class=w>            </span>-<span class=w> </span>keys/one.txt<span class=w>
</span><span class=w>            </span>-<span class=w> </span>keys/two.txt<span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=taskをjson形式に書いて変数と値を設定する>taskをJSON形式に書いて、変数と値を設定する</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML><span class=w> </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>   </span>-<span class=w> </span>{<span class=w> </span>include<span class=p>:</span><span class=w> </span>wordpress.yml<span class=p>,</span><span class=w> </span>wp_user<span class=p>:</span><span class=w> </span>timmy<span class=p>,</span><span class=w> </span>ssh_keys<span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s1>&#39;keys/one.txt&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;keys/two.txt&#39;</span><span class=w> </span><span class=p>]</span><span class=w> </span>}<span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=playbook中で定義済みの変数は特に渡す必要がなくそのままりようされる>Playbook中で定義済みの変数は、特に渡す必要がなく、そのままりようされる。</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML><span class=w> </span>--<span class=sd>-
</span><span class=sd> </span><span class=sd> </span><span class=sd>- hosts: lb</span><span class=w>
</span><span class=w>    </span>vars<span class=p>:</span><span class=w>
</span><span class=w>      </span>port<span class=p>:</span><span class=w> </span><span class=m>3206</span><span class=w>
</span><span class=w>    </span>remote_user<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>    </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>include<span class=p>:</span><span class=w> </span>tasks/firewall.yml<span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=includeの落とし穴>Includeの落とし穴</h4><ul><li>handlers内でPlaybook を include する。</li></ul><p>書き方は以下に示す。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML><span class=w> </span>handlers<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>include<span class=p>:</span><span class=w> </span>handlers/handlers.yml<span class=w>
</span></code></pre></td></tr></table></div></div><p>ただし、上記の使い方は、有効と書いたドキュメントがあるが、無効と書いたドキュメントもあり、矛盾している。</p><p>無効と書いたURL：<a href=http://docs.ansible.com/ansible/playbooks_intro.html>http://docs.ansible.com/ansible/playbooks_intro.html</a>
有効と書いたURL：<a href=http://docs.ansible.com/ansible/playbooks_roles.html#task-include-files-and-encouraging-reuse>http://docs.ansible.com/ansible/playbooks_roles.html#task-include-files-and-encouraging-reuse</a></p><p>下記のテストの結果、Ansible 1.9では、includeされたhandlerを呼び出すことができないが、Ansible 2.0以降であれば、includeされたhandlerを呼び出すことができる。そのため、利用しているAnsibleのversionを確認する必要がある。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML><span class=w> </span>--<span class=sd>-
</span><span class=sd> </span><span class=sd> </span><span class=sd>- hosts: lb</span><span class=w>
</span><span class=w>    </span>user<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>    </span>gather_facts<span class=p>:</span><span class=w> </span>no<span class=w>
</span><span class=w>    </span>vars<span class=p>:</span><span class=w>
</span><span class=w>        </span>random_number<span class=p>:</span><span class=w> </span><span class=s2>&#34;\{\{ 10000 | random \}\}&#34;</span><span class=w>
</span><span class=w>    </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Copy<span class=w> </span>the<span class=w> </span>/etc/hosts<span class=w> </span>to<span class=w> </span>/tmp/hosts.\{\{<span class=w> </span>random_number<span class=w> </span>\}\}<span class=w>
</span><span class=w>      </span>copy<span class=p>:</span><span class=w> </span>src=/etc/hosts<span class=w> </span>dest=/tmp/hosts.\{\{<span class=w> </span>random_number<span class=w> </span>\}\}<span class=w>
</span><span class=w>      </span>notify<span class=p>:</span><span class=w>
</span><span class=w>        </span>-<span class=w> </span>restart<span class=w> </span>apache<span class=w>
</span><span class=w>        </span>-<span class=w> </span>restart<span class=w> </span>apache<span class=w> </span>in<span class=w> </span>handlers<span class=w>
</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>handlers<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>include<span class=p>:</span><span class=w> </span>handlers/handlers.yml<span class=w>
</span><span class=w>      </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>restart<span class=w> </span>apache<span class=w>
</span><span class=w>        </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;This is the handler restart apache&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li>Playbook include</li></ul><p>推奨されない使い方で、パラメータが利用できないなどの制限がある。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML><span class=w> </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>this<span class=w> </span>is<span class=w> </span>a<span class=w> </span>play<span class=w> </span>at<span class=w> </span>the<span class=w> </span>top<span class=w> </span>level<span class=w> </span>of<span class=w> </span>a<span class=w> </span>file<span class=w>
</span><span class=w>    </span>hosts<span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>    </span>remote_user<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>    </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>say<span class=w> </span>hi<span class=w>
</span><span class=w>      </span>tags<span class=p>:</span><span class=w> </span>foo<span class=w>
</span><span class=w>      </span>shell<span class=p>:</span><span class=w> </span>echo<span class=w> </span><span class=s2>&#34;hi...&#34;</span><span class=w>
</span><span class=w>  </span><span class=c># 全体include，またはplaybook include</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>include<span class=p>:</span><span class=w> </span>load_balancers.yml<span class=w>
</span><span class=w>  </span>-<span class=w> </span>include<span class=p>:</span><span class=w> </span>webservers.yml<span class=w>
</span><span class=w>  </span>-<span class=w> </span>include<span class=p>:</span><span class=w> </span>dbservers.yml<span class=w>
</span></code></pre></td></tr></table></div></div><h3 id=playbookのpackagerole>Playbookの"Package”(role)</h3><p>Roleはincludeよりもっと柔軟で強力なコードシェア方法を提供する。includeは他のプログラミング言語の"include”と似たような使い方で、1つのファイルした利用できない。それに対し、roleは”Package”みたいな使い方で、複数のファイルを同時参照によって1つの機能を利用できる。例えば、apacheのインストールと設定をする時、tasksでパッケージのインストール、テンプレートファイルと設定ファイルのコピー、handlerでのサービス再起動など、こちらの処理を1つのroleに纏めることによって、他のPlaybookに参照し利用されることができる。</p><p>Ansibleではroleの利用を推奨していて、roleをシェアするためのプラットフォーム Ansible Galaxy <a href=https://galaxy.ansible.com/>https://galaxy.ansible.com/</a> を提供している。そこでは他の人が書いたroleを参照し利用することができる。</p><h4 id=roleのディレクトリ構造>roleのディレクトリ構造</h4><p>Ansibleでは、決まったディレクトリ構造でroleを定義する。具体的な例を以下に示す。</p><p>この例では、名前がmyroleのroleが定義され、<code>site.yml</code>で参照している。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>site.yml<span class=w>
</span><span class=w></span>roles/<span class=w>
</span><span class=w></span>├──<span class=w> </span>myrole<span class=w>
</span><span class=w>    </span>├──<span class=w> </span>tasks<span class=w>
</span><span class=w>    </span>│<span class=w>   </span>└──<span class=w> </span>main.yml<span class=w>
</span><span class=w>    </span>├──<span class=w> </span>handlers<span class=w>
</span><span class=w>    </span>│<span class=w>   </span>└──<span class=w> </span>main.yml<span class=w>
</span><span class=w>    </span>├──<span class=w> </span>defaults<span class=w>
</span><span class=w>    </span>│<span class=w>   </span>└──<span class=w> </span>main.yml<span class=w>
</span><span class=w>    </span>├──<span class=w> </span>vars<span class=w>
</span><span class=w>    </span>│<span class=w>   </span>└──<span class=w> </span>main.yml<span class=w>
</span><span class=w>    </span>├──<span class=w> </span>files<span class=w>
</span><span class=w>    </span>├──<span class=w> </span>templates<span class=w>
</span><span class=w>    </span>├──<span class=w> </span>README.md<span class=w>
</span><span class=w>    </span>├──<span class=w> </span>meta<span class=w>
</span><span class=w>    </span>│<span class=w>   </span>└──<span class=w> </span>main.yml<span class=w>
</span><span class=w>    </span>└──<span class=w> </span>tests<span class=w>
</span><span class=w>        </span>├──<span class=w> </span>inventory<span class=w>
</span><span class=w>        </span>└──<span class=w> </span>test.yml<span class=w>
</span></code></pre></td></tr></table></div></div><p><code>site.yml</code>でroleを参照</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>---<span class=w>
</span><span class=w></span>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>webservers<span class=w>
</span><span class=w>  </span>roles<span class=p>:</span><span class=w>
</span><span class=w>     </span>-<span class=w> </span>myrole<span class=w>
</span></code></pre></td></tr></table></div></div><p>roleを作成する時に上記すべてのディレクトリとファイルが必須ではないが、このroleが実現したい機能と仕様によって対応するディレクトリとファイルを作成する。下記は各ファイルの役割をしめす 。</p><table><thead><tr><th>ファイル</th><th>役割</th></tr></thead><tbody><tr><td><code>roles/x/tasks/main.yml</code></td><td>ファイル内のtasksがPlaybookに追加される。そのため、このファイルはroleの入り口である。このroleの詳細を知りたい場合は、このファイルから参照したほうが良い</td></tr><tr><td><code>roles/x/handlers/main.yml</code></td><td>ファイル内のhandlersがPlaybookに追加される。</td></tr><tr><td><code>roles/x/vars/main.yml</code></td><td>ファイル内のvariablesがPlaybookに追加される。</td></tr><tr><td><code>roles/x/meta/main.yml</code></td><td>ファイル内のロール情報がPlaybookのrolesリストに追加される。</td></tr></tbody></table><p><code>roles/x/tasks/main.yml</code> でのすべてのtasksは、<code>roles/x/{files,templates,tasks}</code>のファイルを直接参照でき、ファイルパスを指定する必要がない。自分でroleを書くときに、一般的には <code>roles/x/tasks/main.yml</code> を作成する。他のファイルとディレクトリは、必要によって追加する。</p><p>以下では、具体の例を通してroleの書き方と使い方を紹介する。</p><h4 id=roleで変数を使う>Roleで変数を使う</h4><p>変数付きのmyroleのディレクトリ構造を以下に示す。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>main.yml
 roles
   role_with_var
     tasks
       main.yml
</code></pre></td></tr></table></div></div><p>以下の様に、<code>roles/myrole/tasks/main.yml</code> で<code>\{\{ \}\}</code>を使って変数を定義する。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>--<span class=sd>-
</span><span class=sd></span><span class=sd> </span><span class=sd>- name: use param</span><span class=w>
</span><span class=w>   </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;\{\{ param \}\}&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>それで、main.ymlで以下のようにmyroleを利用することができる</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>--<span class=sd>-
</span><span class=sd></span><span class=sd>
</span><span class=sd></span><span class=sd>- hosts: webservers</span><span class=w>
</span><span class=w>  </span>roles<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>{<span class=w> </span>role<span class=p>:</span><span class=w> </span>myrole<span class=p>,</span><span class=w> </span>param<span class=p>:</span><span class=w> </span><span class=s1>&#39;Call some_role for the 1st time&#39;</span><span class=w> </span>}<span class=w>
</span><span class=w>    </span>-<span class=w> </span>{<span class=w> </span>role<span class=p>:</span><span class=w> </span>myrole<span class=p>,</span><span class=w> </span>param<span class=p>:</span><span class=w> </span><span class=s1>&#39;Call some_role for the 2nd time&#39;</span><span class=w> </span>}<span class=w>
</span></code></pre></td></tr></table></div></div><p>YAMLの辞書型に書くと</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>--<span class=sd>-
</span><span class=sd></span><span class=sd>
</span><span class=sd></span><span class=sd>- hosts: webservers</span><span class=w>
</span><span class=w>  </span>roles<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>role<span class=p>:</span><span class=w> </span>myrole<span class=w>
</span><span class=w>      </span>param<span class=p>:</span><span class=w> </span><span class=s1>&#39;Call some_role for the 1st time&#39;</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>role<span class=p>:</span><span class=w> </span>myrole<span class=w>
</span><span class=w>      </span>param<span class=p>:</span><span class=w> </span><span class=s1>&#39;Call some_role for the 2nd time&#39;</span><span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=変数のデフォルト値>変数のデフォルト値</h4><p>変数のデフォルト値が設定された場合、roleを読み込むときにもし変数に対し新しい値が渡された場合、その新しい値を利用する。もし変数に新しい値を渡していない場合、変数はデフォルト値を利用する。</p><p>デフォルト値の設定はとても簡単で、上記のrole_with_varを例にする</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>main.yml
roles:
  myrole
    tasks
      main.yml
    defaults
      main.yml
</code></pre></td></tr></table></div></div><p><code>roles/myrole/defaults/main.yml</code>でparamの値を定義する。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>param<span class=p>:</span><span class=w> </span><span class=s2>&#34;I am the default value&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>これによって、main.ymlでは以下の二つの方法でroleを読み込むことができる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>---<span class=w>
</span><span class=w></span>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>webservers<span class=w>
</span><span class=w>  </span>roles<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>role_with_var<span class=w>
</span><span class=w>    </span>-<span class=w> </span>{<span class=w> </span>role<span class=p>:</span><span class=w> </span>role_with_var<span class=p>,</span><span class=w> </span>param<span class=p>:</span><span class=w> </span><span class=s1>&#39;I am the value from external&#39;</span><span class=w> </span>}<span class=w>
</span></code></pre></td></tr></table></div></div><p>他の例については <a href=https://github.com/shijingjing1221/ansible-first-book-examples/blob/master/role_vars.yml>https://github.com/shijingjing1221/ansible-first-book-examples/blob/master/role_vars.yml</a>を参照する</p><h4 id=roleとwhenと一緒に実行>roleとwhenと一緒に実行</h4><p>下記の例では、my_roleはRedHat系のサーバー上しか有効にならない。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>---<span class=w>
</span><span class=w></span>-<span class=w> </span>hosts<span class=p>:</span><span class=w> </span>webservers<span class=w>
</span><span class=w>  </span>roles<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>{<span class=w> </span>role<span class=p>:</span><span class=w> </span>my_role<span class=p>,</span><span class=w> </span>when<span class=p>:</span><span class=w> </span><span class=s2>&#34;ansible_os_family == &#39;RedHat&#39;&#34;</span><span class=w> </span>}<span class=w>
</span></code></pre></td></tr></table></div></div><p>YAML辞書型で書くと以下になる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>--<span class=sd>-
</span><span class=sd></span><span class=sd>
</span><span class=sd></span><span class=sd>- hosts: webservers</span><span class=w>
</span><span class=w>  </span>roles<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>role<span class=p>:</span><span class=w> </span>my_role<span class=w>
</span><span class=w>      </span>when<span class=p>:</span><span class=w> </span><span class=s2>&#34;ansible_os_family == &#39;RedHat&#39;&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=roleとtaskの実行順番>roleとtaskの実行順番</h4><p>Playbookでは、roleとtasksが同時にある時に、どちらが先に実行になる？答えが以下のようになる。</p><p>pre_tasks > role > tasks > post_tasks</p><p>例で示すと、以下のPlaybookに対し</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>--<span class=sd>-
</span><span class=sd></span><span class=sd>
</span><span class=sd></span><span class=sd>- hosts: lb</span><span class=w>
</span><span class=w>  </span>user<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span>pre_tasks<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>pre<span class=w>
</span><span class=w>      </span>shell<span class=p>:</span><span class=w> </span>echo<span class=w> </span><span class=s1>&#39;hello&#39;</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>roles<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>{<span class=w> </span>role<span class=p>:</span><span class=w> </span>some_role<span class=w> </span>}<span class=w>
</span><span class=w>
</span><span class=w>  </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>task<span class=w>
</span><span class=w>      </span>shell<span class=p>:</span><span class=w> </span>echo<span class=w> </span><span class=s1>&#39;still busy&#39;</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>post_tasks<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>post<span class=w>
</span><span class=w>      </span>shell<span class=p>:</span><span class=w> </span>echo<span class=w> </span><span class=s1>&#39;goodbye&#39;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>実際に実行した結果は以下になる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>PLAY <span class=o>[</span>lb<span class=o>]</span> **********************************************************************


TASK <span class=o>[</span>setup<span class=o>]</span> *******************************************************************
ok: <span class=o>[</span>rhel7u3<span class=o>]</span>

TASK <span class=o>[</span>pre<span class=o>]</span> *********************************************************************
changed: <span class=o>[</span>rhel7u3<span class=o>]</span>

TASK <span class=o>[</span>some_role : some role<span class=o>]</span> ***************************************************
ok: <span class=o>[</span>rhel7u3<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>{</span>
    <span class=s2>&#34;msg&#34;</span>: <span class=s2>&#34;Im some role&#34;</span>
<span class=o>}</span>

TASK <span class=o>[</span>task<span class=o>]</span> ********************************************************************
changed: <span class=o>[</span>rhel7u3<span class=o>]</span>

TASK <span class=o>[</span>post<span class=o>]</span> ********************************************************************
changed: <span class=o>[</span>rhel7u3<span class=o>]</span>

PLAY RECAP *********************************************************************
rhel7u3                    : <span class=nv>ok</span><span class=o>=</span><span class=m>5</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>
</code></pre></td></tr></table></div></div><h2 id=tagsで一部のtasksを実行>tagsで一部のtasksを実行</h2><p>Playbookの内容が多い時、一部しか実行したくない場合、Playbookのtagsを使って一部のtasksを実行できる。</p><h3 id=tagsの基本の使い方>tagsの基本の使い方</h3><p>以下の例では、example.ymlの中にpackagesとconfiguration 二つのtagが書かれている。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>tasks<span class=p>:</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>yum<span class=p>:</span><span class=w> </span>name=\{\{<span class=w> </span>item<span class=w> </span>\}\}<span class=w> </span>state=installed<span class=w>
</span><span class=w>    </span>with_items<span class=p>:</span><span class=w>
</span><span class=w>       </span>-<span class=w> </span>httpd<span class=w>
</span><span class=w>    </span>tags<span class=p>:</span><span class=w>
</span><span class=w>       </span>-<span class=w> </span>packages<span class=w>
</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>copy<span class=w> </span>httpd.conf<span class=w>
</span><span class=w>    </span>template<span class=p>:</span><span class=w> </span>src=templates/httpd.conf.j2<span class=w> </span>dest=/etc/httpd/conf/httpd.conf<span class=w>
</span><span class=w>    </span>tags<span class=p>:</span><span class=w>
</span><span class=w>       </span>-<span class=w> </span>configuration<span class=w>
</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>copy<span class=w> </span>index.html<span class=w>
</span><span class=w>    </span>template<span class=p>:</span><span class=w> </span>src=templates/index.html.j2<span class=w> </span>dest=/var/www/html/index.html<span class=w>
</span><span class=w>    </span>tags<span class=p>:</span><span class=w>
</span><span class=w>       </span>-<span class=w> </span>configuration<span class=w>
</span></code></pre></td></tr></table></div></div><p>tag変数を付けずに実行すると、すべてのtasksが実行される。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-playbook example.yml
</code></pre></td></tr></table></div></div><p>パッケージのインストールのみ実行したい時に、tagsでpackagesを指定してPlaybook を実行する。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-playbook example.yml --tags <span class=s2>&#34;packages&#34;</span>
</code></pre></td></tr></table></div></div><p>configurationの部分を実行しない場合、skip-tagsでconfigurationを指定してPlaybook を実行する。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-playbook example.yml --skip-tags <span class=s2>&#34;configuration&#34;</span>
</code></pre></td></tr></table></div></div><h3 id=特殊の意味を持つtags>特殊の意味を持つtags</h3><ul><li>always</li></ul><p>タグの名前がユーザで決めるが、alwaysに設定するとタグの意味が特殊になる。Playbookを実行するときに、alwaysタグを実行しないことを明示的に示さないと、このタグは実行される。</p><p>下記の例では、</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML><span class=w> </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;Always print this debug message&#34;</span><span class=w>
</span><span class=w>      </span>tags<span class=p>:</span><span class=w>
</span><span class=w>        </span>-<span class=w> </span>always<span class=w>
</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>yum<span class=p>:</span><span class=w> </span>name=\{\{<span class=w> </span>item<span class=w> </span>\}\}<span class=w> </span>state=installed<span class=w>
</span><span class=w>      </span>with_items<span class=p>:</span><span class=w>
</span><span class=w>         </span>-<span class=w> </span>httpd<span class=w>
</span><span class=w>      </span>tags<span class=p>:</span><span class=w>
</span><span class=w>         </span>-<span class=w> </span>packages<span class=w>
</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>template<span class=p>:</span><span class=w> </span>src=templates/httpd.conf.j2<span class=w> </span>dest=/etc/httpd/conf/httpd.conf<span class=w>
</span><span class=w>      </span>tags<span class=p>:</span><span class=w>
</span><span class=w>         </span>-<span class=w> </span>configuration<span class=w>
</span></code></pre></td></tr></table></div></div><p>packagesタグのみ実行しても、alwaysタグのtaskも実行される。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-playbook tags_always.yml --tags <span class=s2>&#34;packages&#34;</span>
</code></pre></td></tr></table></div></div><ul><li>tagged, untagged, all</li></ul><p>以下のPlaybookに対し</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML><span class=w> </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;I am not tagged&#34;</span><span class=w>
</span><span class=w>      </span>tags<span class=p>:</span><span class=w>
</span><span class=w>        </span>-<span class=w> </span>tag1<span class=w>
</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>debug<span class=p>:</span><span class=w> </span>msg=<span class=s2>&#34;I am not tagged&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>それぞれのコマンドにtagged, untagged, allを指定して実行してみましょう</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash> ansible-playbook tags_tagged_untagged_all.yml --tags tagged
 ansible-playbook tags_tagged_untagged_all.yml --tags untagged
 ansible-playbook tags_tagged_untagged_all.yml --tags all
</code></pre></td></tr></table></div></div><h3 id=includeとroleでtagsを利用>includeとroleでtagsを利用</h3><p>下記のようにincludeの中にtagsを設定することができる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>-<span class=w> </span>include<span class=p>:</span><span class=w> </span>foo.yml<span class=w>
</span><span class=w>  </span>tags<span class=p>:</span><span class=w> </span><span class=p>[</span>web<span class=p>,</span>foo<span class=p>]</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>rolesの中のタグを参照したい場合は、以下の例で示す。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>roles<span class=p>:</span><span class=w>
</span><span class=w>  </span>-<span class=w> </span>{<span class=w> </span>role<span class=p>:</span><span class=w> </span>webserver<span class=p>,</span><span class=w> </span>port<span class=p>:</span><span class=w> </span><span class=m>5000</span><span class=p>,</span><span class=w> </span>tags<span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s1>&#39;web&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;foo&#39;</span><span class=w> </span><span class=p>]</span><span class=w> </span>}<span class=w>
</span></code></pre></td></tr></table></div></div><h1 id=ansible-の拡張モジュール-extra-modules>Ansible の拡張モジュール (Extra Modules)</h1><p>Ansibleのモジュールドキュメント(<a href=http://docs.ansible.com/ansible/latest/modules/modules_by_category.html>http://docs.ansible.com/ansible/latest/modules/modules_by_category.html</a>)を参照する時に、各ページの一番下に、このモジュールは"Core module”または”Extra Module”であることを示している。例えば、yumはcore moduleが、yum_repositoryはextra moduleである。</p><ul><li>Core Module<ul><li>特に設定やインストールする必要がなく、Ansibleをインストール後に使える。</li><li>よく使われているmodule</li><li>テスト済み</li></ul></li><li>Extra Module<ul><li>設定やインストールをしてから利用する。</li><li>比較的に使用頻度が低い</li><li>bugが存在している可能性がある。</li></ul></li></ul><h2 id=extra-moduleの使い方>Extra Moduleの使い方</h2><p>以下の手順でExtra moduleをのインストールと設定を行うと、コマンドラインとPlaybookで利用できる。Extra Module は Core Module と同じ使い方で利用できる。
注意：Extra moduleがテストされ問題ない場合はCore Moduleに移動される。</p><h3 id=ansible-module-extraをダウンロード>Ansible module extraをダウンロード</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>git clone https://github.com/ansible/ansible-modules-extras.git
</code></pre></td></tr></table></div></div><p>例として、ダウンロード先は/home/jshi/software/になっている。このパスは後で利用する。</p><h3 id=extraモジュールが使えるように設定内容を修正>extraモジュールが使えるように設定内容を修正</h3><ul><li>方法1：デフォルトのAnsible設定ファイルを変更</li></ul><p><code>/etc/ansible/ansible.cfg</code>を編集し、下記 1 行を追加</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>library<span class=w>    </span>=<span class=w> </span>/home/jshi/software/ansible-modules-extras/<span class=w>
</span></code></pre></td></tr></table></div></div><ul><li>方法2：カレントディレクトリの下にあるansible.cfgを変更</li></ul><p>この方法は、同じくカレントディレクトリにあるplaybookのみに有効になる。他の親ディレクトリや子ディレクトリのPlaybookには無効になる。</p><p>下記のディレクトリ構造に対し、ansible.cfgを変更した後、use_extra_module.ymlのみextra moduleが利用できる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>library/ansible-modules-extras
ansible.cfg
use_extra_module.yml
subfolder/use_extra_module_will_throw_error.yml
</code></pre></td></tr></table></div></div><p>カレントディレクトリにあるため、設定内容は相対パスでも大丈夫。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>library = library/ansible-modules-extras/
</code></pre></td></tr></table></div></div><ul><li>方法3：環境変数を修正する</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>export</span> <span class=nv>ANSIBLE_LIBRARY</span><span class=o>=</span>/project/demo/demoansible/library/ansible-module-extras
</code></pre></td></tr></table></div></div><p>もし再起動後も有効にしたい場合、~/.bashrcでANSIBLE_LIBRARY環境変数を設定する。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>echo</span> &gt;&gt;~/.bashrc <span class=s>&lt;&lt;EOF
</span><span class=s>
</span><span class=s>export ANSIBLE_LIBRARY=/project/demo/demoansible/library/ansible-module-extras
</span><span class=s>
</span><span class=s>EOF</span>

$ <span class=nb>source</span> ~/.bashrc
</code></pre></td></tr></table></div></div><h2 id=コマンドラインでモジュールの使い方を参照>コマンドラインでモジュールの使い方を参照</h2><p>Bashのman命令みたいに、ansibleはコマンドラインでmoduleの使い方が参照できる。コマンド名は ansible-doc である。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-doc module_name
</code></pre></td></tr></table></div></div><p>Core Moduleに対しはどこで実行しても問題がない、例えばyumのを参照したい場合</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-doc yum
</code></pre></td></tr></table></div></div><p>Extra Moduleに対しては、extra moduleの利用を設定したディレクトリの下でコマンドを実行する。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ansible-doc yum_repository
</code></pre></td></tr></table></div></div><h2 id=より良いplaybookの書き方>より良いPlaybookの書き方</h2><ul><li>Includeとroleを使って、重複がないコードを書く</li><li>大きいファイルを小さいファイルに分割して書く</li></ul><p><a href=https://github.com/ansible/ansible-examples>https://github.com/ansible/ansible-examples</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>production                <span class=c1># inventory file for production servers</span>
staging                   <span class=c1># inventory file for staging environment</span>

group_vars/
   group1                 <span class=c1># here we assign variables to particular groups</span>
   group2                 <span class=c1># &#34;&#34;</span>
host_vars/
   hostname1              <span class=c1># if systems need specific variables, put them here</span>
   hostname2              <span class=c1># &#34;&#34;</span>

library/                  <span class=c1># if any custom modules, put them here (optional)</span>
filter_plugins/           <span class=c1># if any custom filter plugins, put them here (optional)</span>

site.yml                  <span class=c1># master playbook</span>
webservers.yml            <span class=c1># playbook for webserver tier</span>
dbservers.yml             <span class=c1># playbook for dbserver tier</span>

roles/
    common/               <span class=c1># this hierarchy represents a &#34;role&#34;</span>
        tasks/            #
            main.yml      <span class=c1>#  &lt;-- tasks file can include smaller files if warranted</span>
        handlers/         #
            main.yml      <span class=c1>#  &lt;-- handlers file</span>
        templates/        <span class=c1>#  &lt;-- files for use with the template resource</span>
            ntp.conf.j2   <span class=c1>#  &lt;------- templates end in .j2</span>
        files/            #
            bar.txt       <span class=c1>#  &lt;-- files for use with the copy resource</span>
            foo.sh        <span class=c1>#  &lt;-- script files for use with the script resource</span>
        vars/             #
            main.yml      <span class=c1>#  &lt;-- variables associated with this role</span>
        defaults/         #
            main.yml      <span class=c1>#  &lt;-- default lower priority variables for this role</span>
        meta/             #
            main.yml      <span class=c1>#  &lt;-- role dependencies</span>

    webtier/              <span class=c1># same kind of structure as &#34;common&#34; was above, done for the webtier role</span>
    monitoring/           <span class=c1># &#34;&#34;</span>
    fooapp/               <span class=c1># &#34;&#34;</span>
</code></pre></td></tr></table></div></div><h2 id=参考資料>参考資料</h2><p>Ansibleのビデオセッション(英文) <a href=https://sysadmincasts.com/episodes/43-19-minutes-with-ansible-part-1-4>https://sysadmincasts.com/episodes/43-19-minutes-with-ansible-part-1-4</a></p><p>本資料にあるすべての例</p><p><a href=https://github.com/shijingjing1221/ansible-first-book-examples/>https://github.com/shijingjing1221/ansible-first-book-examples/</a></p><p>YAMLの基本文法と紹介</p><p><a href=https://en.wikipedia.org/wiki/YAML>https://en.wikipedia.org/wiki/YAML</a></p><p><a href=http://www.yamllint.com/>http://www.yamllint.com/</a></p><p>Ansible Tower紹介</p><p><a href=https://www.ansible.com/tower>https://www.ansible.com/tower</a></p><h1 id=copyright>CopyRight</h1><p>此书电子版免费供大家下载阅读，如果您已为此副本付费，请立即申请退款并联系作者举报此行为。请注意，虽然此书电子版免费供大家阅读，但这并不代表作者放弃了版权，您在未经授权的情况下依然不得以任何方式复制或抄袭本书内容。此书的电子版目前仅授权图灵社区和gitbook.com两个平台发布，如果您通过其他渠道获取到了此副本，则是侵权行为，请到上述两个平台下载合法授权的副本。获取合法授权副本的好处是可以及时得到此书的最新版本，早期版本中的错误会被及时纠正。感谢您对版权保护工作所做出的贡献。</p><p>作者邮箱:shijingjing02@163.com</p><p>作者Github: <a href=https://github.com/shijingjing1221/>https://github.com/shijingjing1221/</a></p><h1 id=demo>Demo</h1><p><a href="https://www.youtube.com/watch?v=vOa4_1fgNPU">https://www.youtube.com/watch?v=vOa4_1fgNPU</a></p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>Wenhan Shi</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2023-03-09
<a href=https://github.com/xibuka/xibuka.github.io.git/commit/0054a3d35b97e3f4b69290f8083a03ce0d2864e2 title="fix image issue">(0054a3d)</a></span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/linux/>Linux</a>
<a href=/tags/ansible/>Ansible</a></div><nav class=post-nav><a class=prev href=/post/getting-started-with-ansible-jp-basic/><i class="iconfont icon-left"></i><span class="prev-text nav-default">Ansible 入門 - 基本操作(チュートリアル)</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=/post/getting-started-with-ansible-jp-intro/><span class="next-text nav-default">Ansible 入門 - 紹介</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=xibuka/xibuka.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:shibunkan@gmail.com class="iconfont icon-email" title=email></a><a href=https://twitter.com/shi_wenhan class="iconfont icon-twitter" title=twitter></a><a href=https://www.linkedin.com/in/wenhan-shi-0883a9132/ class="iconfont icon-linkedin" title=linkedin></a><a href=https://github.com/xibuka class="iconfont icon-github" title=github></a><a href=https://www.zhihu.com/people/xibuka class="iconfont icon-zhihu" title=zhihu></a><a href=https://wenhan.blog/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span><div class=busuanzi-footer><span id=busuanzi_container_site_pv>site pv: <span id=busuanzi_value_site_pv><img src=/img/spinner.svg alt=spinner.svg></span></span>
<span class=division>|</span>
<span id=busuanzi_container_site_uv>site uv: <span id=busuanzi_value_site_uv><img src=/img/spinner.svg alt=spinner.svg></span></span></div><span class=copyright-year>&copy;
2016 -
2023
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>Wenhan Shi</span></span>
<script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/dist/even.26188efa.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-87273435-2','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>