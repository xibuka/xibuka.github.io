<!doctype html>




<html class="theme-next pisces" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="R4LmYy1qpduVpsQoZvUXjxqKgmMw0vAgFCjS8UbQpSc" />













  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Linux,Ansible," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="こちらの記事はではAnsibleを紹介するための文章で、元Red Hat社員のJingjing Shiが作成し、Wenhan Shiが日本語に翻訳しました。内容の校正はHideki SaitoとKento Yagisawaが協力しています。Ansibleの基礎知識から、実際の現場で利用できる実運用まで紹介しています。 本文内にあるすべてのansible playbookの例は、以下のgithubの">
<meta name="keywords" content="Linux,Ansible">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible 入門 - 応用">
<meta property="og:url" content="http://wenhan.blog/2018/04/09/Getting-started-with-Ansible-JP-adv/index.html">
<meta property="og:site_name" content="Wenhan Code life">
<meta property="og:description" content="こちらの記事はではAnsibleを紹介するための文章で、元Red Hat社員のJingjing Shiが作成し、Wenhan Shiが日本語に翻訳しました。内容の校正はHideki SaitoとKento Yagisawaが協力しています。Ansibleの基礎知識から、実際の現場で利用できる実運用まで紹介しています。 本文内にあるすべてのansible playbookの例は、以下のgithubの">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://raw.githubusercontent.com/xibuka/git_pics/master/ansible_3.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xibuka/git_pics/master/ansible_4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xibuka/git_pics/master/ansible_5.png">
<meta property="og:updated_time" content="2018-04-10T07:02:44.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ansible 入門 - 応用">
<meta name="twitter:description" content="こちらの記事はではAnsibleを紹介するための文章で、元Red Hat社員のJingjing Shiが作成し、Wenhan Shiが日本語に翻訳しました。内容の校正はHideki SaitoとKento Yagisawaが協力しています。Ansibleの基礎知識から、実際の現場で利用できる実運用まで紹介しています。 本文内にあるすべてのansible playbookの例は、以下のgithubの">
<meta name="twitter:image" content="https://raw.githubusercontent.com/xibuka/git_pics/master/ansible_3.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://wenhan.blog/2018/04/09/Getting-started-with-Ansible-JP-adv/"/>




<!-- ad start -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 自适应单元 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2422626403812806"
     data-ad-slot="1454707894"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- ad end -->


  <title> Ansible 入門 - 応用 | Wenhan Code life </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-87273435-2', 'auto');
  ga('send', 'pageview');
</script>











  
  
    
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wenhan Code life</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Beware the dard side.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wenhan.blog/2018/04/09/Getting-started-with-Ansible-JP-adv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wenhan Shi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wenhan Code life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Ansible 入門 - 応用
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-09T15:20:32+09:00">
                2018-04-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/09/Getting-started-with-Ansible-JP-adv/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/04/09/Getting-started-with-Ansible-JP-adv/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/04/09/Getting-started-with-Ansible-JP-adv/" class="leancloud_visitors" data-flag-title="Ansible 入門 - 応用">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>こちらの記事はではAnsibleを紹介するための文章で、元Red Hat社員のJingjing Shiが作成し、Wenhan Shiが日本語に翻訳しました。内容の校正はHideki SaitoとKento Yagisawaが協力しています。Ansibleの基礎知識から、実際の現場で利用できる実運用まで紹介しています。</p>
<p>本文内にあるすべてのansible playbookの例は、以下のgithubのURLから利用できる。<br><a href="https://github.com/ansible-book/ansible-first-book-examples" target="_blank" rel="noopener">https://github.com/ansible-book/ansible-first-book-examples</a><br>もし不備やコメントがありましたら、作者<a href="mailto:shijingjing02@163.com" target="_blank" rel="noopener">shijingjing02@163.com</a>または翻訳者<a href="mailto:shibunkan@gmail.com" target="_blank" rel="noopener">shibunkan@gmail.com</a> に連絡してください。</p>
<p>詳細の内容を下記三つに分けて説明します。</p>
<p><a href="http://wenhan.blog/2018/04/09/Getting-started-with-Ansible-JP-intro/">Ansible 入門 - 紹介</a><br><a href="http://wenhan.blog/2018/04/09/Getting-started-with-Ansible-JP-basic/">Ansible 入門 - 基本</a><br><a href="http://wenhan.blog/2018/04/09/Getting-started-with-Ansible-JP-adv/">Ansible 入門 - 応用</a></p>
<p>本章では、もっと自由に運用するために、Ansibleの高度な使い方を説明する。</p>
<ol>
<li>Ansibleの設定ファイル</li>
<li>サーバーリスト管理（Host Inventory）</li>
<li>Playbookの上級な書き方</li>
<li>Extraモジュールの利用</li>
</ol>
<a id="more"></a>
<h1 id="Ansible設定ファイル"><a href="#Ansible設定ファイル" class="headerlink" title="Ansible設定ファイル"></a>Ansible設定ファイル</h1><h2 id="設定内容"><a href="#設定内容" class="headerlink" title="設定内容"></a>設定内容</h2><ul>
<li>基本の設定内容</li>
</ul>
<table>
<thead>
<tr>
<th>項目</th>
<th>詳細</th>
<th>内容（デフォルト）</th>
</tr>
</thead>
<tbody>
<tr>
<td>inventory</td>
<td>リモートノードリスト管理ファイル</td>
<td>/etc/ansible/hosts</td>
</tr>
<tr>
<td>library</td>
<td>拡張モジュールフォルダ</td>
<td>/usr/share/my_modules/</td>
</tr>
<tr>
<td>remote_tmp</td>
<td>リモートノード上のファイル一時保存場所</td>
<td>$HOME/.ansible/tmp</td>
</tr>
<tr>
<td>local_tmp</td>
<td>管理者ノード上のファイル一時保存場所</td>
<td>$HOME/.ansible/tmp</td>
</tr>
</tbody>
</table>
<ul>
<li>高度の設定内容</li>
</ul>
<table>
<thead>
<tr>
<th>項目</th>
<th>詳細</th>
<th>内容（デフォルト）</th>
</tr>
</thead>
<tbody>
<tr>
<td>accelerate_port</td>
<td>接続ポート番号</td>
<td>5099</td>
</tr>
<tr>
<td>accelerate_timeout</td>
<td>タイムアウト</td>
<td>30</td>
</tr>
<tr>
<td>accelerate_connect_timeout</td>
<td>接続タイムアウト</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>上記は設定できる内容の一部しかすぎない。以下のAnsible設定ファイルの全体を通して、どんなことができるのはは理解できる</p>
<p><a href="https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg" target="_blank" rel="noopener">https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg</a></p>
<p>設定ファイル内のキーワードについて不明な点があった場合、下記のURLから詳細を参照できる。</p>
<p><a href="http://docs.ansible.com/ansible/intro_configuration.html#explanation-of-values-by-section" target="_blank" rel="noopener">http://docs.ansible.com/ansible/intro_configuration.html#explanation-of-values-by-section</a></p>
<h2 id="優先順位"><a href="#優先順位" class="headerlink" title="優先順位"></a>優先順位</h2><p>設定ファイルのデフォルトのパスは/etc/ansible/ansible.cfg。Ansibleは以下の順番で設定ファイルを検索し、<strong>最初に</strong>見つけたファイルの設定内容を読み込む。</p>
<ol>
<li>ANSIBLE_CONFIG (an environment variable)</li>
<li>ansible.cfg (in the current directory)</li>
<li>.ansible.cfg (in the home directory)</li>
<li>/etc/ansible/ansible.cfg</li>
</ol>
<p>Ansible 1.5以前の順番は</p>
<ol>
<li>ansible.cfg (in the current directory)</li>
<li>ANSIBLE_CONFIG (an environment variable)</li>
<li>.ansible.cfg (in the home directory)</li>
<li>/etc/ansible/ansible.cfg</li>
</ol>
<h1 id="Host-Inventory-サーバーリスト"><a href="#Host-Inventory-サーバーリスト" class="headerlink" title="Host Inventory(サーバーリスト)"></a>Host Inventory(サーバーリスト)</h1><p>サーバーリストとは、管理対象のリモートノード情報と、カテゴリやグループなどの情報をAnsibleに教えるためのファイルである。カテゴリは自分のニーズ、ロケーション、役割などによって分類できる。</p>
<h2 id="ファイルパス"><a href="#ファイルパス" class="headerlink" title="ファイルパス"></a>ファイルパス</h2><h3 id="デフォルトのファイルパス"><a href="#デフォルトのファイルパス" class="headerlink" title="デフォルトのファイルパス"></a>デフォルトのファイルパス</h3><p><code>/etc/ansible/hosts</code></p>
<h3 id="ファイルパスの変更"><a href="#ファイルパスの変更" class="headerlink" title="ファイルパスの変更"></a>ファイルパスの変更</h3><p><code>/etc/ansible/ansible.cfg</code> の以下の部分を変更</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">inventory</span>      <span class="string">=</span> <span class="string">/etc/ansible/hosts</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<h3 id="コマンドライン上で指定"><a href="#コマンドライン上で指定" class="headerlink" title="コマンドライン上で指定"></a>コマンドライン上で指定</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i hosts site.yml</span><br></pre></td></tr></table></figure>
<p>或者参数–inventory-file</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --inventory-file hosts site.yml</span><br></pre></td></tr></table></figure>
<h2 id="サーバーのカテゴリ化"><a href="#サーバーのカテゴリ化" class="headerlink" title="サーバーのカテゴリ化"></a>サーバーのカテゴリ化</h2><p><code>[]</code>内でグループ名を書く</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mail.example.com</span></span><br><span class="line"></span><br><span class="line"><span class="string">[webservers]</span></span><br><span class="line"><span class="string">foo.example.com</span></span><br><span class="line"><span class="string">bar.example.com</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers]</span></span><br><span class="line"><span class="string">one.example.com</span></span><br><span class="line"><span class="string">two.example.com</span></span><br><span class="line"><span class="string">three.example.com</span></span><br><span class="line"></span><br><span class="line"><span class="string">[webservers]</span></span><br><span class="line"><span class="string">www[01:50].example.com</span></span><br><span class="line"></span><br><span class="line"><span class="string">[databases]</span></span><br><span class="line"><span class="string">db-[a:f].example.com</span></span><br></pre></td></tr></table></figure>
<p>グループは子グループを持つこともできる。以下の例では、southeaseグループは[usa:children]の子グループであり、atlantaとreleighは[southease:children]の子グループである。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[atlanta]</span></span><br><span class="line"><span class="string">host1</span></span><br><span class="line"><span class="string">host2</span></span><br><span class="line"></span><br><span class="line"><span class="string">[raleigh]</span></span><br><span class="line"><span class="string">host2</span></span><br><span class="line"><span class="string">host3</span></span><br><span class="line"></span><br><span class="line"><span class="string">[southeast:children]</span></span><br><span class="line"><span class="string">atlanta</span></span><br><span class="line"><span class="string">raleigh</span></span><br><span class="line"></span><br><span class="line"><span class="string">[usa:children]</span></span><br><span class="line"><span class="string">southeast</span></span><br><span class="line"><span class="string">northeast</span></span><br><span class="line"><span class="string">southwest</span></span><br><span class="line"><span class="string">northwest</span></span><br></pre></td></tr></table></figure>
<h2 id="接続パラメータと変数"><a href="#接続パラメータと変数" class="headerlink" title="接続パラメータと変数"></a>接続パラメータと変数</h2><h3 id="パラメータ"><a href="#パラメータ" class="headerlink" title="パラメータ"></a>パラメータ</h3><p>リモートノードに接続する方法とユーザを、パラメータに設定できる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[targets]</span></span><br><span class="line"></span><br><span class="line"><span class="string">localhost</span>              <span class="string">ansible_connection=local</span></span><br><span class="line"><span class="string">other1.example.com</span>     <span class="string">ansible_connection=ssh</span>        <span class="string">ansible_user=mpdehaan</span></span><br><span class="line"><span class="string">other2.example.com</span>     <span class="string">ansible_connection=ssh</span>        <span class="string">ansible_user=mdehaan</span></span><br><span class="line"></span><br><span class="line"><span class="string">[atlanta]</span></span><br><span class="line"><span class="string">host1</span> <span class="string">http_port=80</span> <span class="string">maxRequestsPerChild=808</span></span><br><span class="line"><span class="string">host2</span> <span class="string">http_port=303</span> <span class="string">maxRequestsPerChild=909</span></span><br></pre></td></tr></table></figure>
<p>指定可能なパラメータの一覧は以下を参照する。<br><a href="http://docs.ansible.com/ansible/intro_inventory.html#list-of-behavioral-inventory-parameters" target="_blank" rel="noopener">http://docs.ansible.com/ansible/intro_inventory.html#list-of-behavioral-inventory-parameters</a></p>
<h3 id="変数"><a href="#変数" class="headerlink" title="変数"></a>変数</h3><p>グループに対して変数を設定することができる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[atlanta]</span></span><br><span class="line"><span class="string">host1</span></span><br><span class="line"><span class="string">host2</span></span><br><span class="line"></span><br><span class="line"><span class="string">[atlanta:vars]</span></span><br><span class="line"><span class="string">ntp_server=ntp.atlanta.example.com</span></span><br><span class="line"><span class="string">proxy=proxy.atlanta.example.com</span></span><br></pre></td></tr></table></figure>
<h2 id="ディレクトリ構造での変数保存"><a href="#ディレクトリ構造での変数保存" class="headerlink" title="ディレクトリ構造での変数保存"></a>ディレクトリ構造での変数保存</h2><p>例えば、inventoryファイルは<code>/etc/ansible/hosts</code>の場合、関連するhostsとgroup変数は以下のディレクトリに保存できる。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/ansible/group_vars/raleigh <span class="comment"># can optionally end in '.yml', '.yaml', or '.json'</span></span><br><span class="line">/etc/ansible/group_vars/webservers</span><br><span class="line">/etc/ansible/host_vars/foosball</span><br></pre></td></tr></table></figure>
<p><code>/etc/ansible/group_vars/raleigh</code> ファイルの内容は</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">ntp_server:</span> <span class="string">acme.example.org</span></span><br><span class="line"><span class="attr">database_server:</span> <span class="string">storage.example.org</span></span><br></pre></td></tr></table></figure>
<p>もし対応する名前はディレクトリ名の場合、Ansibleはこのディレクトリ以下のすべてのファイルの内容を読み込む。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/ansible/group_vars/raleigh/db_settings</span><br><span class="line">/etc/ansible/group_vars/raleigh/cluster_settings</span><br></pre></td></tr></table></figure>
<p><code>group_vars/</code>と<code>host_vars/</code> は<code>inventory/</code>以下または<code>playbook/</code>以下に置くことができる。もし両方(<code>inventory/</code>または<code>playbook/</code>)の下にファイルがある場合、playbook以下の配置はinventoryより<strong>優先的に</strong>読み込まれる。</p>
<h1 id="Ansibleのスクリプト-Playbook"><a href="#Ansibleのスクリプト-Playbook" class="headerlink" title="Ansibleのスクリプト(Playbook)"></a>Ansibleのスクリプト(Playbook)</h1><h2 id="フォーマット"><a href="#フォーマット" class="headerlink" title="フォーマット"></a>フォーマット</h2><p>AnsibleのスクリプトはYAML形式を利用している。Playbookを書く前に既存のPlaybookを参考したほうが効率良く作成することができる効率。</p>
<h3 id="オフィシャルの例"><a href="#オフィシャルの例" class="headerlink" title="オフィシャルの例"></a>オフィシャルの例</h3><p>Ansibleの公式Githubリポジトリに存在するテスト済みのPlaybookをシェアしている。</p>
<p><a href="https://github.com/ansible/ansible-examples" target="_blank" rel="noopener">https://github.com/ansible/ansible-examples</a></p>
<h3 id="他のユーザがシェアしたPlaybook"><a href="#他のユーザがシェアしたPlaybook" class="headerlink" title="他のユーザがシェアしたPlaybook"></a>他のユーザがシェアしたPlaybook</h3><p>「Ansible Galaxy」というPlaybookをシェアするためのサイトがある。このサイトにある例はユーザが自分でアップロードしたもので、Playbookの勉強や参考にするとは良いが、実際に利用する前には必ずテストが必要である。</p>
<p><a href="https://galaxy.ansible.com/" target="_blank" rel="noopener">https://galaxy.ansible.com/</a></p>
<h2 id="Playbookの基本"><a href="#Playbookの基本" class="headerlink" title="Playbookの基本"></a>Playbookの基本</h2><p>本節ではPlaybookを書くための基本を説明する。</p>
<h3 id="Playbookの実行"><a href="#Playbookの実行" class="headerlink" title="Playbookの実行"></a>Playbookの実行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook deploy.yml</span><br></pre></td></tr></table></figure>
<p>詳細な実行ログを出力</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook playbook.yml  --verbose</span><br></pre></td></tr></table></figure>
<p>影響するリモートノードの一覧</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook playbook.yml --list-hosts</span><br></pre></td></tr></table></figure>
<p>スクリプトを並行に実行する</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook playbook.yml -f 10</span><br></pre></td></tr></table></figure>
<h3 id="簡単なPlaybookの例"><a href="#簡単なPlaybookの例" class="headerlink" title="簡単なPlaybookの例"></a>簡単なPlaybookの例</h3><p>基本のplaybookのスクリプトの例では、以下三つの部分がある。</p>
<ol>
<li>どのサーバー上にどのユーザで実行<ol>
<li>hosts</li>
<li>users</li>
</ol>
</li>
<li>実行するタスク<ol>
<li>tasks</li>
</ol>
</li>
<li>イベントハンドル<ol>
<li>handles</li>
</ol>
</li>
</ol>
<p><code>deploy.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    http_port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    max_clients:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">pkg=httpd</span> <span class="string">state=latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=/srv/httpd.j2</span> <span class="string">dest=/etc/httpd.conf</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<h4 id="対象サーバと実行ユーザ（hostsとuser）"><a href="#対象サーバと実行ユーザ（hostsとuser）" class="headerlink" title="対象サーバと実行ユーザ（hostsとuser）"></a>対象サーバと実行ユーザ（hostsとuser）</h4><table>
<thead>
<tr>
<th>key</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>hosts</td>
<td>リモートサーバーのIPアドレス、ホスト名、グループ名。またはallキーワードですべてのリモートノードを指定</td>
</tr>
<tr>
<td>user</td>
<td>リモートサーバー上で実行するユーザ名</td>
</tr>
<tr>
<td>become</td>
<td>他のユーザに切り替えて実行する、値は yes または no</td>
</tr>
<tr>
<td>become_method</td>
<td>becomeと一緒に利用、‘sudo’ / ’su’ / ’pbrun’ / ’pfexec’ / ’doas’などを指定</td>
</tr>
<tr>
<td>become_user</td>
<td>becomeと一緒に利用、rootまたは他のユーザ名</td>
</tr>
</tbody>
</table>
<p>スクリプト上でbecomeを利用する時、–ask-become-passを追加することで、playbook実行後にsudoパスワードを入力することが要求される。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook deploy.yml --ask-become-pass</span><br></pre></td></tr></table></figure>
<h3 id="実行するタスク-Tasks"><a href="#実行するタスク-Tasks" class="headerlink" title="実行するタスク(Tasks)"></a>実行するタスク(Tasks)</h3><ul>
<li>タスクはPlaybookの上から下まで実行する。途中でエラーが発生した場合、Playbookの実行が中止される。スクリプトファイルを修正した後、再度スクリプトを実行する。</li>
<li>各taskはモジュールの読み出しであり、パラメータと変数を適切に設定する。</li>
<li>各taskはname 属性を持ったほうが、人間にとって理解しやすくなる。name属性は内容を出力するだけで、実行の進捗をユーザに提示することができる。</li>
</ul>
<h4 id="構文"><a href="#構文" class="headerlink" title="構文"></a>構文</h4><p>Tasksの基本構文を以下に示す。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">make</span> <span class="string">sure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=running</span></span><br></pre></td></tr></table></figure>
<p>name変数は必須ではないので、上記の例を下記のように記載することもできる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - service:</span> <span class="string">name=httpd</span> <span class="string">state=running</span></span><br></pre></td></tr></table></figure>
<p>name変数が書かれた場合、Playbookがこのタスクを実行する時に、name変数の内容が出力されスクリプトの進捗が分かりやすくなる。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TASK: [make sure apache is running] *************************************************************</span><br><span class="line">changed: [yourhost]</span><br></pre></td></tr></table></figure>
<p>Name変数が書かれていない場合、taskのモジュール実行の構文がそのまま出力される。複数のモジュールが使われている場合、スクリプトの進捗が分からなくなる。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TASK: [service name=httpd state=running] **************************************</span><br><span class="line">changed: [yourhost]</span><br></pre></td></tr></table></figure>
<h4 id="変数の渡し方"><a href="#変数の渡し方" class="headerlink" title="変数の渡し方"></a>変数の渡し方</h4><p>上記の構文の例では、モジュールに変数を渡す方法を示している：<code>key=value</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">make</span> <span class="string">sure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=running</span></span><br></pre></td></tr></table></figure>
<p>変数が多い場合、改行して複数行に書くこともできる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Copy</span> <span class="string">ansible</span> <span class="string">inventory</span> <span class="string">file</span> <span class="string">to</span> <span class="string">client</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/etc/ansible/hosts</span> <span class="string">dest=/etc/ansible/hosts</span></span><br><span class="line">            <span class="string">owner=root</span> <span class="string">group=root</span> <span class="string">mode=0644</span></span><br></pre></td></tr></table></figure>
<p>またはYAMLのハッシュ形式でパラメータを入力する。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Copy</span> <span class="string">ansible</span> <span class="string">inventory</span> <span class="string">file</span> <span class="string">to</span> <span class="string">client</span></span><br><span class="line"><span class="attr">    copy:</span></span><br><span class="line"><span class="attr">      src:</span> <span class="string">/etc/ansible/hosts</span></span><br><span class="line"><span class="attr">      dest:</span> <span class="string">/etc/ansible/hosts</span></span><br><span class="line"><span class="attr">      owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="number">0644</span></span><br></pre></td></tr></table></figure>
<h4 id="実行状態"><a href="#実行状態" class="headerlink" title="実行状態"></a>実行状態</h4><p>タスク内の各actionは一つのモジュールを実行し、最初にリモートノードの状態を確認し、実行が必要かどうかを判断する。</p>
<ul>
<li>モジュールが実行された場合、モジュールからactionへの戻り値は changed になる。</li>
<li>実行が必要ないと判断した時、モジュールからactionへの戻り値は OK になる。</li>
</ul>
<p>実行必要性の判断は各モジュール内で決めている。例えば、copy モジュールの判断方式は、ファイルのchecksum値を比較する。copyモジュールのコードを以下に示す。</p>
<p><a href="https://github.com/ansible/ansible-modules-core/blob/devel/files/copy.py" target="_blank" rel="noopener">https://github.com/ansible/ansible-modules-core/blob/devel/files/copy.py</a></p>
<p>以下のように、copyモジュールを例にする</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr"> - name:</span> <span class="string">Copy</span> <span class="string">the</span> <span class="string">/etc/hosts</span></span><br><span class="line"><span class="attr">   copy:</span> <span class="string">src=/etc/hosts</span> <span class="string">dest=/etc/hosts</span></span><br></pre></td></tr></table></figure>
<p>最初に実行する時に、TASKの状態がchangedになっている。</p>
<p><img src="https://raw.githubusercontent.com/xibuka/git_pics/master/ansible_3.png" alt="servers"></p>
<p>2回目実行すると、コピー元とコピー先のファイルが同じのめ、コピー作業が必要ないと判断し実行されていない。TASKの状態がOKになっている。</p>
<p><img src="https://raw.githubusercontent.com/xibuka/git_pics/master/ansible_4.png" alt="servers"></p>
<p>リモートノードvm-rhel7-1上の/etc/hostsファイルを変更した後、もう一度実行すると、vm-rhel7-1のみファイルがコピーされ、TASKの状態がchangedになる。</p>
<p><img src="https://raw.githubusercontent.com/xibuka/git_pics/master/ansible_5.png" alt="servers"></p>
<h3 id="イベントハンドラ-handler"><a href="#イベントハンドラ-handler" class="headerlink" title="イベントハンドラ(handler)"></a>イベントハンドラ(handler)</h3><h4 id="定義"><a href="#定義" class="headerlink" title="定義"></a>定義</h4><p>一般的なプログラミング言語にevent処理があるように、handleとはplaybookスクリプトでのevent処理である。</p>
<p>tasksと似ていて、Handlers内の各handlerはモジュールを一回実行している。ただ、tasksと異なっている部分は、tasksは書かれた順によって実行されるが、handlersはtasks内に呼び出す(notify)時のみ実行される。</p>
<p>また、tasksが実行された後、changedまたはOKの状態になっていて、handlerはtasks実行後状態がchangedの時のみ実行される。</p>
<h4 id="役割"><a href="#役割" class="headerlink" title="役割"></a>役割</h4><p>もしtasksの中にapachの設定ファイルを変更した後、apacheを再起動する必要がある。そのほかにapache のプラグインをインストールした後にも、apacheを再起動する必要がある。この場合、「apacheを再起動する」ことは、handlerとして実行することができる。</p>
<p>handlerは全てのタスクが実行した後に実行する。複数のtasksに呼び出されても、handlerは一回のみ実行する。以下の例では、handlerは一回のみ実行される。<br><a href="https://github.com/ansible-book/ansible-first-book-examples/blob/master/handlers_state.yml" target="_blank" rel="noopener">https://github.com/ansible-book/ansible-first-book-examples/blob/master/handlers_state.yml</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">lb</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">      random_number1:</span> <span class="string">"\&#123;\&#123; 10000 | random \&#125;\&#125;"</span></span><br><span class="line"><span class="attr">      random_number2:</span> <span class="string">"\&#123;\&#123; 10000000000 | random \&#125;\&#125;"</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Copy</span> <span class="string">the</span> <span class="string">/etc/hosts</span> <span class="string">to</span> <span class="string">/tmp/hosts.\&#123;\&#123;</span> <span class="string">random_number1</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/etc/hosts</span> <span class="string">dest=/tmp/hosts.\&#123;\&#123;</span> <span class="string">random_number1</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">call</span> <span class="string">in</span> <span class="string">every</span> <span class="string">action</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Copy</span> <span class="string">the</span> <span class="string">/etc/hosts</span> <span class="string">to</span> <span class="string">/tmp/hosts.\&#123;\&#123;</span> <span class="string">random_number2</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/etc/hosts</span> <span class="string">dest=/tmp/hosts.\&#123;\&#123;</span> <span class="string">random_number2</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">call</span> <span class="string">in</span> <span class="string">every</span> <span class="string">action</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">call</span> <span class="string">in</span> <span class="string">every</span> <span class="string">action</span></span><br><span class="line"><span class="attr">    debug:</span> <span class="string">msg="call</span> <span class="string">in</span> <span class="string">every</span> <span class="string">action,</span> <span class="string">but</span> <span class="string">execute</span> <span class="string">only</span> <span class="string">one</span> <span class="string">time"</span></span><br></pre></td></tr></table></figure>
<p>tasksのactionの実行状態がchangedの場合のみ、handlerが呼び出されて(notify)実行される。下記のスクリプトが2回実行された時、実行結果が異る。</p>
<ul>
<li>1回目実行の時、tasksの状態が両方changedのため、二つのhandlerが実行される。</li>
<li>2回目実行の時、<ul>
<li>1つ目のtaskの状態がOKのため、”call by /tmp/hosts”handlerが実行されない。</li>
<li>2つ目のtaskの状態がchangedのため、”call by /tmp/hosts.random_number” handlerが実行される</li>
</ul>
</li>
</ul>
<p>テストのコードを以下を参照する。<br><a href="https://github.com/shijingjing1221/ansible-first-book-examples/blob/master/handlers_execution_time.yml" target="_blank" rel="noopener">https://github.com/shijingjing1221/ansible-first-book-examples/blob/master/handlers_execution_time.yml</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">lb</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">      random_number:</span> <span class="string">"\&#123;\&#123; 10000 | random \&#125;\&#125;"</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Copy</span> <span class="string">the</span> <span class="string">/etc/hosts</span> <span class="string">to</span> <span class="string">/tmp/hosts</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/etc/hosts</span> <span class="string">dest=/tmp/hosts</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">call</span> <span class="string">by</span> <span class="string">/tmp/hosts</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Copy</span> <span class="string">the</span> <span class="string">/etc/hosts</span> <span class="string">to</span> <span class="string">/tmp/hosts.\&#123;\&#123;</span> <span class="string">random_number</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/etc/hosts</span> <span class="string">dest=/tmp/hosts.\&#123;\&#123;</span> <span class="string">random_number</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">call</span> <span class="string">by</span> <span class="string">/tmp/hosts.random_number</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">call</span> <span class="string">by</span> <span class="string">/tmp/hosts</span></span><br><span class="line"><span class="attr">    debug:</span> <span class="string">msg="call</span> <span class="string">first</span> <span class="string">time"</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">call</span> <span class="string">by</span> <span class="string">/tmp/hosts.random_number</span></span><br><span class="line"><span class="attr">    debug:</span> <span class="string">msg="call</span> <span class="string">by</span> <span class="string">/tmp/hosts.random_number"</span></span><br></pre></td></tr></table></figure>
<p>handlersはnotifyされる順番ではなく、定義された順番で実行される。下記の例では、定義の順番が1&gt;2&gt;3であり、notifyの順番が3&gt;2&gt;1であっても、実際の実行順番が1&gt;2&gt;3になる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">lb</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">      random_number1:</span> <span class="string">"\&#123;\&#123; 10000 | random \&#125;\&#125;"</span></span><br><span class="line"><span class="attr">      random_number2:</span> <span class="string">"\&#123;\&#123; 10000000000 | random \&#125;\&#125;"</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Copy</span> <span class="string">the</span> <span class="string">/etc/hosts</span> <span class="string">to</span> <span class="string">/tmp/hosts.\&#123;\&#123;</span> <span class="string">random_number1</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/etc/hosts</span> <span class="string">dest=/tmp/hosts.\&#123;\&#123;</span> <span class="string">random_number1</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">define</span> <span class="string">the</span> <span class="number">3</span><span class="string">nd</span> <span class="string">handler</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Copy</span> <span class="string">the</span> <span class="string">/etc/hosts</span> <span class="string">to</span> <span class="string">/tmp/hosts.\&#123;\&#123;</span> <span class="string">random_number2</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/etc/hosts</span> <span class="string">dest=/tmp/hosts.\&#123;\&#123;</span> <span class="string">random_number2</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">define</span> <span class="string">the</span> <span class="number">2</span><span class="string">nd</span> <span class="string">handler</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">define</span> <span class="string">the</span> <span class="number">1</span><span class="string">nd</span> <span class="string">handler</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">define</span> <span class="string">the</span> <span class="number">1</span><span class="string">nd</span> <span class="string">handler</span></span><br><span class="line"><span class="attr">    debug:</span> <span class="string">msg="define</span> <span class="string">the</span> <span class="number">1</span><span class="string">nd</span> <span class="string">handler"</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">define</span> <span class="string">the</span> <span class="number">2</span><span class="string">nd</span> <span class="string">handler</span></span><br><span class="line"><span class="attr">    debug:</span> <span class="string">msg="define</span> <span class="string">the</span> <span class="number">2</span><span class="string">nd</span> <span class="string">handler"</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">define</span> <span class="string">the</span> <span class="number">3</span><span class="string">nd</span> <span class="string">handler</span></span><br><span class="line"><span class="attr">    debug:</span> <span class="string">msg="define</span> <span class="string">the</span> <span class="number">3</span><span class="string">nd</span> <span class="string">handler"</span></span><br></pre></td></tr></table></figure>
<h2 id="Playbookで利用可能な変数"><a href="#Playbookで利用可能な変数" class="headerlink" title="Playbookで利用可能な変数"></a>Playbookで利用可能な変数</h2><p>本節では、よく使う幾つかの変数を紹介する。次の章からは、複雑な場面での変数の使い方などを紹介する。</p>
<p>一般的に、Playbookで利用できる変数は以下になる。</p>
<ol>
<li>Playbook中ユーザが定義する変数</li>
<li>ユーザが定義する必要がなく, AnsibleがPlaybookを実行する前に収集したリモートノードのシステム情報として使える変数</li>
<li>テンプレートでは上記 2つ種類の変数が直接利用できる。</li>
<li>taskの実行結果を変数として使える。この変数は&lt;register変数&gt;となる</li>
<li>Playbookをもっと汎用性高く、動的に使いやすくするために、ユーザが実行中に変数を入力することができる。この変数は&lt;extra変数&gt;となる</li>
</ol>
<h3 id="Playbook中で定義した変数"><a href="#Playbook中で定義した変数" class="headerlink" title="Playbook中で定義した変数"></a>Playbook中で定義した変数</h3><p>ユーザはPlaybook中に、varsキーワードで変数を定義することができる。使用する時は<code>\{\{\}\}</code>で囲んで利用する。下記の例では、ユーザがhttp_port変数を定義し、80と設定している。tasks firewalldの中で、<code>\{\{ http_port \}\}</code>で内容を読み込んでいる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    http_port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">insert</span> <span class="string">firewalld</span> <span class="string">rule</span> <span class="string">for</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    firewalld:</span> <span class="string">port=\&#123;\&#123;</span> <span class="string">http_port</span> <span class="string">\&#125;\&#125;/tcp</span> <span class="string">permanent=true</span> <span class="string">state=enabled</span> <span class="string">immediate=yes</span></span><br></pre></td></tr></table></figure>
<h4 id="変数を単独ファイルに置く"><a href="#変数を単独ファイルに置く" class="headerlink" title="変数を単独ファイルに置く"></a>変数を単独ファイルに置く</h4><p>変数が多い時、または複数のPlaybook中に共用されたい時に、変数を単独の変数ファイルに置くことができる。var_filesパラメータに該当する変数ファイル名を設定すると、同じ使い方で変数を参照できる。</p>
<p><code>Playbook</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars_files:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">vars/server_vars.yml</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">insert</span> <span class="string">firewalld</span> <span class="string">rule</span> <span class="string">for</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    firewalld:</span> <span class="string">port=\&#123;\&#123;</span> <span class="string">http_port</span> <span class="string">\&#125;\&#125;/tcp</span> <span class="string">permanent=true</span> <span class="string">state=enabled</span> <span class="string">immediate=yes</span></span><br></pre></td></tr></table></figure>
<p><code>vars/server_vars.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http_port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<h4 id="複雑変数の扱い方"><a href="#複雑変数の扱い方" class="headerlink" title="複雑変数の扱い方"></a>複雑変数の扱い方</h4><p>利用したい変数は簡単な文字列や数字ではなく、一つのオブジェクトにしたい時がある。その時に以下のようなYAMLのハッシュ形式(または辞書形式)にオブジェクトの内容を設定する。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">foo:</span></span><br><span class="line"><span class="attr">  field1:</span> <span class="string">one</span></span><br><span class="line"><span class="attr">  field2:</span> <span class="string">two</span></span><br></pre></td></tr></table></figure>
<p>こちらの変数を利用したい時は、中括弧またはピリオドで参照できる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">foo['field1']</span></span><br><span class="line"><span class="string">foo.field1</span></span><br></pre></td></tr></table></figure>
<h4 id="YAMLの落とし穴"><a href="#YAMLの落とし穴" class="headerlink" title="YAMLの落とし穴"></a>YAMLの落とし穴</h4><p>YAMLの変数構文がAnsibleの変数構文と一緒に書くと構文エラーになる場合がある。詳細については、コロン(:)の後ろにすぐ大括弧 { を書くことはできなく、かならずダブルクォーテーション “ で囲む必要がある。もしエラー内容が YAMLの構文エラーの場合、ダブルクォーテーション “ を追加して解決する。</p>
<p>このYAMLは構文エラーになる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">app_servers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">      app_path:</span> <span class="string">\&#123;\&#123;</span> <span class="string">base_path</span> <span class="string">\&#125;\&#125;/22</span></span><br></pre></td></tr></table></figure>
<p>解決方法は、変数の前後にダブルクォーテーションを追加する。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">app_servers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">       app_path:</span> <span class="string">"\&#123;\&#123; base_path \&#125;\&#125;/22"</span></span><br></pre></td></tr></table></figure>
<h3 id="システム変数-facts"><a href="#システム変数-facts" class="headerlink" title="システム変数(facts)"></a>システム変数(facts)</h3><p>Ansibleはsetup モジュールを通じてリモートノードのシステム情報を収集している。こちらのシステム情報はfactsと呼び、直接変数として利用することができる。<br>コマンドラインからsetupモジュールを実行して利用可能な変数の一覧が確認できる。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m setup -u root</span><br></pre></td></tr></table></figure>
<p>Playbookの中では、facts変数を直接利用することができる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">echo</span> <span class="string">system</span></span><br><span class="line"><span class="attr">    shell:</span> <span class="string">echo</span> <span class="string">\&#123;\&#123;</span> <span class="string">ansible_os_family</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">name</span> <span class="string">install</span> <span class="string">ntp</span> <span class="string">on</span> <span class="string">Debian</span> <span class="string">linux</span></span><br><span class="line"><span class="attr">    apt:</span> <span class="string">name=git</span> <span class="string">state=installed</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"Debian"</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">name</span> <span class="string">install</span> <span class="string">ntp</span> <span class="string">on</span> <span class="string">redhat</span> <span class="string">linux</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=git</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"RedHat"</span></span><br></pre></td></tr></table></figure>
<h4 id="複雑なfacts変数"><a href="#複雑なfacts変数" class="headerlink" title="複雑なfacts変数"></a>複雑なfacts変数</h4><p>一般変数と同じく、以下のようなハッシュ変数形式のfacts変数も存在する。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">        "ansible_ens3": &#123;</span><br><span class="line">            "active": true,</span><br><span class="line">            "device": "ens3",</span><br><span class="line">            "ipv4": &#123;</span><br><span class="line">                "address": "10.66.192.234",</span><br><span class="line">                "netmask": "255.255.254.0",</span><br><span class="line">                "network": "10.66.192.0"</span><br><span class="line">            &#125;,</span><br><span class="line">            "ipv6": [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"address"</span>: <span class="string">"2620:52:0:42c0:5054:ff:fef2:e2a3"</span>,</span><br><span class="line">                    <span class="attr">"prefix"</span>: <span class="string">"64"</span>,</span><br><span class="line">                    <span class="attr">"scope"</span>: <span class="string">"global"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"address"</span>: <span class="string">"fe80::5054:ff:fef2:e2a3"</span>,</span><br><span class="line">                    <span class="attr">"prefix"</span>: <span class="string">"64"</span>,</span><br><span class="line">                    <span class="attr">"scope"</span>: <span class="string">"link"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            "macaddress": "52:54:00:f2:e2:a3",</span><br><span class="line">            "module": "8139cp",</span><br><span class="line">            "mtu": 1500,</span><br><span class="line">            "promisc": false,</span><br><span class="line">            "type": "ether"</span><br><span class="line">        &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>以下の二つの方法でハッシュ形式のfacts変数の属性を参照する。</p>
<ul>
<li>中括弧</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">\&#123;\&#123;</span> <span class="string">ansible_ens3["ipv4"]["address"]</span> <span class="string">\&#125;\&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ピリオド</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">\&#123;\&#123;</span> <span class="string">ansible_ens3.ipv4.address</span> <span class="string">\&#125;\&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="factsの無効化"><a href="#factsの無効化" class="headerlink" title="factsの無効化"></a>factsの無効化</h4><p>Playbookでは、gather_factsパラメータがfacts変数の収集を設定できる。下記のように no と設定すると、上記のfacts変数はこのPlaybookでの利用ができなくなる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">whatever</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">no</span></span><br></pre></td></tr></table></figure>
<h3 id="テンプレートで定義した変数"><a href="#テンプレートで定義した変数" class="headerlink" title="テンプレートで定義した変数"></a>テンプレートで定義した変数</h3><p>テンプレートはAnsibleでよく使われているため、テンプレートファイルでの変数の使い方を説明する。</p>
<h4 id="変数の定義"><a href="#変数の定義" class="headerlink" title="変数の定義"></a>変数の定義</h4><p>Playbook内で定義した変数、factsシステム変数、inventory内で定義したhostとgroup変数は、直接テンプレートで利用できる。Playbook内で利用できる変数は、テンプレートファイルでも利用できる。</p>
<p>下記のPlaybookスクリプトではtemplate モジュールでindex.html.j2ファイルをコピーし、その中の変数をPlaybookで定義した変数の値に設定する。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    http_port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    defined_name:</span> <span class="string">"Hello My name is Jingjng"</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">pkg=httpd</span> <span class="string">state=latest</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Write</span> <span class="string">the</span> <span class="string">configuration</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=templates/httpd.conf.j2</span> <span class="string">dest=/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Write</span> <span class="string">the</span> <span class="string">default</span> <span class="string">index.html</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=templates/index2.html.j2</span> <span class="string">dest=/var/www/html/index.html</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">insert</span> <span class="string">firewalld</span> <span class="string">rule</span> <span class="string">for</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    firewalld:</span> <span class="string">port=\&#123;\&#123;</span> <span class="string">http_port</span> <span class="string">\&#125;\&#125;/tcp</span> <span class="string">permanent=true</span> <span class="string">state=enabled</span> <span class="string">immediate=yes</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<h4 id="変数の利用"><a href="#変数の利用" class="headerlink" title="変数の利用"></a>変数の利用</h4><p>Ansibleのテンプレートファイルが利用する構文はPython のテンプレート言語Jinja2。下記のテンプレートの例index.html.j2の中で、変数を直接利用している。</p>
<ul>
<li>システム変数 <code>\{\{ ansible_hostname \}\}</code>, <code>\{\{ ansible_default_ipv4.address \}\}</code></li>
<li>ユーザ定義した変数 <code>\{\{ defined_name \}\}</code></li>
</ul>
<p>Index.html.j2ファイルの内容</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"block"</span> <span class="attr">style</span>=<span class="string">"height: 99%;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"centered"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>#46 Demo \&#123;\&#123; defined_name \&#125;\&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>Served by \&#123;\&#123; ansible_hostname \&#125;\&#125; (\&#123;\&#123; ansible_default_ipv4.address \&#125;\&#125;).<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="タスクの実行結果を変数に設定"><a href="#タスクの実行結果を変数に設定" class="headerlink" title="タスクの実行結果を変数に設定"></a>タスクの実行結果を変数に設定</h3><p>taskの実行結果は変数の値に代入できる。この場合はregisterキーワードを利用し、taskの実行結果を変数に設定し、その後にあるactionに利用される。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">web</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">     - shell:</span> <span class="string">ls</span></span><br><span class="line"><span class="attr">       register:</span> <span class="string">result</span></span><br><span class="line"><span class="attr">       ignore_errors:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">     - shell:</span> <span class="string">echo</span> <span class="string">"\&#123;\&#123; result.stdout \&#125;\&#125;"</span></span><br><span class="line"><span class="attr">       when:</span> <span class="string">result.rc</span> <span class="string">==</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="attr">     - debug:</span> <span class="string">msg="\&#123;\&#123;</span> <span class="string">result.stdout</span> <span class="string">\&#125;\&#125;"</span></span><br></pre></td></tr></table></figure>
<p>Register変数はよくdebug モジュールと一緒に利用され、actionの実行の詳細情報を得てトラブルシュッティングに役立つ。</p>
<h3 id="コマンドラインで変数を渡す"><a href="#コマンドラインで変数を渡す" class="headerlink" title="コマンドラインで変数を渡す"></a>コマンドラインで変数を渡す</h3><p>汎用性と便利性のため、コマンドラインでPlaybookに変数の値を渡すことができる。この場合はansible-playbookの–extra-varsオプションを利用する。</p>
<h4 id="コマンドライン変数の定義"><a href="#コマンドライン変数の定義" class="headerlink" title="コマンドライン変数の定義"></a>コマンドライン変数の定義</h4><p>下記のように、release.ymlファイルでは、hostsとuserは変数として定義され、コマンドラインから値を設定する必要がある。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">'\&#123;\&#123; hosts \&#125;\&#125;'</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">'\&#123;\&#123; user \&#125;\&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">...</span></span><br></pre></td></tr></table></figure>
<h4 id="コマンドライン変数の利用"><a href="#コマンドライン変数の利用" class="headerlink" title="コマンドライン変数の利用"></a>コマンドライン変数の利用</h4><p>以下のようにコマンドラインから変数の値を設定する。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook e33_var_in_command.yml --extra-vars <span class="string">"hosts=web user=root"</span></span><br></pre></td></tr></table></figure>
<p>そのほかに、JSON形式でも利用できる。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook e33_var_in_command.yml --extra-vars <span class="string">"&#123;'hosts':'vm-rhel7-1', 'user':'root'&#125;"</span></span><br></pre></td></tr></table></figure>
<p>また、変数と値をJSONファイルに書いて、コマンドラインに渡すこともできる。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook e33_var_in_command.yml --extra-vars <span class="string">"@vars.json"</span></span><br></pre></td></tr></table></figure>
<h2 id="条件判断、ループとブロック"><a href="#条件判断、ループとブロック" class="headerlink" title="条件判断、ループとブロック"></a>条件判断、ループとブロック</h2><ul>
<li>when： 条件判断のキーワード。ifに似ている</li>
<li>loop：循環処理（ループ）のキーワード。forに似ている</li>
<li>block：複数のtasksを一つのブロックにまとめて、異常処理の対応などに利用できる。</li>
</ul>
<h3 id="条件判断-when"><a href="#条件判断-when" class="headerlink" title="条件判断(when)"></a>条件判断(when)</h3><p>例えば、特定のversionのシステム上にパッケージをインストールや、ディスク空き容量がない時にファイルを削除するなど、特定の条件に満足している時のみ、特定のtaskを実行したい場合、Playbook内のwhenを利用する。<br>サーバーがDebian Linuxの場合すぐシャットダウンする</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"shutdown Debian flavored systems"</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">/sbin/shutdown</span> <span class="bullet">-t</span> <span class="string">now</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"Debian"</span></span><br></pre></td></tr></table></figure>
<p>actionの実行結果によって、次に実行するactionを決める</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - command:</span> <span class="string">/bin/false</span></span><br><span class="line"><span class="attr">    register:</span> <span class="string">result</span></span><br><span class="line"><span class="attr">    ignore_errors:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">  - command:</span> <span class="string">/bin/something</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">result|failed</span></span><br><span class="line"><span class="attr">  - command:</span> <span class="string">/bin/something_else</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">result|success</span></span><br><span class="line"><span class="attr">  - command:</span> <span class="string">/bin/still/something_else</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">result|skipped</span></span><br></pre></td></tr></table></figure>
<p>リモートノードのシステム変数factsも 条件としてwhenに判断されることができる。また、| intの書き方で返り値の型変換もできる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - debug:</span> <span class="string">msg="only</span> <span class="string">on</span> <span class="string">Red</span> <span class="string">Hat</span> <span class="number">7</span><span class="string">,</span> <span class="string">derivatives,</span> <span class="string">and</span> <span class="string">later"</span></span><br><span class="line"><span class="attr">      when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"RedHat"</span> <span class="string">and</span> <span class="string">ansible_lsb.major_release|int</span> <span class="string">&gt;=</span> <span class="number">6</span></span><br></pre></td></tr></table></figure>
<h4 id="条件式"><a href="#条件式" class="headerlink" title="条件式"></a>条件式</h4><p>真偽（True/False）判断の条件式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vars:</span></span><br><span class="line"><span class="attr">  epic:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">    - shell:</span> <span class="string">echo</span> <span class="string">"This certainly is epic!"</span></span><br><span class="line"><span class="attr">      when:</span> <span class="string">epic</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">    - shell:</span> <span class="string">echo</span> <span class="string">"This certainly isn’t epic!"</span></span><br><span class="line"><span class="attr">      when:</span> <span class="string">not</span> <span class="string">epic</span></span><br></pre></td></tr></table></figure>
<p>定義有り無し判断の条件式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">    - shell:</span> <span class="string">echo</span> <span class="string">"I've got '\&#123;\&#123; foo \&#125;\&#125;' and am not afraid to use it!"</span></span><br><span class="line"><span class="attr">      when:</span> <span class="string">foo</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - fail:</span> <span class="string">msg="Bailing</span> <span class="string">out.</span> <span class="string">this</span> <span class="string">play</span> <span class="string">requires</span> <span class="string">'bar'</span><span class="string">"</span></span><br><span class="line"><span class="string">      when: bar is not defined</span></span><br></pre></td></tr></table></figure>
<p>数値に対する条件式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">    - command:</span> <span class="string">echo</span> <span class="string">\&#123;\&#123;</span> <span class="string">item</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="attr">      with_items:</span> <span class="string">[</span> <span class="number">0</span><span class="string">,</span> <span class="number">2</span><span class="string">,</span> <span class="number">4</span><span class="string">,</span> <span class="number">6</span><span class="string">,</span> <span class="number">8</span><span class="string">,</span> <span class="number">10</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      when:</span> <span class="string">item</span> <span class="string">&gt; 5</span></span><br></pre></td></tr></table></figure>
<p>includeと一緒に利用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- include:</span> <span class="string">tasks/sometasks.yml</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">"'reticulating splines' in output"</span></span><br></pre></td></tr></table></figure>
<p>Roleと一緒に利用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">debian_stock_config,</span> <span class="attr">when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">'Debian'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="循環処理-loop"><a href="#循環処理-loop" class="headerlink" title="循環処理(loop)"></a>循環処理(loop)</h3><h4 id="標準のループ-with-items"><a href="#標準のループ-with-items" class="headerlink" title="標準のループ(with_items)"></a>標準のループ(with_items)</h4><p>コードの読み易さと簡潔のため、重複のタスク内容を以下のように書くことができる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">several</span> <span class="string">users</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=\&#123;\&#123;</span> <span class="string">item</span> <span class="string">\&#125;\&#125;</span> <span class="string">state=present</span> <span class="string">groups=wheel</span></span><br><span class="line"><span class="attr">  with_items:</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">testuser1</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">testuser2</span></span><br></pre></td></tr></table></figure>
<p>変数ファイルまたはPlaybookのvarsでYAMLリストを定義した場合、下記のように処理をループすることができる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vars:</span></span><br><span class="line"><span class="attr">  somelist:</span> <span class="string">["testuser1",</span> <span class="string">"testuser2"</span><span class="string">]</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  -name:</span> <span class="string">add</span> <span class="string">several</span> <span class="string">user</span></span><br><span class="line"><span class="attr">   user:</span> <span class="string">name=\&#123;\&#123;</span> <span class="string">item</span> <span class="string">\&#125;\&#125;</span> <span class="string">state=present</span> <span class="string">groups=wheel</span></span><br><span class="line"><span class="attr">   with_items:</span> <span class="string">"\&#123;\&#123;somelist\&#125;\&#125;"</span></span><br></pre></td></tr></table></figure>
<p>with_itemsキーワードで操作できるのは簡単なデータだけではなく、ハッシュ型（辞書型）の変数の値もループできる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">several</span> <span class="string">users</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=\&#123;\&#123;</span> <span class="string">item.name</span> <span class="string">\&#125;\&#125;</span> <span class="string">state=present</span> <span class="string">groups=\&#123;\&#123;</span> <span class="string">item.groups</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="attr">  with_items:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'testuser1'</span><span class="string">,</span> <span class="attr">groups:</span> <span class="string">'wheel'</span> <span class="string">&#125;</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'testuser2'</span><span class="string">,</span> <span class="attr">groups:</span> <span class="string">'root'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>注意：whenとwith_items（または他のループ）を同時に使用する場合、ループの各実行項目に対してwhenが条件判断を行う。</p>
<h4 id="ネストループ-with-nested"><a href="#ネストループ-with-nested" class="headerlink" title="ネストループ(with_nested)"></a>ネストループ(with_nested)</h4><p>階層形式のデータもループすることができる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">give</span> <span class="string">users</span> <span class="string">access</span> <span class="string">to</span> <span class="string">multiple</span> <span class="string">databases</span></span><br><span class="line"><span class="attr">  mysql_user:</span> <span class="string">name=\&#123;\&#123;</span> <span class="string">item[0]</span> <span class="string">\&#125;\&#125;</span> <span class="string">priv=\&#123;\&#123;</span> <span class="string">item[1]</span> <span class="string">\&#125;\&#125;.*:ALL</span> <span class="string">append_privs=yes</span> <span class="string">password=foo</span></span><br><span class="line"><span class="attr">  with_nested:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">[</span> <span class="string">'alice'</span><span class="string">,</span> <span class="string">'bob'</span> <span class="string">]</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">[</span> <span class="string">'clientdb'</span><span class="string">,</span> <span class="string">'employeedb'</span><span class="string">,</span> <span class="string">'providerd'</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>または</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">give</span> <span class="string">users</span> <span class="string">access</span> <span class="string">to</span> <span class="string">multiple</span> <span class="string">databases</span></span><br><span class="line"><span class="attr">  mysql_user:</span> <span class="string">name=\&#123;\&#123;</span> <span class="string">item.0</span> <span class="string">\&#125;\&#125;</span> <span class="string">priv=\&#123;\&#123;</span> <span class="string">item.1</span> <span class="string">\&#125;\&#125;.*:ALL</span> <span class="string">append_privs=yes</span> <span class="string">password=foo</span></span><br><span class="line"><span class="attr">  with_nested:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">[</span> <span class="string">'alice'</span><span class="string">,</span> <span class="string">'bob'</span> <span class="string">]</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">[</span> <span class="string">'clientdb'</span><span class="string">,</span> <span class="string">'employeedb'</span><span class="string">,</span> <span class="string">'providerd'</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
<h4 id="ハッシュループ-with-dict"><a href="#ハッシュループ-with-dict" class="headerlink" title="ハッシュループ(with_dict)"></a>ハッシュループ(with_dict)</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">vars:</span></span><br><span class="line"><span class="attr">  users:</span></span><br><span class="line"><span class="attr">    alice:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">Alice</span> <span class="string">Appleworth</span></span><br><span class="line"><span class="attr">      telephone:</span> <span class="number">123</span><span class="bullet">-456</span><span class="bullet">-7890</span></span><br><span class="line"><span class="attr">    bob:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">Bob</span> <span class="string">Bananarama</span></span><br><span class="line"><span class="attr">      telephone:</span> <span class="number">987</span><span class="bullet">-654</span><span class="bullet">-3210</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Print</span> <span class="string">phone</span> <span class="string">records</span></span><br><span class="line"><span class="attr">    debug:</span> <span class="string">msg="User</span> <span class="string">\&#123;\&#123;</span> <span class="string">item.key</span> <span class="string">\&#125;\&#125;</span> <span class="string">is</span> <span class="string">\&#123;\&#123;</span> <span class="string">item.value.name</span> <span class="string">\&#125;\&#125;</span> <span class="string">(\&#123;\&#123;</span> <span class="string">item.value.telephone</span> <span class="string">\&#125;\&#125;)"</span></span><br><span class="line"><span class="attr">    with_dict:</span> <span class="string">"\&#123;\&#123;users\&#125;\&#125;"</span></span><br></pre></td></tr></table></figure>
<h4 id="ファイルリストループ-with-fileglob"><a href="#ファイルリストループ-with-fileglob" class="headerlink" title="ファイルリストループ(with_fileglob)"></a>ファイルリストループ(with_fileglob)</h4><p>with_fileglobを利用し、フォルダ以下のファイルをループに代入することができる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># first ensure our target directory exists</span></span><br><span class="line"><span class="attr">    - file:</span> <span class="string">dest=/etc/fooapp</span> <span class="string">state=directory</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># copy each file over that matches the given pattern</span></span><br><span class="line"><span class="attr">    - copy:</span> <span class="string">src=\&#123;\&#123;</span> <span class="string">item</span> <span class="string">\&#125;\&#125;</span> <span class="string">dest=/etc/fooapp/</span> <span class="string">owner=root</span> <span class="string">mode=600</span></span><br><span class="line"><span class="attr">      with_fileglob:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/playbooks/files/fooapp/*</span></span><br></pre></td></tr></table></figure>
<h3 id="ブロック-block"><a href="#ブロック-block" class="headerlink" title="ブロック(block)"></a>ブロック(block)</h3><p>複数actionをブロックに纏めて、設定した条件に合致した場合、全actionが一括に実行される。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">     - block:</span></span><br><span class="line"><span class="attr">         - yum:</span> <span class="string">name=\&#123;\&#123;</span> <span class="string">item</span> <span class="string">\&#125;\&#125;</span> <span class="string">state=installed</span></span><br><span class="line"><span class="attr">           with_items:</span></span><br><span class="line"><span class="bullet">             -</span> <span class="string">httpd</span></span><br><span class="line"><span class="bullet">             -</span> <span class="string">memcached</span></span><br><span class="line"></span><br><span class="line"><span class="attr">         - template:</span> <span class="string">src=templates/src.j2</span> <span class="string">dest=/etc/foo.conf</span></span><br><span class="line"></span><br><span class="line"><span class="attr">         - service:</span> <span class="string">name=bar</span> <span class="string">state=started</span> <span class="string">enabled=True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">       when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">'CentOS'</span></span><br><span class="line"><span class="attr">       become:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">       become_user:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>
<p>異常処理をするときに、blockが便利でよく使われている。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - block:</span></span><br><span class="line"><span class="attr">      - debug:</span> <span class="string">msg='i</span> <span class="string">execute</span> <span class="string">normally'</span></span><br><span class="line"><span class="attr">      - command:</span> <span class="string">/bin/false</span></span><br><span class="line"><span class="attr">      - debug:</span> <span class="string">msg='i</span> <span class="string">never</span> <span class="string">execute,</span> <span class="string">cause</span> <span class="string">ERROR!'</span></span><br><span class="line"><span class="attr">    rescue:</span></span><br><span class="line"><span class="attr">      - debug:</span> <span class="string">msg='I</span> <span class="string">caught</span> <span class="string">an</span> <span class="string">error'</span></span><br><span class="line"><span class="attr">      - command:</span> <span class="string">/bin/false</span></span><br><span class="line"><span class="attr">      - debug:</span> <span class="string">msg='I</span> <span class="string">also</span> <span class="string">never</span> <span class="string">execute</span> <span class="string">:-('</span></span><br><span class="line"><span class="attr">    always:</span></span><br><span class="line"><span class="attr">      - debug:</span> <span class="string">msg="this</span> <span class="string">always</span> <span class="string">executes"</span></span><br></pre></td></tr></table></figure>
<h2 id="既存Playbook-の読み込む"><a href="#既存Playbook-の読み込む" class="headerlink" title="既存Playbook の読み込む"></a>既存Playbook の読み込む</h2><p>既存のPlaybookを利用することで、開発時間が節約できるし、メンテナンスもしやすくなる。他のPlaybookファイルを読み込むために、以下二つが方法がある。</p>
<ul>
<li>include:<ul>
<li>既存のPlaybook スクリプトを読み込んで利用する、簡単で利用しやすい。</li>
</ul>
</li>
<li>role:<ul>
<li>Playbookの”函数”みたいで、使い方はちょっと複雑ですが、includeより強力でいろんなことができる。Ansible Galaxyはrole方式でPlaybookをシェアしている。</li>
</ul>
</li>
</ul>
<h3 id="Playbookファイルの-include"><a href="#Playbookファイルの-include" class="headerlink" title="Playbookファイルの include"></a>Playbookファイルの include</h3><p>他のPlaybookファイルを include することで、そのファイル内のtasksが利用できる。また、includeでtasksを複数のファイルに分割することで、Playbookの肥大化を防ぐことができる。</p>
<h4 id="基本の使い方"><a href="#基本の使い方" class="headerlink" title="基本の使い方"></a>基本の使い方</h4><p>直接yamlファイルをincludeする。<br>tasks/firewall_httpd_default.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># possibly saved as tasks/firewall_httpd_default.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">insert</span> <span class="string">firewalld</span> <span class="string">rule</span> <span class="string">for</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    firewalld:</span> <span class="string">port=80/tcp</span> <span class="string">permanent=true</span> <span class="string">state=enabled</span> <span class="string">immediate=yes</span></span><br></pre></td></tr></table></figure>
<p>他のPlaybookでのinclude方法は</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">    - include:</span> <span class="string">tasks/firewall_httpd_default.yml</span></span><br></pre></td></tr></table></figure>
<h4 id="高度な使い方"><a href="#高度な使い方" class="headerlink" title="高度な使い方"></a>高度な使い方</h4><p>includeされるPlaybookの中で変数を定義することができる。下記の例では、includeされたtasks/firewall_httpd_default.ymlの中にでport変数を定義した。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">insert</span> <span class="string">firewalld</span> <span class="string">rule</span> <span class="string">for</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    firewalld:</span> <span class="string">port=\&#123;\&#123;</span> <span class="string">port</span> <span class="string">\&#125;\&#125;/tcp</span> <span class="string">permanent=true</span> <span class="string">state=enabled</span> <span class="string">immediate=yes</span></span><br></pre></td></tr></table></figure>
<p>変数の値をincludeされるPlaybookに渡すために、以下の方法がある。</p>
<h4 id="includeされるPlaybookの後ろに、変数名と値を指定"><a href="#includeされるPlaybookの後ろに、変数名と値を指定" class="headerlink" title="includeされるPlaybookの後ろに、変数名と値を指定"></a>includeされるPlaybookの後ろに、変数名と値を指定</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">   - include:</span> <span class="string">tasks/firewall.yml</span> <span class="string">port=80</span></span><br><span class="line"><span class="attr">   - include:</span> <span class="string">tasks/firewall.yml</span> <span class="string">port=3260</span></span><br><span class="line"><span class="attr">   - include:</span> <span class="string">tasks/firewall.yml</span> <span class="string">port=423</span></span><br></pre></td></tr></table></figure>
<h4 id="YAMLのハッシュ形式で変数と値を渡す"><a href="#YAMLのハッシュ形式で変数と値を渡す" class="headerlink" title="YAMLのハッシュ形式で変数と値を渡す"></a>YAMLのハッシュ形式で変数と値を渡す</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">   - include:</span> <span class="string">wordpress.yml</span></span><br><span class="line"><span class="attr">     vars:</span></span><br><span class="line"><span class="attr">         wp_user:</span> <span class="string">timmy</span></span><br><span class="line"><span class="attr">         ssh_keys:</span></span><br><span class="line"><span class="bullet">           -</span> <span class="string">keys/one.txt</span></span><br><span class="line"><span class="bullet">           -</span> <span class="string">keys/two.txt</span></span><br></pre></td></tr></table></figure>
<h4 id="taskをJSON形式に書いて、変数と値を設定する"><a href="#taskをJSON形式に書いて、変数と値を設定する" class="headerlink" title="taskをJSON形式に書いて、変数と値を設定する"></a>taskをJSON形式に書いて、変数と値を設定する</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">&#123;</span> <span class="attr">include:</span> <span class="string">wordpress.yml,</span> <span class="attr">wp_user:</span> <span class="string">timmy,</span> <span class="attr">ssh_keys:</span> <span class="string">[</span> <span class="string">'keys/one.txt'</span><span class="string">,</span> <span class="string">'keys/two.txt'</span> <span class="string">]</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="Playbook中で定義済みの変数は、特に渡す必要がなく、そのままりようされる。"><a href="#Playbook中で定義済みの変数は、特に渡す必要がなく、そのままりようされる。" class="headerlink" title="Playbook中で定義済みの変数は、特に渡す必要がなく、そのままりようされる。"></a>Playbook中で定義済みの変数は、特に渡す必要がなく、そのままりようされる。</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr"> - hosts:</span> <span class="string">lb</span></span><br><span class="line"><span class="attr">   vars:</span></span><br><span class="line"><span class="attr">     port:</span> <span class="number">3206</span></span><br><span class="line"><span class="attr">   remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">   tasks:</span></span><br><span class="line"><span class="attr">     - include:</span> <span class="string">tasks/firewall.yml</span></span><br></pre></td></tr></table></figure>
<h4 id="Includeの落とし穴"><a href="#Includeの落とし穴" class="headerlink" title="Includeの落とし穴"></a>Includeの落とし穴</h4><ul>
<li>handlers内でPlaybook を include する。</li>
</ul>
<p>書き方は以下に示す。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">handlers:</span></span><br><span class="line"><span class="attr">   - include:</span> <span class="string">handlers/handlers.yml</span></span><br></pre></td></tr></table></figure>
<p>ただし、上記の使い方は、有効と書いたドキュメントがあるが、無効と書いたドキュメントもあり、矛盾している。</p>
<p>無効と書いたURL：<a href="http://docs.ansible.com/ansible/playbooks_intro.html" target="_blank" rel="noopener">http://docs.ansible.com/ansible/playbooks_intro.html</a><br>有効と書いたURL：<a href="http://docs.ansible.com/ansible/playbooks_roles.html#task-include-files-and-encouraging-reuse" target="_blank" rel="noopener">http://docs.ansible.com/ansible/playbooks_roles.html#task-include-files-and-encouraging-reuse</a></p>
<p>下記のテストの結果、Ansible 1.9では、includeされたhandlerを呼び出すことができないが、Ansible 2.0以降であれば、includeされたhandlerを呼び出すことができる。そのため、利用しているAnsibleのversionを確認する必要がある。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr"> - hosts:</span> <span class="string">lb</span></span><br><span class="line"><span class="attr">   user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">   gather_facts:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">   vars:</span></span><br><span class="line"><span class="attr">       random_number:</span> <span class="string">"\&#123;\&#123; 10000 | random \&#125;\&#125;"</span></span><br><span class="line"><span class="attr">   tasks:</span></span><br><span class="line"><span class="attr">   - name:</span> <span class="string">Copy</span> <span class="string">the</span> <span class="string">/etc/hosts</span> <span class="string">to</span> <span class="string">/tmp/hosts.\&#123;\&#123;</span> <span class="string">random_number</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="attr">     copy:</span> <span class="string">src=/etc/hosts</span> <span class="string">dest=/tmp/hosts.\&#123;\&#123;</span> <span class="string">random_number</span> <span class="string">\&#125;\&#125;</span></span><br><span class="line"><span class="attr">     notify:</span></span><br><span class="line"><span class="bullet">       -</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="bullet">       -</span> <span class="string">restart</span> <span class="string">apache</span> <span class="string">in</span> <span class="string">handlers</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">   handlers:</span></span><br><span class="line"><span class="attr">     - include:</span> <span class="string">handlers/handlers.yml</span></span><br><span class="line"><span class="attr">     - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">       debug:</span> <span class="string">msg="This</span> <span class="string">is</span> <span class="string">the</span> <span class="string">handler</span> <span class="string">restart</span> <span class="string">apache"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Playbook include</li>
</ul>
<p>推奨されない使い方で、パラメータが利用できないなどの制限がある。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">this</span> <span class="string">is</span> <span class="string">a</span> <span class="string">play</span> <span class="string">at</span> <span class="string">the</span> <span class="string">top</span> <span class="string">level</span> <span class="string">of</span> <span class="string">a</span> <span class="string">file</span></span><br><span class="line"><span class="attr">   hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">   remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">   tasks:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">   - name:</span> <span class="string">say</span> <span class="string">hi</span></span><br><span class="line"><span class="attr">     tags:</span> <span class="string">foo</span></span><br><span class="line"><span class="attr">     shell:</span> <span class="string">echo</span> <span class="string">"hi..."</span></span><br><span class="line"> <span class="comment"># 全体include，またはplaybook include</span></span><br><span class="line"><span class="attr"> - include:</span> <span class="string">load_balancers.yml</span></span><br><span class="line"><span class="attr"> - include:</span> <span class="string">webservers.yml</span></span><br><span class="line"><span class="attr"> - include:</span> <span class="string">dbservers.yml</span></span><br></pre></td></tr></table></figure>
<h3 id="Playbookの”Package”-role"><a href="#Playbookの”Package”-role" class="headerlink" title="Playbookの”Package”(role)"></a>Playbookの”Package”(role)</h3><p>Roleはincludeよりもっと柔軟で強力なコードシェア方法を提供する。includeは他のプログラミング言語の”include”と似たような使い方で、1つのファイルした利用できない。それに対し、roleは”Package”みたいな使い方で、複数のファイルを同時参照によって1つの機能を利用できる。例えば、apacheのインストールと設定をする時、tasksでパッケージのインストール、テンプレートファイルと設定ファイルのコピー、handlerでのサービス再起動など、こちらの処理を1つのroleに纏めることによって、他のPlaybookに参照し利用されることができる。</p>
<p>Ansibleではroleの利用を推奨していて、roleをシェアするためのプラットフォーム Ansible Galaxy <a href="https://galaxy.ansible.com/" target="_blank" rel="noopener">https://galaxy.ansible.com/</a> を提供している。そこでは他の人が書いたroleを参照し利用することができる。</p>
<h4 id="roleのディレクトリ構造"><a href="#roleのディレクトリ構造" class="headerlink" title="roleのディレクトリ構造"></a>roleのディレクトリ構造</h4><p>Ansibleでは、決まったディレクトリ構造でroleを定義する。具体的な例を以下に示す。</p>
<p>この例では、名前がmyroleのroleが定義され、<code>site.yml</code>で参照している。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">site.yml</span></span><br><span class="line"><span class="string">roles/</span></span><br><span class="line"><span class="string">├──</span> <span class="string">myrole</span></span><br><span class="line">    <span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line">    <span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line">    <span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line">    <span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line">    <span class="string">├──</span> <span class="string">defaults</span></span><br><span class="line">    <span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line">    <span class="string">├──</span> <span class="string">vars</span></span><br><span class="line">    <span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line">    <span class="string">├──</span> <span class="string">files</span></span><br><span class="line">    <span class="string">├──</span> <span class="string">templates</span></span><br><span class="line">    <span class="string">├──</span> <span class="string">README.md</span></span><br><span class="line">    <span class="string">├──</span> <span class="string">meta</span></span><br><span class="line">    <span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">tests</span></span><br><span class="line">        <span class="string">├──</span> <span class="string">inventory</span></span><br><span class="line">        <span class="string">└──</span> <span class="string">test.yml</span></span><br></pre></td></tr></table></figure>
<p><code>site.yml</code>でroleを参照</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">myrole</span></span><br></pre></td></tr></table></figure>
<p>roleを作成する時に上記すべてのディレクトリとファイルが必須ではないが、このroleが実現したい機能と仕様によって対応するディレクトリとファイルを作成する。下記は各ファイルの役割をしめす 。</p>
<table>
<thead>
<tr>
<th>ファイル</th>
<th>役割</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>roles/x/tasks/main.yml</code></td>
<td>ファイル内のtasksがPlaybookに追加される。そのため、このファイルはroleの入り口である。このroleの詳細を知りたい場合は、このファイルから参照したほうが良い</td>
</tr>
<tr>
<td><code>roles/x/handlers/main.yml</code></td>
<td>ファイル内のhandlersがPlaybookに追加される。</td>
</tr>
<tr>
<td><code>roles/x/vars/main.yml</code></td>
<td>ファイル内のvariablesがPlaybookに追加される。</td>
</tr>
<tr>
<td><code>roles/x/meta/main.yml</code></td>
<td>ファイル内のロール情報がPlaybookのrolesリストに追加される。</td>
</tr>
</tbody>
</table>
<p><code>roles/x/tasks/main.yml</code> でのすべてのtasksは、<code>roles/x/{files,templates,tasks}</code>のファイルを直接参照でき、ファイルパスを指定する必要がない。自分でroleを書くときに、一般的には <code>roles/x/tasks/main.yml</code> を作成する。他のファイルとディレクトリは、必要によって追加する。</p>
<p>以下では、具体の例を通してroleの書き方と使い方を紹介する。</p>
<h4 id="Roleで変数を使う"><a href="#Roleで変数を使う" class="headerlink" title="Roleで変数を使う"></a>Roleで変数を使う</h4><p>変数付きのmyroleのディレクトリ構造を以下に示す。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">main.yml</span><br><span class="line"> roles</span><br><span class="line">   role_with_var</span><br><span class="line">     tasks</span><br><span class="line">       main.yml</span><br></pre></td></tr></table></figure>
<p>以下の様に、<code>roles/myrole/tasks/main.yml</code> で<code>\{\{ \}\}</code>を使って変数を定義する。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr"> - name:</span> <span class="string">use</span> <span class="string">param</span></span><br><span class="line"><span class="attr">   debug:</span> <span class="string">msg="\&#123;\&#123;</span> <span class="string">param</span> <span class="string">\&#125;\&#125;"</span></span><br></pre></td></tr></table></figure>
<p>それで、main.ymlで以下のようにmyroleを利用することができる</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">myrole,</span> <span class="attr">param:</span> <span class="string">'Call some_role for the 1st time'</span> <span class="string">&#125;</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">myrole,</span> <span class="attr">param:</span> <span class="string">'Call some_role for the 2nd time'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>YAMLの辞書型に書くと</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">myrole</span></span><br><span class="line"><span class="attr">      param:</span> <span class="string">'Call some_role for the 1st time'</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">myrole</span></span><br><span class="line"><span class="attr">      param:</span> <span class="string">'Call some_role for the 2nd time'</span></span><br></pre></td></tr></table></figure>
<h4 id="変数のデフォルト値"><a href="#変数のデフォルト値" class="headerlink" title="変数のデフォルト値"></a>変数のデフォルト値</h4><p>変数のデフォルト値が設定された場合、roleを読み込むときにもし変数に対し新しい値が渡された場合、その新しい値を利用する。もし変数に新しい値を渡していない場合、変数はデフォルト値を利用する。</p>
<p>デフォルト値の設定はとても簡単で、上記のrole_with_varを例にする</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">main.yml</span><br><span class="line">roles:</span><br><span class="line">  myrole</span><br><span class="line">    tasks</span><br><span class="line">      main.yml</span><br><span class="line">    defaults</span><br><span class="line">      main.yml</span><br></pre></td></tr></table></figure>
<p><code>roles/myrole/defaults/main.yml</code>でparamの値を定義する。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">param:</span> <span class="string">"I am the default value"</span></span><br></pre></td></tr></table></figure>
<p>これによって、main.ymlでは以下の二つの方法でroleを読み込むことができる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">role_with_var</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">role_with_var,</span> <span class="attr">param:</span> <span class="string">'I am the value from external'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>他の例については <a href="https://github.com/shijingjing1221/ansible-first-book-examples/blob/master/role_vars.yml" target="_blank" rel="noopener">https://github.com/shijingjing1221/ansible-first-book-examples/blob/master/role_vars.yml</a>を参照する</p>
<h4 id="roleとwhenと一緒に実行"><a href="#roleとwhenと一緒に実行" class="headerlink" title="roleとwhenと一緒に実行"></a>roleとwhenと一緒に実行</h4><p>下記の例では、my_roleはRedHat系のサーバー上しか有効にならない。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">my_role,</span> <span class="attr">when:</span> <span class="string">"ansible_os_family == 'RedHat'"</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>YAML辞書型で書くと以下になる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">my_role</span></span><br><span class="line"><span class="attr">      when:</span> <span class="string">"ansible_os_family == 'RedHat'"</span></span><br></pre></td></tr></table></figure>
<h4 id="roleとtaskの実行順番"><a href="#roleとtaskの実行順番" class="headerlink" title="roleとtaskの実行順番"></a>roleとtaskの実行順番</h4><p>Playbookでは、roleとtasksが同時にある時に、どちらが先に実行になる？答えが以下のようになる。</p>
<p>pre_tasks &gt; role &gt; tasks &gt; post_tasks</p>
<p>例で示すと、以下のPlaybookに対し</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">lb</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  pre_tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">pre</span></span><br><span class="line"><span class="attr">      shell:</span> <span class="string">echo</span> <span class="string">'hello'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">some_role</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">task</span></span><br><span class="line"><span class="attr">      shell:</span> <span class="string">echo</span> <span class="string">'still busy'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  post_tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">post</span></span><br><span class="line"><span class="attr">      shell:</span> <span class="string">echo</span> <span class="string">'goodbye'</span></span><br></pre></td></tr></table></figure>
<p>実際に実行した結果は以下になる。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PLAY [lb] **********************************************************************</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TASK [setup] *******************************************************************</span><br><span class="line">ok: [rhel7u3]</span><br><span class="line"></span><br><span class="line">TASK [pre] *********************************************************************</span><br><span class="line">changed: [rhel7u3]</span><br><span class="line"></span><br><span class="line">TASK [some_role : some role] ***************************************************</span><br><span class="line">ok: [rhel7u3] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"Im some role"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [task] ********************************************************************</span><br><span class="line">changed: [rhel7u3]</span><br><span class="line"></span><br><span class="line">TASK [post] ********************************************************************</span><br><span class="line">changed: [rhel7u3]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">rhel7u3                    : ok=5    changed=3    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>
<h2 id="tagsで一部のtasksを実行"><a href="#tagsで一部のtasksを実行" class="headerlink" title="tagsで一部のtasksを実行"></a>tagsで一部のtasksを実行</h2><p>Playbookの内容が多い時、一部しか実行したくない場合、Playbookのtagsを使って一部のtasksを実行できる。</p>
<h3 id="tagsの基本の使い方"><a href="#tagsの基本の使い方" class="headerlink" title="tagsの基本の使い方"></a>tagsの基本の使い方</h3><p>以下の例では、example.ymlの中にpackagesとconfiguration 二つのtagが書かれている。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - yum:</span> <span class="string">name=\&#123;\&#123;</span> <span class="string">item</span> <span class="string">\&#125;\&#125;</span> <span class="string">state=installed</span></span><br><span class="line"><span class="attr">    with_items:</span></span><br><span class="line"><span class="bullet">       -</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    tags:</span></span><br><span class="line"><span class="bullet">       -</span> <span class="string">packages</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">copy</span> <span class="string">httpd.conf</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=templates/httpd.conf.j2</span> <span class="string">dest=/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="attr">    tags:</span></span><br><span class="line"><span class="bullet">       -</span> <span class="string">configuration</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">copy</span> <span class="string">index.html</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=templates/index.html.j2</span> <span class="string">dest=/var/www/html/index.html</span></span><br><span class="line"><span class="attr">    tags:</span></span><br><span class="line"><span class="bullet">       -</span> <span class="string">configuration</span></span><br></pre></td></tr></table></figure>
<p>tag変数を付けずに実行すると、すべてのtasksが実行される。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook example.yml</span><br></pre></td></tr></table></figure>
<p>パッケージのインストールのみ実行したい時に、tagsでpackagesを指定してPlaybook を実行する。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook example.yml --tags <span class="string">"packages"</span></span><br></pre></td></tr></table></figure>
<p>configurationの部分を実行しない場合、skip-tagsでconfigurationを指定してPlaybook を実行する。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook example.yml --skip-tags <span class="string">"configuration"</span></span><br></pre></td></tr></table></figure>
<h3 id="特殊の意味を持つtags"><a href="#特殊の意味を持つtags" class="headerlink" title="特殊の意味を持つtags"></a>特殊の意味を持つtags</h3><ul>
<li>always</li>
</ul>
<p>タグの名前がユーザで決めるが、alwaysに設定するとタグの意味が特殊になる。Playbookを実行するときに、alwaysタグを実行しないことを明示的に示さないと、このタグは実行される。</p>
<p>下記の例では、</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">   - debug:</span> <span class="string">msg="Always</span> <span class="string">print</span> <span class="string">this</span> <span class="string">debug</span> <span class="string">message"</span></span><br><span class="line"><span class="attr">     tags:</span></span><br><span class="line"><span class="bullet">       -</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="attr">   - yum:</span> <span class="string">name=\&#123;\&#123;</span> <span class="string">item</span> <span class="string">\&#125;\&#125;</span> <span class="string">state=installed</span></span><br><span class="line"><span class="attr">     with_items:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">     tags:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">packages</span></span><br><span class="line"></span><br><span class="line"><span class="attr">   - template:</span> <span class="string">src=templates/httpd.conf.j2</span> <span class="string">dest=/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="attr">     tags:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">configuration</span></span><br></pre></td></tr></table></figure>
<p>packagesタグのみ実行しても、alwaysタグのtaskも実行される。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook tags_always.yml --tags <span class="string">"packages"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>tagged, untagged, all</li>
</ul>
<p>以下のPlaybookに対し</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">   - debug:</span> <span class="string">msg="I</span> <span class="string">am</span> <span class="string">not</span> <span class="string">tagged"</span></span><br><span class="line"><span class="attr">     tags:</span></span><br><span class="line"><span class="bullet">       -</span> <span class="string">tag1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">   - debug:</span> <span class="string">msg="I</span> <span class="string">am</span> <span class="string">not</span> <span class="string">tagged"</span></span><br></pre></td></tr></table></figure>
<p>それぞれのコマンドにtagged, untagged, allを指定して実行してみましょう</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook tags_tagged_untagged_all.yml --tags tagged</span><br><span class="line">ansible-playbook tags_tagged_untagged_all.yml --tags untagged</span><br><span class="line">ansible-playbook tags_tagged_untagged_all.yml --tags all</span><br></pre></td></tr></table></figure>
<h3 id="includeとroleでtagsを利用"><a href="#includeとroleでtagsを利用" class="headerlink" title="includeとroleでtagsを利用"></a>includeとroleでtagsを利用</h3><p>下記のようにincludeの中にtagsを設定することができる。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- include:</span> <span class="string">foo.yml</span></span><br><span class="line"><span class="attr">  tags:</span> <span class="string">[web,foo]</span></span><br></pre></td></tr></table></figure>
<p>rolesの中のタグを参照したい場合は、以下の例で示す。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">roles:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">webserver,</span> <span class="attr">port:</span> <span class="number">5000</span><span class="string">,</span> <span class="attr">tags:</span> <span class="string">[</span> <span class="string">'web'</span><span class="string">,</span> <span class="string">'foo'</span> <span class="string">]</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="Ansible-の拡張モジュール-Extra-Modules"><a href="#Ansible-の拡張モジュール-Extra-Modules" class="headerlink" title="Ansible の拡張モジュール (Extra Modules)"></a>Ansible の拡張モジュール (Extra Modules)</h1><p>Ansibleのモジュールドキュメント(<a href="http://docs.ansible.com/ansible/latest/modules/modules_by_category.html" target="_blank" rel="noopener">http://docs.ansible.com/ansible/latest/modules/modules_by_category.html</a>)を参照する時に、各ページの一番下に、このモジュールは”Core module”または”Extra Module”であることを示している。例えば、yumはcore moduleが、yum_repositoryはextra moduleである。</p>
<ul>
<li>Core Module<ul>
<li>特に設定やインストールする必要がなく、Ansibleをインストール後に使える。</li>
<li>よく使われているmodule</li>
<li>テスト済み</li>
</ul>
</li>
<li>Extra Module<ul>
<li>設定やインストールをしてから利用する。</li>
<li>比較的に使用頻度が低い</li>
<li>bugが存在している可能性がある。</li>
</ul>
</li>
</ul>
<h2 id="Extra-Moduleの使い方"><a href="#Extra-Moduleの使い方" class="headerlink" title="Extra Moduleの使い方"></a>Extra Moduleの使い方</h2><p>以下の手順でExtra moduleをのインストールと設定を行うと、コマンドラインとPlaybookで利用できる。Extra Module は Core Module と同じ使い方で利用できる。<br>注意：Extra moduleがテストされ問題ない場合はCore Moduleに移動される。</p>
<h3 id="Ansible-module-extraをダウンロード"><a href="#Ansible-module-extraをダウンロード" class="headerlink" title="Ansible module extraをダウンロード"></a>Ansible module extraをダウンロード</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/ansible/ansible-modules-extras.git</span><br></pre></td></tr></table></figure>
<p>例として、ダウンロード先は/home/jshi/software/になっている。このパスは後で利用する。</p>
<h3 id="extraモジュールが使えるように設定内容を修正"><a href="#extraモジュールが使えるように設定内容を修正" class="headerlink" title="extraモジュールが使えるように設定内容を修正"></a>extraモジュールが使えるように設定内容を修正</h3><ul>
<li>方法1：デフォルトのAnsible設定ファイルを変更</li>
</ul>
<p><code>/etc/ansible/ansible.cfg</code>を編集し、下記 1 行を追加</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">library</span>    <span class="string">=</span> <span class="string">/home/jshi/software/ansible-modules-extras/</span></span><br></pre></td></tr></table></figure>
<ul>
<li>方法2：カレントディレクトリの下にあるansible.cfgを変更</li>
</ul>
<p>この方法は、同じくカレントディレクトリにあるplaybookのみに有効になる。他の親ディレクトリや子ディレクトリのPlaybookには無効になる。</p>
<p>下記のディレクトリ構造に対し、ansible.cfgを変更した後、use_extra_module.ymlのみextra moduleが利用できる。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">library/ansible-modules-extras</span><br><span class="line">ansible.cfg</span><br><span class="line">use_extra_module.yml</span><br><span class="line">subfolder/use_extra_module_will_throw_error.yml</span><br></pre></td></tr></table></figure>
<p>カレントディレクトリにあるため、設定内容は相対パスでも大丈夫。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">library = library/ansible-modules-extras/</span><br></pre></td></tr></table></figure>
<ul>
<li>方法3：環境変数を修正する</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ANSIBLE_LIBRARY=/project/demo/demoansible/library/ansible-module-extras</span><br></pre></td></tr></table></figure>
<p>もし再起動後も有効にしたい場合、~/.bashrcでANSIBLE_LIBRARY環境変数を設定する。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> &gt;&gt;~/.bashrc &lt;&lt;EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ANSIBLE_LIBRARY=/project/demo/demoansible/library/ansible-module-extras</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>
<h2 id="コマンドラインでモジュールの使い方を参照"><a href="#コマンドラインでモジュールの使い方を参照" class="headerlink" title="コマンドラインでモジュールの使い方を参照"></a>コマンドラインでモジュールの使い方を参照</h2><p>Bashのman命令みたいに、ansibleはコマンドラインでmoduleの使い方が参照できる。コマンド名は ansible-doc である。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc module_name</span><br></pre></td></tr></table></figure>
<p>Core Moduleに対しはどこで実行しても問題がない、例えばyumのを参照したい場合</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc yum</span><br></pre></td></tr></table></figure>
<p>Extra Moduleに対しては、extra moduleの利用を設定したディレクトリの下でコマンドを実行する。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc yum_repository</span><br></pre></td></tr></table></figure>
<h2 id="より良いPlaybookの書き方"><a href="#より良いPlaybookの書き方" class="headerlink" title="より良いPlaybookの書き方"></a>より良いPlaybookの書き方</h2><ul>
<li>Includeとroleを使って、重複がないコードを書く</li>
<li>大きいファイルを小さいファイルに分割して書く</li>
</ul>
<p><a href="https://github.com/ansible/ansible-examples" target="_blank" rel="noopener">https://github.com/ansible/ansible-examples</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">production                <span class="comment"># inventory file for production servers</span></span><br><span class="line">staging                   <span class="comment"># inventory file for staging environment</span></span><br><span class="line"></span><br><span class="line">group_vars/</span><br><span class="line">   group1                 <span class="comment"># here we assign variables to particular groups</span></span><br><span class="line">   group2                 <span class="comment"># ""</span></span><br><span class="line">host_vars/</span><br><span class="line">   hostname1              <span class="comment"># if systems need specific variables, put them here</span></span><br><span class="line">   hostname2              <span class="comment"># ""</span></span><br><span class="line"></span><br><span class="line">library/                  <span class="comment"># if any custom modules, put them here (optional)</span></span><br><span class="line">filter_plugins/           <span class="comment"># if any custom filter plugins, put them here (optional)</span></span><br><span class="line"></span><br><span class="line">site.yml                  <span class="comment"># master playbook</span></span><br><span class="line">webservers.yml            <span class="comment"># playbook for webserver tier</span></span><br><span class="line">dbservers.yml             <span class="comment"># playbook for dbserver tier</span></span><br><span class="line"></span><br><span class="line">roles/</span><br><span class="line">    common/               <span class="comment"># this hierarchy represents a "role"</span></span><br><span class="line">        tasks/            <span class="comment">#</span></span><br><span class="line">            main.yml      <span class="comment">#  &lt;-- tasks file can include smaller files if warranted</span></span><br><span class="line">        handlers/         <span class="comment">#</span></span><br><span class="line">            main.yml      <span class="comment">#  &lt;-- handlers file</span></span><br><span class="line">        templates/        <span class="comment">#  &lt;-- files for use with the template resource</span></span><br><span class="line">            ntp.conf.j2   <span class="comment">#  &lt;------- templates end in .j2</span></span><br><span class="line">        files/            <span class="comment">#</span></span><br><span class="line">            bar.txt       <span class="comment">#  &lt;-- files for use with the copy resource</span></span><br><span class="line">            foo.sh        <span class="comment">#  &lt;-- script files for use with the script resource</span></span><br><span class="line">        vars/             <span class="comment">#</span></span><br><span class="line">            main.yml      <span class="comment">#  &lt;-- variables associated with this role</span></span><br><span class="line">        defaults/         <span class="comment">#</span></span><br><span class="line">            main.yml      <span class="comment">#  &lt;-- default lower priority variables for this role</span></span><br><span class="line">        meta/             <span class="comment">#</span></span><br><span class="line">            main.yml      <span class="comment">#  &lt;-- role dependencies</span></span><br><span class="line"></span><br><span class="line">    webtier/              <span class="comment"># same kind of structure as "common" was above, done for the webtier role</span></span><br><span class="line">    monitoring/           <span class="comment"># ""</span></span><br><span class="line">    fooapp/               <span class="comment"># ""</span></span><br></pre></td></tr></table></figure>
<h2 id="参考資料"><a href="#参考資料" class="headerlink" title="参考資料"></a>参考資料</h2><p>Ansibleのビデオセッション(英文) <a href="https://sysadmincasts.com/episodes/43-19-minutes-with-ansible-part-1-4" target="_blank" rel="noopener">https://sysadmincasts.com/episodes/43-19-minutes-with-ansible-part-1-4</a></p>
<p>本資料にあるすべての例</p>
<p><a href="https://github.com/shijingjing1221/ansible-first-book-examples/" target="_blank" rel="noopener">https://github.com/shijingjing1221/ansible-first-book-examples/</a></p>
<p>YAMLの基本文法と紹介</p>
<p><a href="https://en.wikipedia.org/wiki/YAML" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/YAML</a></p>
<p><a href="http://www.yamllint.com/" target="_blank" rel="noopener">http://www.yamllint.com/</a></p>
<p>Ansible Tower紹介</p>
<p><a href="https://www.ansible.com/tower" target="_blank" rel="noopener">https://www.ansible.com/tower</a></p>
<h1 id="CopyRight"><a href="#CopyRight" class="headerlink" title="CopyRight"></a>CopyRight</h1><p>此书电子版免费供大家下载阅读，如果您已为此副本付费，请立即申请退款并联系作者举报此行为。请注意，虽然此书电子版免费供大家阅读，但这并不代表作者放弃了版权，您在未经授权的情况下依然不得以任何方式复制或抄袭本书内容。此书的电子版目前仅授权图灵社区和gitbook.com两个平台发布，如果您通过其他渠道获取到了此副本，则是侵权行为，请到上述两个平台下载合法授权的副本。获取合法授权副本的好处是可以及时得到此书的最新版本，早期版本中的错误会被及时纠正。感谢您对版权保护工作所做出的贡献。</p>
<p>作者邮箱:<a href="mailto:shijingjing02@163.com" target="_blank" rel="noopener">shijingjing02@163.com</a></p>
<p>作者Github: <a href="https://github.com/shijingjing1221/" target="_blank" rel="noopener">https://github.com/shijingjing1221/</a></p>
<h1 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h1><p><a href="https://www.youtube.com/watch?v=vOa4_1fgNPU" target="_blank" rel="noopener">https://www.youtube.com/watch?v=vOa4_1fgNPU</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Linux/" rel="tag"># Linux</a>
          
            <a href="/tags/Ansible/" rel="tag"># Ansible</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/09/Getting-started-with-Ansible-JP-intro/" rel="next" title="Ansible 入門 - 紹介">
                <i class="fa fa-chevron-left"></i> Ansible 入門 - 紹介
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/04/09/Getting-started-with-Ansible-JP-basic/" rel="prev" title="Ansible 入門 - 基本操作(チュートリアル)">
                Ansible 入門 - 基本操作(チュートリアル) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/me.jpg"
               alt="Wenhan Shi" />
          <p class="site-author-name" itemprop="name">Wenhan Shi</p>
           
              <p class="site-description motion-element" itemprop="description">Ubuntu/RHEL Docker/k8s/OpenShift/GlusterFS</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">41</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/xibuka" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/wenhan-shi-0883a9132/" target="_blank" title="Linkedin">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Linkedin
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/Shibunkan/" target="_blank" title="豆瓣">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  豆瓣
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/xibuka" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Ansible設定ファイル"><span class="nav-number">1.</span> <span class="nav-text">Ansible設定ファイル</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#設定内容"><span class="nav-number">1.1.</span> <span class="nav-text">設定内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#優先順位"><span class="nav-number">1.2.</span> <span class="nav-text">優先順位</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Host-Inventory-サーバーリスト"><span class="nav-number">2.</span> <span class="nav-text">Host Inventory(サーバーリスト)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ファイルパス"><span class="nav-number">2.1.</span> <span class="nav-text">ファイルパス</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#デフォルトのファイルパス"><span class="nav-number">2.1.1.</span> <span class="nav-text">デフォルトのファイルパス</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ファイルパスの変更"><span class="nav-number">2.1.2.</span> <span class="nav-text">ファイルパスの変更</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#コマンドライン上で指定"><span class="nav-number">2.1.3.</span> <span class="nav-text">コマンドライン上で指定</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#サーバーのカテゴリ化"><span class="nav-number">2.2.</span> <span class="nav-text">サーバーのカテゴリ化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#接続パラメータと変数"><span class="nav-number">2.3.</span> <span class="nav-text">接続パラメータと変数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#パラメータ"><span class="nav-number">2.3.1.</span> <span class="nav-text">パラメータ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#変数"><span class="nav-number">2.3.2.</span> <span class="nav-text">変数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ディレクトリ構造での変数保存"><span class="nav-number">2.4.</span> <span class="nav-text">ディレクトリ構造での変数保存</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ansibleのスクリプト-Playbook"><span class="nav-number">3.</span> <span class="nav-text">Ansibleのスクリプト(Playbook)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#フォーマット"><span class="nav-number">3.1.</span> <span class="nav-text">フォーマット</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#オフィシャルの例"><span class="nav-number">3.1.1.</span> <span class="nav-text">オフィシャルの例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#他のユーザがシェアしたPlaybook"><span class="nav-number">3.1.2.</span> <span class="nav-text">他のユーザがシェアしたPlaybook</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Playbookの基本"><span class="nav-number">3.2.</span> <span class="nav-text">Playbookの基本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbookの実行"><span class="nav-number">3.2.1.</span> <span class="nav-text">Playbookの実行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#簡単なPlaybookの例"><span class="nav-number">3.2.2.</span> <span class="nav-text">簡単なPlaybookの例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#対象サーバと実行ユーザ（hostsとuser）"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">対象サーバと実行ユーザ（hostsとuser）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#実行するタスク-Tasks"><span class="nav-number">3.2.3.</span> <span class="nav-text">実行するタスク(Tasks)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#構文"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">構文</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#変数の渡し方"><span class="nav-number">3.2.3.2.</span> <span class="nav-text">変数の渡し方</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#実行状態"><span class="nav-number">3.2.3.3.</span> <span class="nav-text">実行状態</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#イベントハンドラ-handler"><span class="nav-number">3.2.4.</span> <span class="nav-text">イベントハンドラ(handler)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#定義"><span class="nav-number">3.2.4.1.</span> <span class="nav-text">定義</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#役割"><span class="nav-number">3.2.4.2.</span> <span class="nav-text">役割</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Playbookで利用可能な変数"><span class="nav-number">3.3.</span> <span class="nav-text">Playbookで利用可能な変数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbook中で定義した変数"><span class="nav-number">3.3.1.</span> <span class="nav-text">Playbook中で定義した変数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#変数を単独ファイルに置く"><span class="nav-number">3.3.1.1.</span> <span class="nav-text">変数を単独ファイルに置く</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#複雑変数の扱い方"><span class="nav-number">3.3.1.2.</span> <span class="nav-text">複雑変数の扱い方</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#YAMLの落とし穴"><span class="nav-number">3.3.1.3.</span> <span class="nav-text">YAMLの落とし穴</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#システム変数-facts"><span class="nav-number">3.3.2.</span> <span class="nav-text">システム変数(facts)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#複雑なfacts変数"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">複雑なfacts変数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#factsの無効化"><span class="nav-number">3.3.2.2.</span> <span class="nav-text">factsの無効化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#テンプレートで定義した変数"><span class="nav-number">3.3.3.</span> <span class="nav-text">テンプレートで定義した変数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#変数の定義"><span class="nav-number">3.3.3.1.</span> <span class="nav-text">変数の定義</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#変数の利用"><span class="nav-number">3.3.3.2.</span> <span class="nav-text">変数の利用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#タスクの実行結果を変数に設定"><span class="nav-number">3.3.4.</span> <span class="nav-text">タスクの実行結果を変数に設定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#コマンドラインで変数を渡す"><span class="nav-number">3.3.5.</span> <span class="nav-text">コマンドラインで変数を渡す</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#コマンドライン変数の定義"><span class="nav-number">3.3.5.1.</span> <span class="nav-text">コマンドライン変数の定義</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#コマンドライン変数の利用"><span class="nav-number">3.3.5.2.</span> <span class="nav-text">コマンドライン変数の利用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#条件判断、ループとブロック"><span class="nav-number">3.4.</span> <span class="nav-text">条件判断、ループとブロック</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#条件判断-when"><span class="nav-number">3.4.1.</span> <span class="nav-text">条件判断(when)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#条件式"><span class="nav-number">3.4.1.1.</span> <span class="nav-text">条件式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#循環処理-loop"><span class="nav-number">3.4.2.</span> <span class="nav-text">循環処理(loop)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#標準のループ-with-items"><span class="nav-number">3.4.2.1.</span> <span class="nav-text">標準のループ(with_items)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ネストループ-with-nested"><span class="nav-number">3.4.2.2.</span> <span class="nav-text">ネストループ(with_nested)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ハッシュループ-with-dict"><span class="nav-number">3.4.2.3.</span> <span class="nav-text">ハッシュループ(with_dict)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ファイルリストループ-with-fileglob"><span class="nav-number">3.4.2.4.</span> <span class="nav-text">ファイルリストループ(with_fileglob)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ブロック-block"><span class="nav-number">3.4.3.</span> <span class="nav-text">ブロック(block)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#既存Playbook-の読み込む"><span class="nav-number">3.5.</span> <span class="nav-text">既存Playbook の読み込む</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbookファイルの-include"><span class="nav-number">3.5.1.</span> <span class="nav-text">Playbookファイルの include</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基本の使い方"><span class="nav-number">3.5.1.1.</span> <span class="nav-text">基本の使い方</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#高度な使い方"><span class="nav-number">3.5.1.2.</span> <span class="nav-text">高度な使い方</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#includeされるPlaybookの後ろに、変数名と値を指定"><span class="nav-number">3.5.1.3.</span> <span class="nav-text">includeされるPlaybookの後ろに、変数名と値を指定</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#YAMLのハッシュ形式で変数と値を渡す"><span class="nav-number">3.5.1.4.</span> <span class="nav-text">YAMLのハッシュ形式で変数と値を渡す</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#taskをJSON形式に書いて、変数と値を設定する"><span class="nav-number">3.5.1.5.</span> <span class="nav-text">taskをJSON形式に書いて、変数と値を設定する</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Playbook中で定義済みの変数は、特に渡す必要がなく、そのままりようされる。"><span class="nav-number">3.5.1.6.</span> <span class="nav-text">Playbook中で定義済みの変数は、特に渡す必要がなく、そのままりようされる。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Includeの落とし穴"><span class="nav-number">3.5.1.7.</span> <span class="nav-text">Includeの落とし穴</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbookの”Package”-role"><span class="nav-number">3.5.2.</span> <span class="nav-text">Playbookの”Package”(role)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#roleのディレクトリ構造"><span class="nav-number">3.5.2.1.</span> <span class="nav-text">roleのディレクトリ構造</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Roleで変数を使う"><span class="nav-number">3.5.2.2.</span> <span class="nav-text">Roleで変数を使う</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#変数のデフォルト値"><span class="nav-number">3.5.2.3.</span> <span class="nav-text">変数のデフォルト値</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#roleとwhenと一緒に実行"><span class="nav-number">3.5.2.4.</span> <span class="nav-text">roleとwhenと一緒に実行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#roleとtaskの実行順番"><span class="nav-number">3.5.2.5.</span> <span class="nav-text">roleとtaskの実行順番</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tagsで一部のtasksを実行"><span class="nav-number">3.6.</span> <span class="nav-text">tagsで一部のtasksを実行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#tagsの基本の使い方"><span class="nav-number">3.6.1.</span> <span class="nav-text">tagsの基本の使い方</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#特殊の意味を持つtags"><span class="nav-number">3.6.2.</span> <span class="nav-text">特殊の意味を持つtags</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#includeとroleでtagsを利用"><span class="nav-number">3.6.3.</span> <span class="nav-text">includeとroleでtagsを利用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ansible-の拡張モジュール-Extra-Modules"><span class="nav-number">4.</span> <span class="nav-text">Ansible の拡張モジュール (Extra Modules)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Extra-Moduleの使い方"><span class="nav-number">4.1.</span> <span class="nav-text">Extra Moduleの使い方</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Ansible-module-extraをダウンロード"><span class="nav-number">4.1.1.</span> <span class="nav-text">Ansible module extraをダウンロード</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#extraモジュールが使えるように設定内容を修正"><span class="nav-number">4.1.2.</span> <span class="nav-text">extraモジュールが使えるように設定内容を修正</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#コマンドラインでモジュールの使い方を参照"><span class="nav-number">4.2.</span> <span class="nav-text">コマンドラインでモジュールの使い方を参照</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#より良いPlaybookの書き方"><span class="nav-number">4.3.</span> <span class="nav-text">より良いPlaybookの書き方</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考資料"><span class="nav-number">4.4.</span> <span class="nav-text">参考資料</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CopyRight"><span class="nav-number">5.</span> <span class="nav-text">CopyRight</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Demo"><span class="nav-number">6.</span> <span class="nav-text">Demo</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>

  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <!-- ad start -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 自适应单元 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2422626403812806"
     data-ad-slot="1454707894"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- ad end -->

<div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wenhan Shi</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  








  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  

    
      <script id="dsq-count-scr" src="https://xibuka.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://wenhan.blog/2018/04/09/Getting-started-with-Ansible-JP-adv/';
          this.page.identifier = '2018/04/09/Getting-started-with-Ansible-JP-adv/';
          this.page.title = 'Ansible 入門 - 応用';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://xibuka.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  













  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("90wEGXD7uoUqTufkP5rUni2y-gzGzoHsz", "4vhv6NPtEfNUWFOd4v5ktPSk");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

</body>
</html>
